Imports System
Imports System.Web
Imports System.Collections.Generic
Imports System.Linq
Imports AttributeRouting.Web.Http
Imports System.Data.SqlClient
Imports System.Web.Script.Serialization
Imports log4net
Imports System.Net
Imports Newtonsoft.Json
Imports System.Text
Imports System.Threading
Imports System.IO
Imports Microsoft.AspNetCore.Mvc

Namespace CalcmenuAPI
    Public Class WorkflowController
        Inherits ControllerBase

        Private m_Attachments As Models.WorkflowAttachment, m_TempAttachments As String, m_intCodeListe As Integer, m_codeWorkflow As Integer, m_RecipeName As String

        Private Shared ReadOnly Log As ILog = LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType)

#Region "Display & Search of Recipe Workflow"
        <HttpPost> <[POST]("/api/workflow/search")> _
        Public Function GetWorkflowByName(data As Models.ConfigurationcSearch) As List(Of Models.Workflow)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_MANAGE_Generic]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite
                                .Parameters.Add("@Type", SqlDbType.Int).Value = 1
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = 1
                                .Parameters.Add("@Status", SqlDbType.Int).Value = 1
                                .Parameters.Add("@TableName", SqlDbType.NVarChar, 200).Value = "EgswWorkflow"
                                .Parameters.Add("@CodeProperty", SqlDbType.Int).Value = data.CodeProperty
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim workflow As New List(Of Models.Workflow)
                For Each r In ds.Tables(0).Rows
                    workflow.Add(New Models.Workflow With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name")), _
                                    .Archive = GetBool(r("Archive"))
                                })
                Next

                If data.Name.Trim <> "" Then

                    Dim workflowresult As New List(Of Models.Workflow)

                    Dim arrNames() As String = data.Name.Trim.Split(",")
                    For Each word In arrNames
                        If word.Trim.ToString <> "" Then    'RDTC 2015.08.10; added this otherwise the rows are getting duplicated

                            For Each s In workflow
                                If s.Name.ToLower.Contains(Common.ReplaceSpecialCharacters(word.Trim.ToLower)) Then
                                    workflowresult.Add(s)
                                End If
                            Next
                        End If
                    Next
                    workflow = workflowresult

                End If

                Return workflow.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

#End Region

#Region "Insert & Update Recipe Workkflow"

        <HttpPost> <POST("api/workflow")> _
        Public Function SaveWorkflow(data As Models.WorkflowData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer
            Dim _trans As SqlTransaction = Nothing
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Dim arrWorkflowCodes As New ArrayList
                For Each d In data.CodeList
                    If arrWorkflowCodes.IndexOf(d.Code) = -1 Then arrWorkflowCodes.Add(d.Code)
                Next
                Dim _codeWorkflowList As String = Common.Join(arrWorkflowCodes, "", "", ",")


                Using cmd As New SqlCommand
                    Dim tran As Integer
                    If data.Info.Code = -1 Then
                        tran = 1
                    ElseIf data.Info.Code = -2 Then
                        tran = 1
                    Else
                        tran = 2
                    End If
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "MANAGE_WORKFLOWUPDATE"
                                .Parameters.Clear()
                                .Parameters.Add("@Code", SqlDbType.Int).Value = data.Info.Code
                                .Parameters.Add("@Name", SqlDbType.NVarChar).Value = data.Info.Name
                                .Parameters.Add("@Taskname", SqlDbType.NVarChar).Value = data.Info.TaskName
                                .Parameters.Add("@Codeuser", SqlDbType.Int).Value = data.Info.User
                                .Parameters.Add("@isArchive", SqlDbType.Bit).Value = data.Info.Archive
                                .Parameters.Add("@retval", SqlDbType.Int)
                                .Parameters("@retval").Direction = ParameterDirection.ReturnValue
                                cn.Open()

                                _trans = cn.BeginTransaction
                                .Transaction = _trans
                                .CommandTimeout = 120
                                .ExecuteNonQuery()

                                Dim codeWorkflow As Integer = GetInt(.Parameters("@Code").Value, -1)
                                resultCode = GetInt(.Parameters("@retval").Value, -1)

                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Save Workflow failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = codeWorkflow
                                response.Status = True
                                _trans.Commit()
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                Try
                                    _trans.Rollback()
                                    If Not _trans Is Nothing Then
                                        CType(_trans, IDisposable).Dispose()
                                    End If
                                Catch
                                End Try
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Save Workflow failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using

                        'FOR SEQUENCE
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "MANAGE_WorkflowSequence"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeTask", SqlDbType.VarChar, 4000).Value = _codeWorkflowList
                                .Parameters.Add("@Code", SqlDbType.Int).Value = data.Info.Code                  'codeworkflow
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1)

                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Sequence failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Message = "Workflow sequence failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
                            Catch exc As Exception

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
            End Try
            Return response
        End Function

#End Region

#Region "Display workflow item"
        <HttpGet> <[GET]("/api/workflow/getrecipeworkflow/{code:int?}")> _
        Public Function GetWorkflow(Optional ByVal code As Integer = 0) As List(Of Models.Workflow)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Workflow]"
                                .Parameters.Add("@Code", SqlDbType.Int).Value = code
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                'Dim isArchive As Boolean
                'Dim isActual As Boolean
                'Dim archive As Integer


                Dim recipeworkflow As New List(Of Models.Workflow)
                For Each r In ds.Tables(0).Rows


                    'If isArchive = True Then
                    '    archive = 2
                    'ElseIf isActual = True Then
                    '    archive = 1
                    'Else
                    '    archive = 0
                    'End If
                    recipeworkflow.Add(New Models.Workflow With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name")), _
                                    .Archive = GetBool(r("Archive"))
                                })
                Next

                Return recipeworkflow.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
#End Region

#Region "Delete Recipe Workflow"
        <HttpPost> <POST("api/workflow/delete")> _
        Public Function DeleteWorkflow(data As Models.GenericDeleteData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Dim arrWorkflowCodes As New ArrayList
                For Each c In data.CodeList
                    If arrWorkflowCodes.IndexOf(c.Code) = -1 Then arrWorkflowCodes.Add(c.Code)
                Next
                Dim _codeWorkflowList As String = Common.Join(arrWorkflowCodes, "", "", ",")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_DELETE_Generic"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = _codeWorkflowList
                                .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWWORKFLOW"
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.CodeUser                    ''codeuser
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite                    ''codesite                                                        
                                .Parameters.Add("@ForceDelete", SqlDbType.Bit).Value = data.ForceDelete              ''force delete
                                .Parameters.Add("@SkipList", SqlDbType.NVarChar, 4000).Direction = ParameterDirection.Output
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1) ' RBAJ-2014.01.14                               
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Delete sales site failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Message = "Delete workflow failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
                            Catch exc As Exception

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Workflow")
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Workflow")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
            End Try
            Return response

        End Function
#End Region

#Region "Populate the combobox"
        <HttpGet> <[GET]("/api/workflow/getworkflowuser/{codesite:int}")> _
        Public Function GetUserWorkflow(CodeSite As Integer) As List(Of Models.GenericList)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Users]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = CodeSite
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using


                Dim UserAccounts As New List(Of Models.GenericList)
                For Each r In ds.Tables(0).Rows


                    UserAccounts.Add(New Models.GenericList With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name"))
                                })
                Next

                Return UserAccounts
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
#End Region

        '===== Workflow Task =====
#Region "Insert & Update Recipe Task Workflow"

        <HttpPost> <POST("api/workflow/saveworkflowtask")> _
        Public Function SaveWorkflowTask(data As Models.WorkflowData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer
            Dim _trans As SqlTransaction = Nothing
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Using cmd As New SqlCommand
                    Dim tran As Integer
                    If data.Info.Code = -1 Then
                        tran = 1
                    ElseIf data.Info.Code = -2 Then
                        tran = 1
                    Else
                        tran = 2
                    End If
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "MANAGE_WORKFLOWTASKUPDATE"
                                .Parameters.Clear()
                                .Parameters.Add("@Code", SqlDbType.Int).Value = data.Info.Code
                                .Parameters.Add("@CodeTaskWorkflow", SqlDbType.Int).Value = data.Info.CodeTaskWorkflow
                                .Parameters.Add("@Name", SqlDbType.NVarChar).Value = data.Info.TaskName
                                .Parameters.Add("@WorkFlowName", SqlDbType.NVarChar).Value = data.Info.WorkflowName
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.Info.User
                                .Parameters.Add("@Duration", SqlDbType.Decimal).Value = data.Info.Duration
                                .Parameters.Add("@CodeTask", SqlDbType.Int).Value = data.Info.CodeTask
                                .Parameters.Add("@isArchive", SqlDbType.Bit).Value = data.Info.Archive
                                .Parameters.Add("@retval", SqlDbType.Int)
                                .Parameters("@retval").Direction = ParameterDirection.ReturnValue
                                cn.Open()

                                _trans = cn.BeginTransaction
                                .Transaction = _trans
                                .CommandTimeout = 120
                                .ExecuteNonQuery()

                                Dim codeTaskWorkflow As Integer = GetInt(.Parameters("@Code").Value, -1)
                                Dim codeTask As Integer = GetInt(.Parameters("@CodeTask").Value, -1)
                                resultCode = GetInt(.Parameters("@retval").Value, -1)

                                If resultCode < 0 Then
                                    response.Code = codeTask
                                    response.Message = "OK"
                                    response.ReturnValue = resultCode
                                    response.Status = True
                                    _trans.Commit()
                                    'Throw New DatabaseException(String.Format("[{0}] save workflow failed", resultCode))
                                Else
                                    response.Code = codeTask
                                    response.Message = "OK"
                                    response.ReturnValue = resultCode
                                    response.Status = True
                                    _trans.Commit()
                                End If

                                ' Done without errors

                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                Try
                                    _trans.Rollback()
                                    If Not _trans Is Nothing Then
                                        CType(_trans, IDisposable).Dispose()
                                    End If
                                Catch
                                End Try
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Save Workflow failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
            End Try
            Return response
        End Function

#End Region

#Region "Display the Workflow Task"
        <HttpGet> <[GET]("/api/workflowtask/search/{code:int}")> _
        Public Function GetWorkflowTaskByName(code As Integer) As List(Of Models.Workflow)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_MANAGE_Workflow]"
                                .Parameters.Add("@Code", SqlDbType.Int).Value = code
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim workflowtask As New List(Of Models.Workflow)
                For Each r In ds.Tables(0).Rows
                    workflowtask.Add(New Models.Workflow With {
                                    .Code = GetInt(r("CodeWorkflow")),
                                    .CodeTaskWorkflow = GetInt(r("CodeTask")),
                                    .TaskName = GetStr(r("Name")),
                                    .User = GetStr(r("Fullname")),
                                    .Duration = GetDbl(r("Duration"))
                                })
                Next

                Return workflowtask.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
#End Region

#Region "Display Workflow Task Information item"
        <HttpGet> <[GET]("/api/workflow/getrecipeworkflowtask/{code:int}/{codetask:int}")> _
        Public Function GetWorkflowTask(code As Integer, codetask As Integer) As List(Of Models.Workflow)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_WorkflowTask]"
                                .Parameters.Add("@Code", SqlDbType.Int).Value = code
                                .Parameters.Add("@CodeTask", SqlDbType.Int).Value = codetask
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                'Dim isArchive As Boolean
                'Dim isActual As Boolean
                'Dim archive As Integer


                Dim recipeworkflowTask As New List(Of Models.Workflow)
                For Each r In ds.Tables(0).Rows


                    'If isArchive = True Then
                    '    archive = 2
                    'ElseIf isActual = True Then
                    '    archive = 1
                    'Else
                    '    archive = 0
                    'End If
                    recipeworkflowTask.Add(New Models.Workflow With {
                                    .Code = GetInt(r("CodeWorkflow")), _
                                    .Name = GetStr(r("Name")), _
                                    .Duration = GetStr(r("Duration")), _
                                    .TaskName = GetStr(r("TaskName")), _
                                    .CodeTaskWorkflow = GetInt(r("CodeTask")), _
                                    .User = GetInt(r("CodeUser"))
                                })
                Next

                Return recipeworkflowTask.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
#End Region

#Region "Delete Recipe Workflow Task Information"
        <HttpPost> <POST("api/workflowtask/delete")> _
        Public Function DeleteWorkflowTask(data As Models.GenericDeleteData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Dim arrWorkflowCodes As New ArrayList
                For Each c In data.CodeList
                    If arrWorkflowCodes.IndexOf(c.CodeDictionary) = -1 Then arrWorkflowCodes.Add(c.CodeDictionary)
                Next
                Dim _codeWorkflowList As String = Common.Join(arrWorkflowCodes, "", "", ",")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_DELETE_Generic"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = _codeWorkflowList
                                .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWWORKFLOWTASK"
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.Type                       ''codeuser 'utilize for task code
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite                    ''codesite                                                        
                                .Parameters.Add("@ForceDelete", SqlDbType.Bit).Value = data.ForceDelete              ''force delete
                                .Parameters.Add("@SkipList", SqlDbType.NVarChar, 4000).Direction = ParameterDirection.Output
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1) ' RBAJ-2014.01.14                               
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Delete sales site failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Message = "Delete workflow failed"
                            Catch exc As Exception

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response

        End Function
#End Region

#Region "Udpate Workflow Sequence"
        <HttpPost> <POST("api/workflowtask/saveworkflowtasksequence")> _
        Public Function SaveSequenceWorkflow(data As Models.WorkflowData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Dim arrWorkflowCodes As New ArrayList
                For Each d In data.CodeList
                    If arrWorkflowCodes.IndexOf(d.Code) = -1 Then arrWorkflowCodes.Add(d.Code)
                Next
                Dim _codeWorkflowList As String = Common.Join(arrWorkflowCodes, "", "", ",")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "MANAGE_WorkflowSequence"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeTask", SqlDbType.VarChar, 4000).Value = _codeWorkflowList
                                .Parameters.Add("@Code", SqlDbType.Int).Value = data.Info.Code                  'codeworkflow
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1)

                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Sequence failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Message = "Workflow sequence failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
                            Catch exc As Exception

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Workflow")
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Workflow")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
            End Try
            Return response

        End Function

#End Region

#Region "Check Archive Workflow"
        <HttpGet> <[GET]("/api/workflow/checkIsArchive/{code:int}")> _
        Public Function WorkflowIsArchive(code As Integer) As Models.ResponseCallBack
            Try
                Dim _trans As SqlTransaction = Nothing
                Dim response As New Models.ResponseCallBack
                Dim ds As New DataSet
                Dim resultCode As Integer
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "API_GET_CHECKWORKFLOWSTATUS"
                                .Parameters.Clear()
                                .Parameters.Add("@Code", SqlDbType.Int).Value = code
                                .Parameters.Add("@retval", SqlDbType.Int)
                                .Parameters("@retval").Direction = ParameterDirection.ReturnValue
                                cn.Open()

                                _trans = cn.BeginTransaction
                                .Transaction = _trans
                                .CommandTimeout = 120
                                .ExecuteNonQuery()

                                Dim codeTaskWorkflow As Integer = GetInt(.Parameters("@Code").Value, -1)
                                resultCode = GetInt(.Parameters("@retval").Value, -1)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = resultCode
                                response.Status = True
                                _trans.Commit()
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                Try
                                    _trans.Rollback()
                                    If Not _trans Is Nothing Then
                                        CType(_trans, IDisposable).Dispose()
                                    End If
                                Catch
                                End Try
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Database error occured."
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Return response
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try

        End Function
#End Region

#Region "Check Workflow Status"
        <HttpPost> <POST("/api/workflow/workflowallowdelete")> _
        Public Function ValidateWorkflowAllowDelete(data As Models.GenericDeleteData) As List(Of Models.Workflow)
            Try
                Dim arrListeWorkflowCodes As New ArrayList
                For Each c In data.CodeList
                    If arrListeWorkflowCodes.IndexOf(c.Code) = -1 Then arrListeWorkflowCodes.Add(c.Code)
                Next
                Dim _codeListeWorkflowList As String = Common.Join(arrListeWorkflowCodes, "", "", ",")

                Try
                    Dim ds As New DataSet
                    Using cmd As New SqlCommand
                        With cmd
                            Using cn As New SqlConnection(ConnectionString)
                                Try
                                    .Connection = cn
                                    .CommandType = CommandType.StoredProcedure
                                    .CommandText = "[dbo].[API_GET_WorkflowAllowDelete]"
                                    .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = _codeListeWorkflowList
                                    cn.Open()
                                    Dim _da As New SqlDataAdapter(cmd)
                                    _da.Fill(ds)
                                Finally
                                    If Not cn Is Nothing Then
                                        cn.Close()
                                        CType(cn, IDisposable).Dispose()
                                    End If
                                End Try
                            End Using
                        End With
                    End Using

                    Dim workflowinfo As New List(Of Models.Workflow)
                    For Each r In ds.Tables(0).Rows
                        workflowinfo.Add(New Models.Workflow With {
                                        .Code = GetInt(r("WorkflowCode")),
                                        .CodeTaskWorkflow = GetInt(r("TaskCode")),
                                        .TaskName = GetStr(r("Task")),
                                        .User = GetStr(r("AssignedUser")),
                                        .Duration = GetDbl(r("Duration")),
                                        .WorkflowName = GetStr(r("CodeWorkflowName")),
                                        .Name = GetStr(r("CodeWorkflowName")),
                                        .CodeTask = GetInt(r("TaskCode"))
                                    })
                    Next

                    Return workflowinfo.ToList
                Catch aex As ArgumentException
                    Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                    Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
                Catch hex As HttpResponseException
                    Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                    Throw hex
                Catch ex As Exception
                    Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                    Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
                End Try
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
#End Region

        'ECAM API's
#Region "Display List of Recipe WorkFlow"
        <HttpGet> <[GET]("/api/recipeworkflowlist/{codeuser?}/{istemp?}/{taskstatus?}")> _
        Public Function GetRecipeWorkflowList(ByVal codeuser As Integer, ByVal istemp As Integer, Optional ByVal taskstatus As String = "") As List(Of Models.RecipeWorkflowList)

            If taskstatus = "All" Then
                taskstatus = ""
            End If

            Try
                Dim ds As New DataSet
                'Dim labelComposition As New Models.LabelComposition
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_WorkflowList]"
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = codeuser
                                .Parameters.Add("@TaskStatus", SqlDbType.VarChar).Value = taskstatus
                                .Parameters.Add("@IsTemp", SqlDbType.Int).Value = istemp
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

                Dim workflow As New List(Of Models.RecipeWorkflowList)
                For Each wf In ds.Tables(0).Rows
                    workflow.Add(New Models.RecipeWorkflowList With {
                                .ID = GetInt(wf("ID")), _
                                .Workflow = GetStr(wf("Workflow")), _
                                .Task = GetStr(wf("Task")), _
                                .CodeListe = GetInt(wf("CodeListe")), _
                                .Recipe = GetStr(wf("Recipe")), _
                                .Attachment = GetStr(wf("Attachment")), _
                                .User = GetStr(wf("AssignedUser")), _
                                .DateTime = GetStr(wf("DateTime")), _
                                .Duration = GetDbl(wf("Duration")), _
                                .TaskStatus = GetStr(wf("TaskStatus")), _
                                .CodeWorkflowTask = GetInt(wf("CodeWorkflowTask"))})
                Next

                Return workflow.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/workflowtaskuser/{codeworkflow?}")> _
        Public Function GetWorkflowTaskAndUser(ByVal codeworkflow As Integer) As List(Of Models.WorkflowTaskUser)

            Try
                Dim ds As New DataSet
                'Dim labelComposition As New Models.LabelComposition
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_WorkflowTaskUser]"
                                .Parameters.Add("@CodeWorkflow", SqlDbType.Int).Value = codeworkflow
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

                Dim workflow As New List(Of Models.WorkflowTaskUser)
                For Each wf In ds.Tables(0).Rows
                    workflow.Add(New Models.WorkflowTaskUser With {
                                .ID = GetInt(wf("ID")), _
                                .WorkflowCode = GetInt(wf("WorkflowCode")), _
                                .Workflow = GetStr(wf("WorkflowName")), _
                                .TaskCode = GetInt(wf("TaskCode")), _
                                .Task = GetStr(wf("TaskName")), _
                                .UserCode = GetInt(wf("UserCode")), _
                                .User = GetStr(wf("UserName")), _
                                .Duration = GetInt(wf("Duration"))})
                Next

                Return workflow.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
#End Region

#Region "Save / Update Recipe Worflow Liste"

        <HttpPost> <POST("api/listeworkflow")> _
        Public Function SaveListeWorkflow(data As Models.WorkflowDataRecipe) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim _trans As SqlTransaction = Nothing
            Dim resultCode As Integer = 0
            Dim pictures As String = ""
            Dim codeListe As Integer = 0
            Dim codeWorkflow As Integer = 0

            Try
                Using cmd As New SqlCommand

                    If data Is Nothing Then
                        Throw (New ArgumentNullException("workflow data is empty"))
                    End If

                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try

                                If data.RecipeWorkflowData.Count > 0 Then
                                    .CommandTimeout = 120 'Wait for 2 mintues for the query to execute before timing out.
                                    .Connection = cn
                                    cn.Open()
                                    For Each wf In data.RecipeWorkflowData
                                        .CommandText = "API_UPDATE_ListeWorkflow"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = wf.CodeListe
                                        codeListe = wf.CodeListe
                                        .Parameters.Add("@RecipeName", SqlDbType.NVarChar, 255).Value = wf.RecipeName
                                        .Parameters.Add("@CodeWorkflowTask", SqlDbType.Int).Value = wf.CodeWorkflowTask
                                        .Parameters.Add("@Attachment", SqlDbType.NVarChar, 255).Value = wf.Attachment
                                        .Parameters.Add("@TaskStatus", SqlDbType.NVarChar, 255).Value = wf.TaskStatus
                                        .Parameters.Add("@DateTime", SqlDbType.NVarChar, 50).Value = wf.DateTime
                                        .Parameters.Add("@UpdateDate", SqlDbType.NVarChar, 50).Value = wf.UpdateDate
                                        .Parameters.Add("@IsTemp", SqlDbType.Bit).Value = wf.IsTemp

                                        .ExecuteNonQuery()
                                    Next

                                    For Each wf In data.RecipeWorkflowData
                                        If wf.IsTemp Then
                                            If Not data.WorkflowAttachment Is Nothing Then

                                                .CommandText = <sql>IF NOT EXISTS(SELECT CodeWorkflowTask from EgswWorkflowFiles where CodeWorkflowTask=@CodeWorkflowTask and CodeListe = @CodeListe)
                                                                BEGIN
                                                                INSERT INTO EgswWorkflowFiles(CodeWorkflowTask, CodeListe, Flag, [Filename], Filecaption, [Default])
                                                                VALUES (@CodeWorkflowTask, @CodeListe, @Flag, @FileName, @Filecaption, @Default)
                                                                END
                                                                </sql>
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()
                                                .Parameters.Add("@CodeWorkflowTask", SqlDbType.Int).Value = wf.CodeWorkflowTask
                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = wf.CodeListe
                                                .Parameters.Add("@Flag", SqlDbType.Int).Value = data.WorkflowAttachment.Type
                                                .Parameters.Add("@FileName", SqlDbType.NVarChar).Value = data.WorkflowAttachment.Resource
                                                .Parameters.Add("@Filecaption", SqlDbType.NVarChar).Value = data.WorkflowAttachment.Name
                                                .Parameters.Add("@Default", SqlDbType.Bit).Value = data.WorkflowAttachment.IsDefault
                                                codeWorkflow = wf.CodeWorkflowTask
                                                .ExecuteNonQuery()

                                            End If
                                        End If

                                    Next

                                    Dim ctr As Integer = 0
                                    For Each wf In data.RecipeWorkflowData
                                        ctr += 1
                                        ''Attachments (files)
                                        If data.CustomTempAttachments IsNot Nothing AndAlso data.CustomTempAttachments.Length > 0 Then
                                            m_Attachments = data.WorkflowAttachment

                                            m_TempAttachments = data.CustomTempAttachments
                                            m_intCodeListe = wf.CodeListe
                                            m_codeWorkflow = wf.CodeWorkflowTask
                                            m_recipeName = wf.RecipeName

                                            SaveAttachments(ctr, data.RecipeWorkflowData.Count)

                                            'Dim NewThread As Thread = New Thread(AddressOf SaveAttachments)
                                            'NewThread.Priority = ThreadPriority.Highest
                                            'NewThread.Start()
                                        End If
                                    Next



                                End If



                                response.Code = 0
                                response.Message = "Workflow successfully saved."
                                response.Status = True

                            Catch ex As Exception
                                response.Status = False
                                response.Message = "Save workflow failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
            End Try
            Return response
        End Function

        <HttpPost> <POST("api/listeworkflowupdate")> _
        Public Function UpdateListeWorkflow(data As Models.WorkflowDataRecipe) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim _trans As SqlTransaction = Nothing
            Dim resultCode As Integer = 0
            Dim pictures As String = ""
            Dim codeListe As Integer = 0
            Dim codeWorkflow As Integer = 0

            Try
                Using cmd As New SqlCommand

                    If data Is Nothing Then
                        Throw (New ArgumentNullException("workflow data is empty"))
                    End If

                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try

                                If data.RecipeWorkflowData.Count > 0 Then
                                    .CommandTimeout = 120 'Wait for 2 mintues for the query to execute before timing out.
                                    .Connection = cn
                                    cn.Open()
                                    For Each wf In data.RecipeWorkflowData
                                        If wf.TaskStatus = "Started" Then
                                            .CommandText = <sql>
                                                           UPDATE EgswListeWorkflow
                                                           SET TaskStatus = @TaskStatus, UpdateDate = @UpdateDate
                                                           WHERE ID = @ID
                                                       </sql>
                                            .CommandType = CommandType.Text
                                            .Parameters.Clear()

                                            .Parameters.Add("@TaskStatus", SqlDbType.NVarChar, 255).Value = wf.TaskStatus
                                            .Parameters.Add("@UpdateDate", SqlDbType.NVarChar, 255).Value = CDate(wf.UpdateDate)
                                            .Parameters.Add("@ID", SqlDbType.Int).Value = wf.ID
                                        Else
                                            .CommandText = <sql>
                                                           UPDATE EgswListeWorkflow
                                                           SET TaskStatus = @TaskStatus
                                                           WHERE ID = @ID
                                                       </sql>
                                            .CommandType = CommandType.Text
                                            .Parameters.Clear()

                                            .Parameters.Add("@TaskStatus", SqlDbType.NVarChar, 255).Value = wf.TaskStatus
                                            .Parameters.Add("@ID", SqlDbType.Int).Value = wf.ID
                                        End If


                                        .ExecuteNonQuery()
                                    Next

                                End If

                                response.Code = 0
                                response.Message = "Workflow successfully saved."
                                response.Status = True

                            Catch ex As Exception
                                response.Status = False
                                response.Message = "Save workflow failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
            End Try

            Return response

        End Function

#End Region

#Region "Delete Added Workflow (if not saved)"

        <HttpPost> <[POST]("api/workflowtemp/delete")> _
        Public Function DeleteWorkflowTemp() As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Try
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "TRUNCATE TABLE EgswListeWorkflow_Temp"
                                .CommandType = CommandType.Text

                                cn.Open()
                                .ExecuteNonQuery()

                                ' Done without errors
                                response.Code = 0
                                response.Message = "Recipe Workflow Temp Deleted"
                                response.ReturnValue = "OK"
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = -1
                                response.Status = False
                                response.ReturnValue = "Not OK"
                                response.Message = "Delete workflow failed"
                            Catch exc As Exception

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response

        End Function
#End Region

#Region "Delete Recipe Liste Workflow"
        <HttpPost> <POST("api/workflowliste/delete")> _
        Public Function DeleteWorkflowListe(data As Models.GenericDeleteData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Dim arrListeWorkflowCodes As New ArrayList
                For Each c In data.CodeList
                    If arrListeWorkflowCodes.IndexOf(c.Code) = -1 Then arrListeWorkflowCodes.Add(c.Code)
                Next
                Dim _codeListeWorkflowList As String = Common.Join(arrListeWorkflowCodes, "", "", ",")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_DELETE_Generic"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = _codeListeWorkflowList
                                .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWWORKFLOWLISTE"
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.CodeUser                    ''codeuser
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite                    ''codesite                                                        
                                .Parameters.Add("@ForceDelete", SqlDbType.Bit).Value = data.ForceDelete              ''force delete
                                .Parameters.Add("@SkipList", SqlDbType.NVarChar, 4000).Direction = ParameterDirection.Output
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1) ' RBAJ-2014.01.14                               
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Delete recipe worlkflow liste failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Message = "Delete recipe worlkflow liste failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
                            Catch exc As Exception

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Workflow")
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Workflow")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Workflow")
            End Try
            Return response
        End Function
#End Region

#Region "Validations"
        <HttpGet> <[GET]("/api/validaterecipename/{recipename?}")> _
        Public Function ValidateRecipeName(ByVal recipename As String) As List(Of Models.WorkflowRecipe)

            Try
                Dim ds As New DataSet
                'Dim labelComposition As New Models.LabelComposition
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "SELECT Code, Name FROM EgswListe WHERE Name=@Name AND Type=8" ' RBAJ-2014.01.23 LLG
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                .Parameters.Add("@Name", SqlDbType.VarChar).Value = recipename
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

                Dim recipe As New List(Of Models.WorkflowRecipe)
                For Each rc In ds.Tables(0).Rows
                    recipe.Add(New Models.WorkflowRecipe With {
                                .CodeListe = GetStr(rc("Code")), _
                                .Name = GetStr(rc("Name"))})
                Next

                Return recipe.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/validaterecipeworkflow/{codeliste?}/{coderecipeworkflow?}")> _
        Public Function ValidateRecipeWorkflow(ByVal CodeListe As Integer, ByVal CodeRecipeWorkflow As Integer) As Models.ResponseCallBack

            Dim response As New Models.ResponseCallBack
            Dim _trans As SqlTransaction = Nothing
            Dim resultCode As Integer = 0

            Try
                Dim ds As New DataSet
                'Dim labelComposition As New Models.LabelComposition
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = <sql>SELECT LWF.CodeListe, WFT.CodeWorkflow
                                                FROM EgswListeWorkflow LWF
                                                INNER JOIN EgswWorkflowTask WFT ON WFT.ID = LWF.CodeWorkflowTask
                                                WHERE LWF.CodeListe = @CodeListe and WFT.CodeWorkflow = @CodeWorkflow</sql>
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.VarChar).Value = CodeListe
                                .Parameters.Add("@CodeWorkflow", SqlDbType.VarChar).Value = CodeRecipeWorkflow
                                .CommandType = CommandType.Text
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                If ds.Tables(0).Rows.Count > 0 Then
                                    ' Done without errors
                                    response.Code = 1
                                    response.Message = "OK"
                                    response.ReturnValue = "Already exists."
                                    response.Status = True
                                End If

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using


            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try

            Return response
        End Function

        <HttpPost> <POST("/api/workflow/worklfowlisteallowdelete")> _
        Public Function ValidateWorflowlisteAllowdelete(data As Models.GenericDeleteData) As List(Of Models.RecipeWorkflowList)
            Try
                Dim arrListeWorkflowCodes As New ArrayList
                For Each c In data.CodeList
                    If arrListeWorkflowCodes.IndexOf(c.Code) = -1 Then arrListeWorkflowCodes.Add(c.Code)
                Next
                Dim _codeListeWorkflowList As String = Common.Join(arrListeWorkflowCodes, "", "", ",")

                Try
                    Dim ds As New DataSet
                    Using cmd As New SqlCommand
                        With cmd
                            Using cn As New SqlConnection(ConnectionString)
                                Try
                                    .Connection = cn
                                    .CommandType = CommandType.StoredProcedure
                                    .CommandText = "[dbo].[API_AllowDeleteWorkflowListe]"
                                    .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = _codeListeWorkflowList
                                    cn.Open()
                                    Dim _da As New SqlDataAdapter(cmd)
                                    _da.Fill(ds)
                                Finally
                                    If Not cn Is Nothing Then
                                        cn.Close()
                                        CType(cn, IDisposable).Dispose()
                                    End If
                                End Try
                            End Using
                        End With
                    End Using

                    Dim workflowtaskliste As New List(Of Models.RecipeWorkflowList)
                    For Each r In ds.Tables(0).Rows
                        workflowtaskliste.Add(New Models.RecipeWorkflowList With {
                                        .ID = GetInt(r("ID")),
                                        .Task = GetStr(r("Task")),
                                        .CodeWorkflowTask = GetInt(r("CodeWorkflowTask")),
                                        .TaskStatus = GetStr(r("TaskStatus"))
                                    })
                    Next

                    Return workflowtaskliste.ToList
                Catch aex As ArgumentException
                    Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                    Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
                Catch hex As HttpResponseException
                    Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                    Throw hex
                Catch ex As Exception
                    Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                    Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
                End Try
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
#End Region

#Region "Save Functions"
        Private Sub SaveAttachments(ByVal ctr As Integer, ByVal count As Integer)
            Try
                Dim strFilesFolderForListe As String = FilesFolder
                Dim strTempFolder As String = TempFolder2
                Dim strFilesFolderForListeWorkflow As String = String.Empty
                Dim strTempFolderForListeWorkflow As String = String.Empty

                'If m_strClientSerial <> "" Then
                '    strFilesFolderForListe = IIf(strFilesFolderForListe.EndsWith("\"), strFilesFolderForListe, strFilesFolderForListe & "\") & m_strClientSerial & "\" & m_intCodeListe.ToString & "\"
                '    strTempFolder = IIf(strTempFolder.EndsWith("\"), strTempFolder, strTempFolder & "\") & m_strClientSerial & "\"
                'Else
                '    strFilesFolderForListe = IIf(strFilesFolderForListe.EndsWith("\"), strFilesFolderForListe, strFilesFolderForListe & "\") & m_intCodeListe.ToString & "\"
                '    strTempFolder = IIf(strTempFolder.EndsWith("\"), strTempFolder, strTempFolder & "\")
                'End If

                strFilesFolderForListe = IIf(strFilesFolderForListe.EndsWith("\"), strFilesFolderForListe, strFilesFolderForListe & "\") & m_RecipeName.ToString & "\"
                strFilesFolderForListeWorkflow = strFilesFolderForListe & m_codeWorkflow.ToString & "\"
                strTempFolder = IIf(strTempFolder.EndsWith("\"), strTempFolder, strTempFolder & "\")

                If m_Attachments IsNot Nothing Then

                    If m_Attachments.Type = 0 AndAlso m_Attachments.Resource.Trim.Length > 0 Then
                        Dim _source As String = strTempFolder & m_Attachments.Resource
                        If File.Exists(_source) Then
                            'check if directory is existing, if not, create
                            If Directory.Exists(strFilesFolderForListe) = False Then
                                Directory.CreateDirectory(strFilesFolderForListe)
                            End If
                            If Directory.Exists(strFilesFolderForListeWorkflow) = False Then
                                Directory.CreateDirectory(strFilesFolderForListeWorkflow)
                            End If
                            'Save to files folder
                            'File.Copy(_source, strFilesFolderForListe & m_Attachments.Resource) ECAM - Comment the old file.copy
                            File.Copy(_source, strFilesFolderForListeWorkflow & m_Attachments.Resource)
                        End If
                    End If
                End If


                If ctr = count Then
                    ''Remove files stored in the temp and those in files folder
                    If m_TempAttachments IsNot Nothing AndAlso m_TempAttachments.Length > 0 Then
                        Dim arrAttachments() As String = m_TempAttachments.Trim.Split(";")
                        If arrAttachments.Length > 0 Then
                            For Each a As String In arrAttachments
                                If a.Trim.Length > 0 Then
                                    Dim _source As String = strTempFolder & a
                                    If File.Exists(_source) Then
                                        File.Delete(_source)
                                    End If

                                    Dim delete As Boolean = True
                                    If m_Attachments IsNot Nothing Then
                                        If m_Attachments.Type = 0 AndAlso m_Attachments.Resource.Trim = a.Trim Then
                                            delete = False
                                            Exit For
                                        End If
                                    End If

                                    If delete Then
                                        'Delete from picoriginal
                                        If File.Exists(strFilesFolderForListe & a) Then
                                            File.Delete(strFilesFolderForListe & a)
                                        End If
                                    End If
                                End If
                            Next
                        End If
                    End If
                End If

            Catch ex As Exception
                Log.Error("Save attachment failed", ex)
            End Try
        End Sub

        Public ReadOnly Property FilesFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("files")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("files")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property TempFolder2() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("temp")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("temp")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property
#End Region

        'Print Overdue
#Region "WorkFlowReport"
        'LD20160526 Get Overdue TaskReport
        <HttpGet> <[GET]("/api/recipe/vitamix/report/OverdueTask/{baseurl?}")> _
        Public Function GetVitamixOverdueTaskReport(Optional ByVal baseurl As String = "") As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.Vitamix
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[sp_GetWorkFlowTaskOverdue]"
                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                If ds.Tables(0).Rows.Count = 0 Then
                                    ' Done without errors
                                    response.Code = 0
                                    response.Message = "NODATA"
                                    response.ReturnValue = ""
                                    response.Status = True
                                Else
                                    result = Report.GetWorkFlowTaskReport(ds, FolderPath, ReportURL, "PDF")

                                    ' Done without errors
                                    response.Code = 0
                                    response.Message = "OK"
                                    response.ReturnValue = result
                                    response.Status = True

                                End If
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

#End Region


    End Class
End Namespace
