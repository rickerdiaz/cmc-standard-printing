Imports System
Imports System.Web
Imports System.Collections.Generic
Imports System.Linq
Imports AttributeRouting.Web.Http
Imports System.Data.SqlClient
Imports System.Web.Script.Serialization
Imports log4net
Imports System.Net
Imports Newtonsoft.Json
Imports System.Drawing
Imports System.IO
Imports System.Threading
Imports System.Text
Imports Microsoft.AspNetCore.Mvc

Namespace CalcmenuAPI
    Public Class CategoryController
        Inherits ControllerBase

        Private m_PictureNames As String
        Private m_TempPictureNames As String

        Private arrPictures As String()

        Private Shared ReadOnly Log As ILog = LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType)

        ''' <summary>
        ''' Get category information
        ''' "/api/category/{codecategory:int}/{codetrans:int}"
        ''' </summary>
        ''' <param name="codecategory"></param>
        ''' <returns></returns>
        ''' <remarks></remarks>
        <HttpGet> <[GET]("/api/category/{codecategory:int}/{codetrans:int}")> _
        Public Function GetCategory(codecategory As Integer, codetrans As Integer) As Models.CategoryData
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        .Connection = New SqlConnection(ConnectionString)
                        .CommandType = CommandType.StoredProcedure
                        .CommandText = Common.SP_API_GET_CategoryInfo
                        .Parameters.Add("@CodeCategory", SqlDbType.Int).Value = codecategory
                        .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans

                        .Connection.Open()
                        Dim _da As New SqlDataAdapter(cmd)
                        _da.Fill(ds)
                        .Connection.Close()
                    End With
                End Using

                Dim categories As New Models.CategoryData
                For Each r In ds.Tables(0).Rows
                    'categories.Add(New Models.Category With {
                    '				.Code = GetInt(r("Code")), _
                    '				.Name = GetStr(r("Name")), _
                    '				.Global = GetBool(r("Global"))})
                Next

                Return categories
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpPost> <POST("api/category")>
        Public Function SaveCategory(data As Models.CategoryData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Dim _trans As SqlTransaction = Nothing
            Dim strCodesToMerge As String = ""

            Try
                If data.MergeList.Count > 0 Then
                    'RDTC 2015.08.07
                    'the codes of the keywords being merged must be passed as parameter; 
                    'otherwise the system will complain if the new merged name is the same as one of the items being merged
                    For Each s As Integer In data.MergeList
                        If strCodesToMerge = "" Then
                            strCodesToMerge = s.ToString
                        Else
                            strCodesToMerge = strCodesToMerge & "," & s.ToString
                        End If
                    Next
                End If


                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Dim arrSharing As New ArrayList
                For Each sh In data.Sharing
                    If arrSharing.IndexOf(sh.Code) = -1 Then arrSharing.Add(sh.Code)
                Next
                Dim _codeSiteList As String = Common.Join(arrSharing, "(", ")", ",")

                Dim isarchive As Boolean
                Dim isactual As Boolean
                If data.Info.Archive = 1 Then
                    isactual = 1
                    isarchive = 0
                ElseIf data.Info.Archive = 2 Then
                    isactual = 0
                    isarchive = 1
                Else
                    isactual = 0
                    isarchive = 0
                End If

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try

                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[MANAGE_CATEGORYUPDATE]"
                                .Parameters.Clear()
                                .Parameters.Add("@Code", SqlDbType.Int).Value = data.Info.Code
                                .Parameters.Add("@CodeGroup", SqlDbType.Int).Value = 0
                                .Parameters.Add("@Name", SqlDbType.NVarChar, 150).Value = data.Info.Name
                                .Parameters.Add("@ListeType", SqlDbType.Int).Value = data.Info.Type
                                .Parameters.Add("@CodeAcct", SqlDbType.NVarChar, 25).Value = ""
                                .Parameters.Add("@IsGlobal", SqlDbType.Bit).Value = data.Info.Global
                                .Parameters.Add("@CodeSiteList", SqlDbType.NVarChar, 2000).Value = _codeSiteList
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.Profile.Code
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.Profile.CodeSite
                                .Parameters.Add("@IsProduct", SqlDbType.Bit).Value = 0
                                .Parameters.Add("@Picture", SqlDbType.NVarChar, 400).Value = data.Info.Picture
                                .Parameters.Add("@IsActual", SqlDbType.Bit).Value = isactual
                                .Parameters.Add("@IsArchive", SqlDbType.Bit).Value = isarchive
                                .Parameters.Add("@CodesToMerge", SqlDbType.NVarChar, 2000).Value = strCodesToMerge
                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                .Parameters("@Code").Direction = ParameterDirection.InputOutput

                                cn.Open()
                                _trans = cn.BeginTransaction ' RBAJ-2014.01.13
                                .Transaction = _trans

                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Save category failed", resultCode))
                                End If


                                Dim codeCategory = CInt(.Parameters("@Code").Value)
                                If codeCategory > 0 Then
                                    .CommandText = "sp_EgswItemTranslationUpdate"
                                    .CommandType = CommandType.StoredProcedure
                                    For Each t In data.Translation
                                        .Parameters.Clear()
                                        .Parameters.Add("@intCode", SqlDbType.Int).Value = codeCategory
                                        .Parameters.Add("@nvcName", SqlDbType.NVarChar, 260).Value = t.Name
                                        .Parameters.Add("@nvcName2", SqlDbType.NVarChar, 150).Value = t.Name2
                                        .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = t.CodeTrans
                                        .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = t.CodeSite
                                        .Parameters.Add("@tntListType", SqlDbType.Int).Value = 1
                                        .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = data.Profile.Code
                                        .Parameters.Add("@tntType", SqlDbType.Int).Value = data.Info.Type
                                        .Parameters.Add("@nvcPlural", SqlDbType.NVarChar, 150).Value = t.NamePlural
                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        .ExecuteNonQuery()
                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Save category failed", resultCode))
                                        End If
                                    Next

                                    If (data.Info.Type = 8) Then
                                        ''Autonumbering
                                        .CommandText = "sp_EgswUpdateAutoNumberDetailCategory"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()
                                        .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = data.AutoNumber.AutoNumberCodeSite
                                        .Parameters.Add("@intItemType", SqlDbType.Int, 260).Value = 8
                                        .Parameters.Add("@blnAutoNumber", SqlDbType.Bit).Value = data.AutoNumber.AutoNumber
                                        .Parameters.Add("@vchPrefix", SqlDbType.NVarChar, 50).Value = data.AutoNumber.AutoNumberPrefix
                                        .Parameters.Add("@vchStartingNum", SqlDbType.NVarChar, 50).Value = data.AutoNumber.AutoNumberStart
                                        .Parameters.Add("@blnKeepLength", SqlDbType.Bit).Value = data.AutoNumber.AutoNumberKeepPrefixLength
                                        .Parameters.Add("@intCodeCategory", SqlDbType.Int).Value = codeCategory
                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        .ExecuteNonQuery()
                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Save category failed", resultCode))
                                        End If
                                    End If

                                Else
                                    resultCode = GetInt(.Parameters("@retval").Value, -1)
                                    If resultCode <> 0 Then
                                        Throw New DatabaseException(String.Format("[{0}] Save category failed", resultCode))
                                    End If
                                End If

                                '' Merge, get all the sites where the items to be merged are shared.
                                If data.ActionType = 5 Then
                                    If data.MergeList.Count > 0 Then
                                        Dim arrSites As New ArrayList
                                        For Each s As Integer In data.MergeList
                                            If arrSites.IndexOf(s) = -1 Then arrSites.Add(s)
                                        Next
                                        Dim _SiteList As String = Common.Join(arrSites, "(", ")", ",")
                                        Dim sql As New StringBuilder
                                        sql.Append("INSERT INTO EgswSharing ")
                                        sql.Append("SELECT @Code,0,CodeUserSharedTo,1,19,0,1,0 ")
                                        sql.Append("FROM EgswSharing ")
                                        sql.Append("WHERE Code=@Code AND CodeEgswTable=19 AND [Status]=1 AND [Type] IN (1,5) ")
                                        sql.Append("    AND CodeUserSharedTo NOT IN (")
                                        sql.Append("    SELECT DISTINCT CodeUserSharedTo ")
                                        sql.Append("    FROM EgswSharing  ")
                                        sql.Append("    WHERE Code IN " & _SiteList & " AND CodeEgswTable=19 AND [Status]=1 AND [Type] IN (1,5)")
                                        sql.Append("    ) ")
                                        .CommandText = sql.ToString
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@Code", SqlDbType.Int).Value = codeCategory
                                        .ExecuteNonQuery()


                                        ' CWM-13896 - JPJA 2014.04.24
                                        ' Added this so that recipes in categories to be merged are transferred to the newly created category
                                        Dim arrMergeList As New ArrayList
                                        For Each sh In data.MergeList
                                            If arrMergeList.IndexOf(sh) = -1 Then arrMergeList.Add(sh)
                                        Next
                                        Dim _mergeList As String = Common.Join(arrMergeList, "(", ")", ",")
                                        sql.Clear()
                                        sql.Append("UPDATE EgswListe ")
                                        sql.Append("SET Category=@newCategoryCode ")
                                        sql.Append(" WHERE Category IN " & _mergeList)
                                        .CommandText = sql.ToString
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@newCategoryCode", SqlDbType.Int).Value = codeCategory
                                        Dim rowsAffected As Integer
                                        rowsAffected = cmd.ExecuteNonQuery()


                                        ' Delete merged items // RBAJ-2014.04.03
                                        .CommandText = "API_DELETE_Generic"
                                        .CommandType = CommandType.StoredProcedure
                                        For Each code In arrSites
                                            .Parameters.Clear()
                                            .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = GetInt(code)
                                            .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWCATEGORY"
                                            .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.Profile.Code
                                            .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.Profile.CodeSite
                                            .Parameters.Add("@ForceDelete", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@SkipList", SqlDbType.NVarChar, 4000).Direction = ParameterDirection.Output
                                            .Parameters.Add("@Return", SqlDbType.Int)
                                            .Parameters("@Return").Direction = ParameterDirection.ReturnValue
                                            .ExecuteNonQuery()
                                            resultCode = GetInt(.Parameters("@Return").Value, -1) ' RBAJ-2014.01.14                               
                                            If resultCode <> 0 Then
                                                Throw New DatabaseException(String.Format("[{0}] Delete merged category failed", resultCode))
                                            End If
                                        Next
                                    End If
                                End If

                                Dim procpics As String = data.Info.Picture + ";"
                                m_PictureNames = procpics
                                m_TempPictureNames = data.Info.Picture
                                arrPictures = procpics.Split(";")
                                Log.Info("arrayPictures" + arrPictures.ToString)
                                Dim NewThread As Thread = New Thread(AddressOf SavePictures)
                                NewThread.Priority = ThreadPriority.Lowest
                                NewThread.Start()


                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = codeCategory
                                response.Status = True
                                _trans.Commit()
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                Try
                                    _trans.Rollback()
                                    If Not _trans Is Nothing Then
                                        CType(_trans, IDisposable).Dispose()
                                    End If
                                Catch
                                End Try
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Save category failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Category")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Category")
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Category")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Category")
            End Try
            Return response

        End Function

        <HttpGet> <[GET]("/api/category/{codesite:int}/{codetrans:int}/{type:int}")> _
        Public Function GetCategoryList(codesite As Integer, _
                                 codetrans As Integer, _
                                 type As Integer) As List(Of Models.GenericCodeValueList)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Generic]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@TableName", SqlDbType.NVarChar, 200).Value = "EGSWCATEGORY"
                                .Parameters.Add("@Status", SqlDbType.Int).Value = 1
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim categories As New List(Of Models.GenericCodeValueList)
                For Each r In ds.Tables(0).Rows
                    categories.Add(New Models.GenericCodeValueList With {.Code = GetInt(r("Code")), .Value = GetStr(r("Name"))})
                Next

                Return categories
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/category/{codesite:int}/{codetrans:int}/{type:int}/{status}/{codeproperty?}/{name?}")> _
        Public Function SearchCategoryByName(codesite As Integer, _
                              codetrans As Integer, _
                              type As Integer, _
                              status As Integer, _
                              Optional codeproperty As Integer = -1,
                              Optional name As String = "") As List(Of Models.Category)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        .Connection = New SqlConnection(ConfigurationManager.AppSettings.Get("dsn").ToString)
                        .CommandType = CommandType.StoredProcedure
                        .CommandText = "[dbo].[API_MANAGE_Generic]"
                        .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                        .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                        .Parameters.Add("@Type", SqlDbType.Int).Value = type
                        .Parameters.Add("@Status", SqlDbType.Int).Value = status
                        .Parameters.Add("@TableName", SqlDbType.NVarChar, 200).Value = "EGSWCATEGORY"
                        .Parameters.Add("@CodeProperty", SqlDbType.Int).Value = codeproperty

                        .Connection.Open()
                        Dim _da As New SqlDataAdapter(cmd)
                        _da.Fill(ds)
                        .Connection.Close()
                    End With
                End Using

                Dim categories As New List(Of Models.Category)
                For Each r In ds.Tables(0).Rows
                    categories.Add(New Models.Category With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name")), _
                                    .Global = GetBool(r("Global"))})
                Next

                If name.Trim <> "" Then

                    Dim categoryresult As New List(Of Models.Category)

                    Dim arrNames() As String = name.Trim.Split(",")
                    For Each word In arrNames
                        If word.Trim.ToString <> "" Then    'RDTC 2015.08.10; added this otherwise the rows are getting duplicated
                            For Each c In categories
                                If c.Name.ToLower.Contains(Common.ReplaceSpecialCharacters(word.Trim.ToLower)) Then
                                    categoryresult.Add(c)
                                End If
                            Next
                        End If
                    Next
                    categories = categoryresult

                End If

                Return categories.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        'START - Raqi Pinili 08.26.2015
        <HttpPost> <[POST]("/api/category/search")> _
        Public Function SearchCategoryByName2(data As Models.ConfigurationcSearch) As List(Of Models.Category)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        .Connection = New SqlConnection(ConfigurationManager.AppSettings.Get("dsn").ToString)
                        .CommandType = CommandType.StoredProcedure
                        .CommandText = "[dbo].[API_MANAGE_Generic]"
                        .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite
                        .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = data.CodeTrans
                        .Parameters.Add("@Type", SqlDbType.Int).Value = data.Type
                        .Parameters.Add("@Status", SqlDbType.Int).Value = data.Status
                        .Parameters.Add("@TableName", SqlDbType.NVarChar, 200).Value = "EGSWCATEGORY"
                        .Parameters.Add("@CodeProperty", SqlDbType.Int).Value = data.CodeProperty

                        .Connection.Open()
                        Dim _da As New SqlDataAdapter(cmd)
                        _da.Fill(ds)
                        .Connection.Close()
                    End With
                End Using

                Dim categories As New List(Of Models.Category)
                For Each r In ds.Tables(0).Rows
                    categories.Add(New Models.Category With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name")), _
                                    .Global = GetBool(r("Global"))})
                Next

                If data.Name.Trim <> "" Then

                    Dim categoryresult As New List(Of Models.Category)

                    Dim arrNames() As String = data.Name.Trim.Split(",")
                    For Each word In arrNames
                        If word.Trim.ToString <> "" Then    'RDTC 2015.08.10; added this otherwise the rows are getting duplicated
                            For Each c In categories
                                If c.Name.ToLower.Contains(Common.ReplaceSpecialCharacters(word.Trim.ToLower)) Then
                                    categoryresult.Add(c)
                                End If
                            Next
                        End If
                    Next
                    categories = categoryresult

                End If

                Return categories.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
        'END - Raqi Pinili 08.26.2015

        <HttpGet> <[GET]("/api/category/autonumber/{codecategory:int}/{codesite:int}")> _
        Public Function getcategoryautonumber(codecategory As Integer, _
                                           codesite As Integer) As Models.AutoNumber
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[sp_EgswGetAutoNumberDetailCategory]"
                                .Parameters.Add("@intCodeCategory", SqlDbType.Int).Value = codecategory
                                .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = codesite

                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim autoNumber As New Models.AutoNumber

                If (ds.Tables(0).Rows.Count < 1) Then
                    Return autoNumber
                End If
                Try
                    Dim row1 = ds.Tables(0).Rows(0)
                    autoNumber.AutoNumberPrefix = GetStr(row1.Item("Prefix"))
                    autoNumber.AutoNumber = GetBool(row1.Item("AutoNumber"))
                    autoNumber.AutoNumberCodeSite = GetInt(row1.Item("CodeSite"))
                    autoNumber.AutoNumberKeepPrefixLength = GetBool(row1.Item("KeepLength"))
                    autoNumber.AutoNumberStart = GetStr(row1.Item("StartingNumber"))
                    Return autoNumber
                Catch ex As Exception
                    Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                    Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
                End Try

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        ''' <summary>
        ''' Get autonumber
        ''' </summary>
        ''' <returns></returns>
        ''' <remarks>RBAJ-2014.03.28</remarks>
        <HttpGet> <[GET]("/api/autonumber/{codesite:int}/{codeuser:int}/{type:int}/{category:int?}")> _
        Public Function GetAutoNumber(codesite As Integer, codeuser As Integer, type As Integer, Optional category As Integer = -1) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Try
                Dim strNumber As String = String.Empty
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_AutoNumber]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = codeuser
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@CodeCategory", SqlDbType.Int).Value = category

                                .Parameters.Add("@Number", SqlDbType.VarChar, 50).Direction = ParameterDirection.Output
                                .Parameters.Add("@ERR", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                cn.Open()
                                .ExecuteNonQuery()

                                strNumber = GetStr(.Parameters("@Number").Value)
                                resultCode = GetInt(.Parameters("@ERR").Value)

                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Get Autonumber failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = strNumber
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Get Autonumber failed"
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("/api/category/translation/{codecategory:int}/{codesite:int}")> _
        Public Function GetCategoryTranslation(codecategory As Integer, _
                                           codesite As Integer) As List(Of Models.RecipeTranslation)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_CategoryTranslation]"
                                .Parameters.Add("@CodeCategory", SqlDbType.Int).Value = codecategory
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite

                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim isArchive As Boolean
                Dim isActual As Boolean
                Dim archive As Integer


                Dim translations As New List(Of Models.RecipeTranslation)
                For Each r In ds.Tables(0).Rows

                    isArchive = r("isArchive")
                    isActual = r("isActual")

                    If isArchive = True Then
                        archive = 2
                    ElseIf isActual = True Then
                        archive = 1
                    Else
                        archive = 0
                    End If
                    translations.Add(New Models.RecipeTranslation With {
                                    .CodeTrans = GetInt(r("CodeTrans")), _
                                    .TranslationName = GetStr(r("TranslationName")), _
                                    .Name = GetStr(r("Name")), _
                                    .Picture = GetStr(r("Picture")), _
                                    .hasPicture = 1, _
                                    .Archive = archive})
                Next

                Return translations.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpPost> <POST("api/category/delete")> _
        Public Function DeleteCategory(data As Models.GenericDeleteData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Dim arrCategoryCodes As New ArrayList
                For Each c In data.CodeList
                    If arrCategoryCodes.IndexOf(c.Code) = -1 Then arrCategoryCodes.Add(c.Code)
                Next
                Dim _codeCategoryList As String = Common.Join(arrCategoryCodes, "", "", ",")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_DELETE_Generic"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = _codeCategoryList
                                .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWCATEGORY"
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.CodeUser                    ''codeuser
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite                    ''codesite                                                        
                                .Parameters.Add("@ForceDelete", SqlDbType.Bit).Value = data.ForceDelete              ''force delete
                                .Parameters.Add("@SkipList", SqlDbType.NVarChar, 4000).Direction = ParameterDirection.Output
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1) ' RBAJ-2014.01.14                               
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Delete category failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Message = "Delete category failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Category")
                            Catch exc As Exception

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Category")
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Category")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Category")
            End Try
            Return response

        End Function

        <HttpPost> <POST("api/category/purge/{type:int}/{codeUser:int}/{codeSite:int}")> _
        Public Function PurgeCategory(type As Integer, codeUser As Long, codeSite As Long) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer = 0
            Dim _trans As SqlTransaction = Nothing

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + "[" + type.ToString + "]")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_PURGE_Generic"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWCATEGORY"
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = codeUser   '' Doesn't need this here, but it should be controlled in the UI/
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codeSite '' The roles and rights of the user should determine if the link button must be shown or not.
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                _trans = cn.BeginTransaction ' RBAJ-2014.01.13 Added transaction
                                .Transaction = _trans
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1)

                                If resultCode <> 0 Then
                                    If resultCode = -480 Then
                                        response.Code = -480
                                        response.Message = "Nothing was deleted"
                                        response.Status = False
                                    Else
                                        Throw New DatabaseException(String.Format("[{0}] Purge category failed", resultCode))
                                    End If
                                Else
                                    ' Done without errors
                                    response.Code = 0
                                    response.Message = "OK"
                                    response.Status = True
                                End If

                                _trans.Commit()

                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                Try
                                    _trans.Rollback()
                                    If Not _trans Is Nothing Then
                                        CType(_trans, IDisposable).Dispose()
                                    End If
                                Catch
                                End Try
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Purge category failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Category")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Category")
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Category")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Category")
            End Try
            Return response

        End Function

        <HttpGet> <[GET]("/api/category/sharing/{codesite:int}/{type:int}/{tree:int}/{codecategory:int}")> _
        Public Function GetCategorySharing(codesite As Integer, _
                                  type As Integer, _
                                  tree As Integer, _
                                  codecategory As Integer) As List(Of Models.TreeNode)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "[dbo].[API_GET_SharingCategory]"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@CodeCategory", SqlDbType.Int).Value = codecategory
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim sharings As New List(Of Models.GenericTree)
                For Each r In ds.Tables(0).Rows
                    sharings.Add(New Models.GenericTree With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name")), _
                                    .ParentCode = GetInt(r("ParentCode")), _
                                    .ParentName = GetStr(r("ParentName")), _
                                    .Flagged = GetBool(r("Flagged")), _
                                    .Type = GetInt(r("Type")), _
                                    .Global = GetBool(r("Global"))})
                Next

                Dim sharingdata As New List(Of Models.TreeNode)

                Dim parents = sharings.Where(Function(obj) obj.ParentCode = 0 And obj.Type = 1).OrderBy(Function(obj) obj.Name).ToList()

                For Each p In parents
                    Dim parent As New Models.TreeNode
                    parent.title = p.Name
                    parent.key = p.Code
                    parent.icon = False
                    parent.children = CreateChildrenSharing(sharings, p.Code)
                    parent.select = p.Flagged
                    parent.selected = p.Flagged
                    parent.parenttitle = p.ParentName
                    parent.groupLevel = GroupLevel.Property     'MKAM 2014.11.11
                    If parent.children.Count > 0 Then sharingdata.Add(parent)
                Next

                Return sharingdata
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/category/sharingMerge/{codesite:int}/{type:int}/{tree:int}/{codecategory?}")> _
        Public Function GetCategorySharingMerge(codesite As Integer, _
                                  type As Integer, _
                                  tree As Integer, _
                                  codecategory As String) As List(Of Models.TreeNode)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "[dbo].[API_GET_SharingMerge]"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@CodeCategory", SqlDbType.NVarChar, 50).Value = codecategory
                                .Parameters.Add("@CodeEgswTable", SqlDbType.Int).Value = 19
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim sharings As New List(Of Models.GenericTree)
                For Each r In ds.Tables(0).Rows
                    sharings.Add(New Models.GenericTree With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name")), _
                                    .ParentCode = GetInt(r("ParentCode")), _
                                    .ParentName = GetStr(r("ParentName")), _
                                    .Flagged = GetBool(r("Flagged")), _
                                    .Type = GetInt(r("Type")), _
                                    .Global = GetBool(r("Global"))})
                Next

                Dim sharingdata As New List(Of Models.TreeNode)

                Dim parents = sharings.Where(Function(obj) obj.ParentCode = 0 And obj.Type = 1).OrderBy(Function(obj) obj.Name).ToList()

                For Each p In parents
                    Dim parent As New Models.TreeNode
                    parent.title = p.Name
                    parent.key = p.Code
                    parent.icon = False
                    parent.children = CreateChildrenSharing(sharings, p.Code)
                    parent.select = p.Flagged
                    parent.selected = p.Flagged
                    parent.parenttitle = p.ParentName
                    parent.groupLevel = GroupLevel.Property     'MKAM 2014.11.11
                    If parent.children.Count > 0 Then sharingdata.Add(parent)
                Next

                Return sharingdata
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function


        Private Function CreateChildrenSharing(_sharingdata As List(Of Models.GenericTree),
                                        _code As Integer) As List(Of Models.TreeNode)
            Dim children As New List(Of Models.TreeNode)

            If _sharingdata IsNot Nothing Then
                Dim kids = _sharingdata.Where(Function(obj) obj.ParentCode = _code And obj.Type = 2).OrderBy(Function(obj) obj.Name).ToList() ' RBAJ-2014.04.23 Fixed infinite loop "obj.Code <> _code"

                For Each k In kids
                    Dim child As New Models.TreeNode
                    child.title = k.Name
                    child.key = k.Code
                    child.icon = False
                    child.children = Nothing
                    children.Add(child)
                    child.select = k.Flagged
                    child.selected = k.Flagged
                    child.parenttitle = k.ParentName
                    child.groupLevel = GroupLevel.Site     'MKAM 2014.11.11
                    child.note = k.Global
                Next
            End If

            Return children
        End Function


        Private Sub SavePictures()
            Try

                Dim strTempFolder As String = TempFolder2

                If m_PictureNames.Trim.Length > 0 Then
                    Dim arrPictureNames() As String = m_PictureNames.Trim.Split(";")
                    m_PictureNames = String.Join(";", arrPictures)
                    If arrPictureNames.Length > 0 Then
                        For ctr As Integer = 0 To arrPictureNames.Length - 1
                            If arrPictureNames(ctr).Trim.Length > 0 Then

                                Dim pic As String = arrPictureNames(ctr)
                                Dim _source As String
                                If pic.Trim.IndexOf("| DAM") <> -1 Then

                                    pic = pic.Substring(0, pic.IndexOf("|")).Trim
                                    _source = DamFolder & pic
                                    File.Copy(_source, strTempFolder & arrPictures(ctr))
                                    pic = arrPictures(ctr)
                                End If
                                _source = strTempFolder & pic
                                If File.Exists(_source) Then

                                    'Save picoriginal
                                    File.Copy(_source, PicOriginalFolder & pic)
                                    'Save picnormal
                                    fctResizeConvertImage(_source, PicNormalFolder & pic, 300, 300, False)

                                    'Save picthumbnail
                                    fctResizeConvertImage(_source, PicThumbnailFolder & pic, 200, 200, False)
                                    Log.Info("Picture saved:" + _source)
                                End If
                            End If
                        Next
                    End If
                End If

                ''Remove pictures stored in the temp and those in picnormal, picthumbnail, picoriginal
                If m_TempPictureNames.Length > 0 Then
                    Dim arrPictureNames() As String = m_TempPictureNames.Trim.Split(";")
                    If arrPictureNames.Length > 0 Then
                        For Each pic As String In arrPictureNames

                            If pic.Trim.Length > 0 Then
                                If pic.Trim.LastIndexOf("| DAM") = -1 Then
                                    Dim _source As String = strTempFolder & pic
                                    If File.Exists(_source) Then
                                        File.Delete(_source)

                                    End If

                                    If m_PictureNames.IndexOf(pic) = -1 Then
                                        'Delete from picoriginal
                                        If File.Exists(PicOriginalFolder & pic) Then
                                            File.Delete(PicOriginalFolder & pic)
                                        End If

                                        'Delete from picnormal
                                        If File.Exists(PicNormalFolder & pic) Then
                                            File.Delete(PicNormalFolder & pic)
                                        End If

                                        'Delete from picthumbnail
                                        If File.Exists(PicThumbnailFolder & pic) Then
                                            File.Delete(PicThumbnailFolder & pic)
                                        End If
                                        Log.Info("Picture deleted:" + pic)
                                    End If

                                End If
                            End If

                        Next
                    End If
                End If

            Catch ex As Exception
                Log.Error("Save pictures failed", ex)
            End Try
        End Sub

        Public ReadOnly Property TempFolder2() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("temp")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("temp")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property DamFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("dam")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("DigitalAssets")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property
        Public ReadOnly Property PicNormalFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("picnormal")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("picnormal")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property PicThumbnailFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("picthumbnail")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("picthumbnail")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property
        Public ReadOnly Property PicOriginalFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("picoriginal")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("picoriginal")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Private Function fctResizeConvertImage(ByVal strFile As String, _
                                               ByVal strDestination As String, _
                                               ByVal newWidth As Integer, _
                                               ByVal newHeight As Integer, _
                                               Optional ByVal blnDelete As Boolean = False) As Boolean
            Try
                Dim dblTempW As Double
                Dim dblTempH As Double
                Dim H1 As Integer
                Dim W1 As Integer
                Dim strNewFile As String

                Dim FileToResize As String = strFile 'Server.MapPath("~/images/1.jpg")
                Dim originalBitmap As Bitmap = Bitmap.FromFile(FileToResize, True)
                Dim WidthVsHeightRatio = CDec(originalBitmap.Height) / CDec(originalBitmap.Width)

                If newHeight > newWidth Then
                    dblTempH = CDbl(newHeight)
                    dblTempW = dblTempH / WidthVsHeightRatio
                Else
                    dblTempW = CDbl(newWidth)
                    dblTempH = dblTempW * WidthVsHeightRatio
                End If
                Do While (dblTempW > CDbl(newWidth) Or dblTempH > CDbl(newHeight))
                    dblTempW = (dblTempW * 0.999)
                    dblTempH = (dblTempH * 0.999)
                Loop
                W1 = CInt(dblTempW)
                H1 = CInt(dblTempH)

                Dim newbmp As Bitmap = New Bitmap(W1, H1)
                Using newg As Graphics = Graphics.FromImage(newbmp)
                    newg.SmoothingMode = Drawing2D.SmoothingMode.HighQuality
                    newg.Clear(Color.White)
                    newg.DrawImage(originalBitmap, 0, 0, W1, H1)
                    newg.Save()
                End Using
                strNewFile = Replace(Path.GetFileName(strFile), Path.GetExtension(strFile), ".jpg")
                newbmp.Save(strDestination, System.Drawing.Imaging.ImageFormat.Jpeg)
                originalBitmap.Dispose()
                If blnDelete Then File.Delete(strFile)

            Catch ex As Exception
                Log.Error("ResizeConvertImage failed", ex)
                Return False
            End Try
            Return True
        End Function
    End Class
End Namespace
