Imports System
Imports System.Web
Imports System.Collections.Generic
Imports System.Linq
Imports AttributeRouting.Web.Http
Imports System.Data.SqlClient
Imports System.Web.Script.Serialization
Imports log4net
Imports System.Threading
Imports System.Drawing
Imports System.IO
Imports Newtonsoft.Json
Imports System.Net
Imports System.Text
Imports System.Globalization
Imports System.Drawing.Imaging
Imports Microsoft.AspNetCore.Mvc

Namespace CalcmenuAPI
    Public Class RecipeController
        Inherits ControllerBase
        Private m_PictureNames, m_TempPictureNames, m_Videos, m_TempVideos, m_TempAttachments As String, m_Attachments As List(Of Models.RecipeAttachment), m_intCodeListe As Integer
        'Private m_strClientSerial As String
        Private arrPictures As String()
        Private arrVideos As String()
        Private Shared ReadOnly Log As ILog = LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType)

        <HttpGet> <[GET]("api/recipe/printingstatus")> _
        Public Function GetPrintingStatus() As DataTable ' PJRB-2016.06.10
            Dim _dt As New DataTable
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = <sql>
                                                SELECT * FROM EgswLabelToPrint 
                                                </sql>.Value
                                .CommandType = CommandType.Text
                                .Connection.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(_dt)

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
            End Try
            Return _dt
        End Function

        Public Function GetAllItemUnits(codeliste As Integer, _
                              codesite As Integer, _
                              codetrans As Integer, _
                              codesetprice As Integer) As List(Of Models.RecipeIngredientPriceList)
            Dim ingrUnitData As New List(Of Models.RecipeIngredientPriceList)
            Try

                Using cmd As New SqlCommand()
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Units]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = codesetprice
                                .Parameters.Add("@Type", SqlDbType.Int).Value = 2
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste

                                Dim ds As New DataSet
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                'For Each dr In ds.Tables(0).Rows
                                '    itemUnits.Add(New Models.Unit With {
                                '                    .Code = GetInt(dr("CodeUnit")), _
                                '                    .Value = GetStr(dr("UnitName")), _
                                '                    .Price = GetStr(dr("Price")), _
                                '                    .PriceUnit = GetStr(dr("PriceUnit")), _
                                '                    .PriceFactor = GetDbl(dr("PriceFactor")), _
                                '                    .IsIngredient = GetInt(dr("IsIngredient")), _
                                '                    .IsMetric = GetInt(dr("IsMetric")), _
                                '                    .IsYield = GetInt(dr("PriceFactor")), _
                                '                    .Format = GetStr(dr("Format"), "#,###.###")})
                                'Next
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
            End Try
        End Function

        <HttpGet> <[GET]("/api/recipe/{codeliste:int}/{codesite:int}/{codetrans:int}/{codesetprice:int}/{codenutrientset:int}")> _
        Public Function GetRecipe(codeliste As Integer, _
                              codesite As Integer, _
                              codetrans As Integer, _
                              codesetprice As Integer, _
                              codenutrientset As Integer, _
                              Optional codeuser As Integer = 0, Optional rolelevel As Integer = 0) As Models.RecipeData

            Dim recipedata As New Models.RecipeData
            Try
                Using cmd As New SqlCommand()
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_RecipeInfo]"
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = codesetprice
                                .Parameters.Add("@CodeNutrientSet", SqlDbType.Int).Value = codenutrientset
                                cn.Open()

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    '' Main
                                    If dr.HasRows Then
                                        Dim info As New Models.Recipe
                                        While dr.Read
                                            'Note: Formatting with output 'Double' will disregard trailing zeros. - Fix me soon
                                            With info
                                                .Type = 8
                                                .CodeListe = GetInt(dr("Code"))
                                                .Number = GetStr(dr("Number"))
                                                .Name = GetStr(dr("Name"))
                                                .SubName = GetStr(dr("SubName"))
                                                .Category = GetStr(dr("Category"))
                                                .CodeCategory = GetInt(dr("CodeCategory"))
                                                .Source = GetStr(dr("Source"))
                                                .CodeSource = GetInt(dr("CodeSource"))
                                                .Remark = GetStr(dr("Remark"))
                                                .Yield = Format(dr("Yield"), GetStr(dr("YieldUnitFormat"), "#0.###"))
                                                .YieldUnit = GetStr(dr("YieldUnit"))
                                                .CodeYieldUnit = GetInt(dr("CodeYieldUnit"))
                                                .Percent = GetInt(dr("Percent"))
                                                .Yield2 = GetDbl(Format(dr("Yield2"), GetStr(dr("YieldUnit2Format"), "#0.###")))
                                                .YieldUnit2 = GetStr(dr("YieldUnit2"))
                                                .CodeYieldUnit2 = GetInt(dr("CodeYieldUnit2"))
                                                .Description = GetStr(dr("Description"))
                                                .SrQty = GetDbl(Format(dr("SrQty"), GetStr(dr("SrUnitFormat"), "#0.###")))
                                                .SrUnit = GetStr(dr("SrUnit"))
                                                .SrUnitCode = GetInt(dr("SrUnitCode"))
                                                .CodeSite = GetInt(dr("CodeSite"))
                                                .CodeUser = GetInt(dr("CodeUser"))
                                                .CodeTrans = GetInt(dr("CodeTrans"))
                                                .DateCreated = GetStr(dr("DateCreated"))
                                                .DateLastModified = GetStr(dr("DateLastModified"))
                                                .CreatedBy = GetStr(dr("CreatedBy"))
                                                .CodeCreatedBy = GetInt(dr("CodeCreatedBy"), -1)
                                                .ModifiedBy = GetStr(dr("ModifiedBy"))
                                                .CodeModifiedBy = GetInt(dr("CodeModifiedBy"), -1)
                                                .Pictures = GetStr(dr("Pictures"))
                                                .Picture = GetStr(dr("Pictures")).Split(";").ToList()
                                                .DefaultPicture = GetInt(dr("DefaultPicture"))
                                                .Rating = GetInt(dr("Rating"))
                                                .Difficulty = GetInt(dr("Difficulty"))
                                                .Budget = GetInt(dr("Budget"))
                                                .QuickAndEasy = GetInt(dr("QuickAndEasy"))
                                                .CodeRecipeState = GetInt(dr("CodeRecipeState"))
                                                .RecipeState = GetStr(dr("RecipeState"))
                                                .Dates = GetDate(dr("Dates")).ToString("MM/dd/yyyy")
                                                .FootNote1 = GetStr(dr("FootNote1"))
                                                .FootNote2 = GetStr(dr("FootNote2"))
                                                .MethodFormat = GetStr(dr("MethodFormat"))
                                                .CoolingTime = GetStr(dr("CoolingTime"))
                                                .HeatingTime = GetStr(dr("HeatingTime"))
                                                .HeatingTemperature = GetStr(dr("HeatingTemperature"))
                                                .HeatingMode = GetStr(dr("HeatingMode"))
                                                .StoringTime = GetStr(dr("StoringTime"))
                                                .StoringTemperature = GetStr(dr("StoringTemperature"))
                                                .CCPDescription = GetStr(dr("CCPDescription"))
                                                .HACCP = GetStr(dr("HACCP")) 'ECAM - 01.25.2016 - Added HACCP
                                                .ActualIngredients = GetStr(dr("ActualIngredients"))
                                                .Ingredients = GetStr(dr("Ingredients"))
                                                .Packaging = GetStr(dr("Packaging"))
                                                .PackagingMethodCode = GetInt(dr("PackagingMethodCode"))
                                                .Certification = GetStr(dr("Certification"))
                                                .CertificationCode = GetInt(dr("RecipeCertificationCode"))
                                                .Temperature = GetStr(dr("Temperature"))
                                                .TemperatureCode = GetInt(dr("ConservationTemperatureID"))
                                                .Information = GetStr(dr("Information"))
                                                .InformationCode = GetInt(dr("InformationCode"))
                                                .IsGlobal = GetBool(dr("IsGlobal"))
                                                .WithDeclaration = GetBool(dr("WithDeclaration")) 'ECAM 11-09-2015 This field is for manor.
                                                .PriceSmallPortion = GetDbl(dr("PriceSmallPortion")) 'LLG 11.12.2015 this field is for manor
                                                .PriceLargePortion = GetDbl(dr("PriceLargePortion")) 'LLG 11.12.2015 this field is for manor
                                                .SmallPortion = GetStr(dr("SmallPortion"))
                                                .LargePortion = GetStr(dr("LargePortion"))
                                                .TestedBy = GetStr(dr("TestedBy"))
                                                .DateTested = GetDate(dr("DateTested")).ToString("MM/dd/yyyy")
                                                .CodeProductionLocation = GetInt(dr("CodeProdLoc"))
                                                .ProductionLocationName = GetStr(dr("ProductionLocationName")).ToString()
                                            End With
                                        End While
                                        recipedata.Info = info
                                    End If

                                    '' Time
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim times As New List(Of Models.RecipeTime)
                                        While dr.Read
                                            Dim time As New Models.RecipeTime With {
                                                .RecipeTimeId = GetInt(dr("RecipeTimeId")), _
                                                .RecipeTimeName = GetStr(dr("RecipeTimeName")), _
                                                .RecipeTimeHH = GetInt(dr("RecipeTimeHH")), _
                                                .RecipeTimeMM = GetInt(dr("RecipeTimeMM")), _
                                                .RecipeTimeSS = GetInt(dr("RecipeTimeSS")), _
                                                .Sequence = GetInt(dr("Sequence")), _
                                                .isTotal = GetBool(dr("isTotal"))
                                                }
                                            times.Add(time)
                                        End While
                                        recipedata.Time = times
                                    End If

                                    '' Attachment
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim attachments As New List(Of Models.RecipeAttachment)
                                        While dr.Read
                                            Dim attachment As New Models.RecipeAttachment With {
                                                .Id = GetInt(dr("Id")), _
                                                .Name = GetStr(dr("Name")), _
                                                .Resource = GetStr(dr("Resource")), _
                                                .Type = GetInt(dr("Type")), _
                                                .IsDefault = GetBool(dr("Default")) _
                                                }
                                            attachments.Add(attachment)
                                        End While
                                        recipedata.Attachment = attachments
                                    End If

                                    '' Calculation
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim calculation As New List(Of Models.RecipeCalculation)
                                        While dr.Read
                                            Dim calc As New Models.RecipeCalculation
                                            With calc
                                                .Id = GetInt(dr("Id"))
                                                .CodeListe = GetInt(dr("CodeListe"))
                                                .Coef = GetDbl(dr("Coef"))
                                                .CalcPrice = GetDbl(dr("CalcPrice"))
                                                .ImposedPrice = GetDbl(dr("ImposedPrice"))
                                                .CodeSetPrice = GetInt(dr("CodeSetPrice"))
                                                .Tax = GetInt(dr("Tax"))
                                                .TaxValue = GetDbl(dr("TaxValue"))
                                                .Packaging = GetDbl(dr("Packaging"))
                                                .PackagingFactor = GetDbl(dr("PackagingFactor"))
                                            End With
                                            calculation.Add(calc)
                                        End While
                                        recipedata.Calculation = calculation
                                    End If

                                    '' Nutrition
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim nutrients As New List(Of Models.RecipeNutrition)
                                        While dr.Read ' RBAJ-2014.01.03
                                            Dim n As New Models.RecipeNutrition With {
                                                .Id = GetInt(dr("Id")), _
                                                .Nutr_No = GetInt(dr("Nutr_No")), _
                                                .Position = GetInt(dr("Position")), _
                                                .Name = GetStr(dr("Name")), _
                                                .TagName = GetStr(dr("TagName")), _
                                                .Format = GetStr(dr("Format")), _
                                                .Value = IIf(GetDbl(dr("Value"), -1) < 0, 0, Format(GetDbl(dr("Value")), .Format)), _
                                                .Imposed = IIf(GetDbl(dr("Imposed"), -1) < 0, 0, Format(GetDbl(dr("Imposed")), .Format)), _
                                                .Percent = IIf(GetDbl(dr("Percent"), -1) < 0, 0, GetDbl(dr("Percent"))), _
                                                .Unit = GetStr(dr("Unit")), _
                                                .GDA = GetInt(dr("GDA")), _
                                                .CodeNutrientSet = GetInt(dr("CodeNutrientSet")), _
                                                .NutrientSet = GetStr(dr("NutrientSet")), _
                                                .DisplayNutrition = GetBool(dr("DisplayNutrition")), _
                                                .Display = GetBool(dr("Display")), _
                                                .ImposedType = GetInt(dr("ImposedType")), _
                                                .PortionSize = GetStr(dr("PortionSize")), _
                                                .NutritionBasis = GetStr(dr("NutritionBasis"))
                                                }
                                            nutrients.Add(n)
                                        End While
                                        recipedata.Nutrition = nutrients
                                    End If

                                    '' Ingredient Translation
                                    dr.NextResult()
                                    Dim ingredientTranslation As New List(Of Models.RecipeIngredientTranslation)
                                    If dr.HasRows Then
                                        While dr.Read
                                            ingredientTranslation.Add(
                                                New Models.RecipeIngredientTranslation With {
                                                    .ItemId = GetInt(dr("ID")), _
                                                    .CodeTrans = GetInt(dr("CodeTrans")), _
                                                    .Name = GetStr(dr("Name")), _
                                                    .Complement = GetStr(dr("Complement")), _
                                                    .Preparation = GetStr(dr("Preparation")), _
                                                    .AlternativeIngredient = GetStr(dr("AlternativeIngredient")), _
                                                    .Step = (GetInt(dr("Step"))), _
                                                    .CodeUnitDisplaySelection = GetInt(dr("CodeUnitDisplaySelection")), _
                                                    .IsGenderSensitive = GetBool(dr("IsGenderSensitive")), _
                                                    .PrefixCode = GetInt(dr("PrefixCode")), _
                                                    .PrefixGender = IIf(GetBool(dr("IsFemale")) = True, "Feminine", "Masculine")
                                                }
                                            )
                                        End While
                                    End If

                                    '' Ingredient
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim ingredient As New List(Of Models.RecipeIngredient)
                                        While dr.Read
                                            ' MKAM 2016.03.04
                                            ' .ItemQty = GetDbl(dr("ItemQty")), _
                                            ' .QuantityMetric = GetDbl(dr("QuantityMetric")), _
                                            ' .QuantityImperial = GetDbl(dr("QuantityImperial")), _
                                            ingredient.Add(
                                                New Models.RecipeIngredient With {
                                                    .CodeSetPrice = codesetprice, _
                                                    .CodeListe = codeliste, _
                                                    .CodeUser = GetInt(dr("CodeUser")), _
                                                    .ItemId = GetInt(dr("ItemId")), _
                                                    .ItemCode = GetInt(dr("ItemCode")), _
                                                    .ItemName = GetStr(dr("ItemName")), _
                                                    .ItemNumber = GetStr(dr("ItemNumber")), _
                                                    .ItemType = GetInt(dr("ItemType")), _
                                                    .ItemQty = GetDbl(Format(dr("ItemQty"), dr("ItemUnitFormat"))), _
                                                    .ItemCodeUnit = GetInt(dr("ItemCodeUnit")), _
                                                    .ItemUnit = GetStr(dr("ItemUnit")), _
                                                    .Step = GetInt(dr("Step")), _
                                                    .Position = GetInt(dr("Position")), _
                                                    .Complement = GetStr(dr("Complement")), _
                                                    .Preparation = GetStr(dr("Preparation")), _
                                                    .AlternativeIngredient = GetStr(dr("AlternativeIngredient")), _
                                                    .TmpName = GetStr(dr("TmpName")), _
                                                    .TmpQty = GetStr(dr("TmpQty")), _
                                                    .TmpUnit = GetStr(dr("TmpUnit")), _
                                                    .TmpComplement = GetStr(dr("TmpComplement")), _
                                                    .TmpPreparation = GetStr(dr("TmpPreparation")), _
                                                    .Wastage1 = GetInt(dr("Wastage1")), _
                                                    .Wastage2 = GetInt(dr("Wastage2")), _
                                                    .Wastage3 = GetInt(dr("Wastage3")), _
                                                    .Wastage4 = GetInt(dr("Wastage4")), _
                                                    .Price = GetDbl(dr("Price")), _
                                                    .PriceUnit = GetStr(dr("PriceUnit")), _
                                                    .Amount = GetDbl(dr("Amount")), _
                                                    .QuantityMetric = GetDbl(Format(GetDbl(dr("QuantityMetric")), dr("ItemUnitFormat"))), _
                                                    .CodeUnitMetric = GetInt(dr("CodeUnitMetric")), _
                                                    .UnitMetric = GetStr(dr("UnitMetric")), _
                                                    .QuantityImperial = GetDbl(Format(GetDbl(dr("QuantityImperial")), dr("ItemUnitFormat"))), _
                                                    .CodeUnitImperial = GetInt(dr("CodeUnitImperial")), _
                                                    .UnitImperial = GetStr(dr("UnitImperial")), _
                                                    .ConvertDirection = GetInt(dr("ConvertDirection")), _
                                                    .IsQuickEncode = GetBool(.ItemType = 0), _
                                                    .IsAllowMetricImperial = False, _
                                                    .ApprovalStatusCode = GetInt(dr("ApprovalStatusCode")), _
                                                    .ApprovalRequestedBy = GetInt(dr("ApprovalRequestedBy")), _
                                                    .ApprovalRequestedDate = GetStr(dr("ApprovalRequestedDate")), _
                                                    .ApprovalBy = GetInt(dr("ApprovalBy")), _
                                                    .ApprovalDate = GetStr(dr("ApprovalDate")), _
                                                    .CodeBrand = GetInt(dr("CodeBrand")), _
                                                    .Translation = IIf(GetInt(dr("ItemType")) <> 75, ingredientTranslation.Where(Function(c) c.ItemId = .ItemId).ToList(), ingredientTranslation.Where(Function(c) c.Step = .Step).ToList()), _
                                                    .CodeUnitDisplaySelection = GetInt(dr("CodeUnitDisplaySelection")), _
                                                    .CodeTrans = GetInt(dr("CodeTrans")), _
                                                    .IsGenderSensitive = GetBool(dr("IsGenderSensitive")), _
                                                    .PrefixCode = GetInt(dr("PrefixCode")), _
                                                    .PrefixGender = IIf(GetBool(dr("IsFemale")) = True, "Feminine", "Masculine"), _
                                                    .IngredientStatus = GetInt(dr("IngredientStatus")), _
                                                    .isLocked = GetBool(dr("isLocked"))
                                                }
                                            )
                                        End While
                                        recipedata.Ingredient = ingredient
                                    End If

                                    '' Procedure Translation
                                    dr.NextResult()
                                    Dim procedureTranslation As New List(Of Models.RecipeProcedureTranslation)
                                    If dr.HasRows Then
                                        While dr.Read
                                            procedureTranslation.Add(
                                                New Models.RecipeProcedureTranslation With {
                                                    .NoteId = GetInt(dr("NoteId")), _
                                                    .CodeTrans = GetInt(dr("CodeTrans")), _
                                                    .Note = GetStr(dr("Note")), _
                                                    .AbbrevNote = GetStr(dr("AbbrevNote"))
                                                    }
                                                )
                                        End While
                                    End If

                                    '' Procedure
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim procedure As New List(Of Models.RecipeProcedure)
                                        While dr.Read
                                            procedure.Add(
                                                New Models.RecipeProcedure With {
                                                    .NoteId = GetInt(dr("NoteId")), _
                                                    .Position = GetInt(dr("Position")), _
                                                    .Note = GetStr(dr("Note")), _
                                                    .AbbrevNote = GetStr(dr("AbbrevNote")), _
                                                    .Translation = procedureTranslation.Where(Function(c) c.NoteId = .NoteId).ToList(), _
                                                    .Picture = GetStr(dr("Picture")), _
                                                    .hasPicture = GetStr(dr("hasPicture"))
                                                    })
                                        End While
                                        recipedata.Procedure = procedure
                                    End If

                                    '' BrandSite
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim brandsites As New List(Of Models.RecipeBrandSite)
                                        While dr.Read
                                            Dim brandsite As New Models.RecipeBrandSite With {
                                                .Code = GetInt(dr("Codebrandsite")), _
                                                .Name = GetStr(dr("BrandSite")), _
                                                .Enabled = GetBool(dr("IsSelected")), _
                                                .DateFrom = GetDate(dr("BrandSiteDateFrom")).ToString("MM/dd/yyyy"), _
                                                .DateTo = GetDate(dr("BrandSiteDateTo")).ToString("MM/dd/yyyy"), _
                                                .HitCounter = GetInt(dr("HitCounter"))
                                            }
                                            brandsites.Add(brandsite)
                                        End While
                                        recipedata.BrandSite = brandsites
                                    End If

                                    '' Publication / Placement
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim publications As New List(Of Models.RecipePublication)
                                        While dr.Read
                                            Dim publication As New Models.RecipePublication With {
                                                .Code = GetInt(dr("Code")), _
                                                .Type = GetInt(dr("Type")), _
                                                .Name = GetStr(dr("Name")), _
                                                .Description = GetStr(dr("Description")), _
                                                .Dates = dr("Dates"), _
                                                .CodeBrandSite = GetInt(dr("Codebrandsite")), _
                                                .PlacementId = GetInt(dr("PlacementId")), _
                                                .isCurrent = GetBool(dr("isCurrent"))
                                            }
                                            publications.Add(publication)
                                        End While
                                        recipedata.Publication = publications
                                    End If

                                    '' Translation
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim translations As New List(Of Models.RecipeTranslation)
                                        While dr.Read
                                            Dim translation As New Models.RecipeTranslation With {
                                                .Id = GetInt(dr("ID")), _
                                                .CodeTrans = GetInt(dr("CodeTrans")), _
                                                .TranslationName = GetStr(dr("TranslationName")), _
                                                .Name = GetStr(dr("Name")), _
                                                .SubName = GetStr(dr("SubName")), _
                                                .Remark = GetStr(dr("Remark")), _
                                                .Description = GetStr(dr("Description")), _
                                                .Notes = GetStr(dr("Notes")), _
                                                .AdditionalNotes = GetStr(dr("AdditionalNotes")), _
                                                .CCPDescription = GetStr(dr("CCPDescription")), _
                                                .Ingredients = GetStr(dr("Ingredients")), _
                                                .HACCP = GetStr(dr("HACCP")), _
                                                .DeclarationName = GetStr(dr("DeclarationName")), _
                                                .SpecificDetermination = GetStr(dr("SpecificDetermination")), _
                                                .Verified = GetBool(dr("Verified"))
                                            }
                                            translations.Add(translation)
                                        End While
                                        recipedata.Translation = translations
                                    End If

                                    '' Comment ''LLG 11.27.2015 added Remove to trim time
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim comments As New List(Of Models.RecipeComment)
                                        While dr.Read
                                            '.SubmitDate = GetStr(dr("SubmitDate")).Remove(10, 12), _
                                            '.DateLastModified = IIf(IsDBNull(dr("DateLastModified")), "", GetStr(dr("DateLastModified")).Remove(10, 12))
                                            Dim comment As New Models.RecipeComment With {
                                                .Sequence = GetInt(dr("Sequence")), _
                                                .Owner = GetInt(dr("Owner")), _
                                                .Description = GetStr(dr("Description")), _
                                                .PostedBy = GetStr(dr("PostedBy")), _
                                                .SubmitDate = dr("SubmitDate"), _
                                                .DateLastModified = IIf(IsDBNull(dr("DateLastModified")), "", dr("DateLastModified"))
                                            }
                                            comments.Add(comment)
                                        End While
                                        recipedata.Comment = comments
                                    End If

                                    '' TODO JTOC
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim histories As New List(Of Models.RecipeHistory)
                                        While dr.Read
                                            Dim history As New Models.RecipeHistory With {
                                                .DateAudit = GetStr(dr("DateAudit")), _
                                                .FieldName = GetStr(dr("FieldName")), _
                                                .Time = GetStr(dr("Time")), _
                                                .FieldCode = GetStr(dr("FieldCode")), _
                                                .Previous = GetStr(dr("Previous")), _
                                                .HNew = GetStr(dr("New")), _
                                                .User = GetStr(dr("User")), _
                                                .AuditType = GetStr(dr("AuditType")), _
                                                .CodeListe = GetStr(dr("CodeListe")), _
                                                .CodeUser = GetStr(dr("CodeUser")), _
                                                .IsCode = GetStr(dr("IsCode"))
                                            }
                                            histories.Add(history)
                                        End While
                                        recipedata.History = histories
                                    End If

                                    '' Allergens - MKAM 2014.06.09
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim allergens As New List(Of Models.ListeAllergen)
                                        While dr.Read
                                            Dim allergen As New Models.ListeAllergen With {
                                                .CodeAllergen = GetInt(dr("CodeAllergen")),
                                                .AllergenName = GetStr(dr("Allergen")),
                                                .Contain = GetBool(dr("Contain")),
                                                .NonAllergen = GetBool(dr("NonAllergen")),
                                                .Trace = GetBool(dr("Trace")),
                                                .Derived = GetBool(dr("Derived")),
                                                .Hidden = GetBool(dr("Hidden")),
                                                .PictureName = GetStr(dr("PictureName")),
                                                .Complete = GetStr(dr("Complete")),
                                                .SwissLaw = GetStr(dr("SwLaw")),
                                                .EULaw = GetStr(dr("EuLaw"))
                                            }
                                            allergens.Add(allergen)
                                        End While
                                        recipedata.Allergen = allergens
                                    End If

                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim recipelinks As New List(Of Models.RecipeLinkList)
                                        While dr.Read
                                            Dim recipelink As New Models.RecipeLinkList With {
                                                .Code = GetInt(dr("Code")), _
                                                .Name = GetStr(dr("Name")), _
                                                .LinkDescription = GetInt(dr("LinkDescription"))
                                            }
                                            recipelinks.Add(recipelink)
                                        End While
                                        recipedata.RecipeLink = recipelinks
                                    End If

                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim proceduretemplates As New List(Of Models.ProcedureTemplateInfo)
                                        While dr.Read
                                            Dim proceduretemplate As New Models.ProcedureTemplateInfo With {
                                                .Code = GetInt(dr("Code")), _
                                                .Name = GetStr(dr("Name")), _
                                                .Global = GetBool(dr("Global"))}
                                            proceduretemplates.Add(proceduretemplate)
                                        End While
                                        recipedata.ProcedureTemplate = proceduretemplates
                                    End If

                                    'Get NutrientSetCode Default
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        dr.Read()
                                        Dim nutrientsetcode As New Integer
                                        recipedata.NutrientSetCode = GetInt(dr("NutrientSetCode"))
                                        recipedata.NutrientSetValue = GetStr(dr("NutrientSetValue"))
                                    End If

                                    'Get keyword
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim keywords As New List(Of Models.GenericTree)
                                        While dr.Read
                                            keywords.Add(New Models.GenericTree With {
                                                            .Code = GetInt(dr("Code")), _
                                                            .Name = GetStr(dr("Name")), _
                                                            .ParentCode = GetInt(dr("ParentCode")), _
                                                            .ParentName = GetStr(dr("ParentName")), _
                                                            .Flagged = GetBool(dr("Flagged")), _
                                                            .Note = GetStr(dr("Inheritable"))})
                                        End While

                                        recipedata.Keyword = keywords
                                    End If

                                    'Get Label
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim label As New Models.Label
                                        While dr.Read
                                            With label
                                                .Code = GetInt(dr("Code"))
                                                .CodeListe = GetInt(dr("CodeListe"))
                                                .DeclarationName = GetStr(dr("DeclarationName"))
                                                .SpecificDetermination = GetStr(dr("SpecificDetermination"))
                                                .Number = GetStr(dr("Number"))
                                                .Barcode = GetStr(dr("Barcode"))
                                                .Consumption = GetDbl(dr("Consumption"))
                                                .Sold = GetDbl(dr("Sold"))
                                                .Composition = GetStr(dr("Composition"))
                                                .Weight = GetDbl(dr("Weight"))
                                                .Price = GetDbl(dr("Price"))
                                                .PriceFor = GetDbl(dr("PriceFor"))
                                                .Calculated = GetDbl(dr("Calculated"))
                                                .Unit = GetInt(dr("Unit"))
                                                .Note1 = GetInt(dr("Note1"))
                                                .Note2 = GetInt(dr("Note2"))
                                                .Note3 = GetInt(dr("Note3"))
                                                .Certification = GetInt(dr("Certification"))
                                                .CountryOfProduction = GetInt(dr("CountryOfProduction"))
                                                .PackagingMethod = GetInt(dr("PackagingMethod"))
                                                .Storage = GetInt(dr("Storage"))
                                            End With
                                        End While
                                        recipedata.Label = label
                                    End If

                                    'Get Ingredient Alternative
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim ingredientalternative As New List(Of Models.IngredientAlternative)
                                        While dr.Read
                                            ingredientalternative.Add(New Models.IngredientAlternative With {
                                                            .CodelisteMain = GetInt(dr("CodelisteMain")),
                                                            .Codeliste = GetInt(dr("Codeliste")),
                                                            .IngredientName = GetStr(dr("IngredientName")),
                                                            .CodelisteAlternative = GetInt(dr("CodelisteAlternative")),
                                                            .AlternativeName = GetStr(dr("AlternativeName"))
                                                         })
                                        End While

                                        For Each ing In recipedata.Ingredient

                                            Dim alternativeingredients As New List(Of Models.IngredientAlternative)

                                            alternativeingredients = ingredientalternative.Where(Function(alting) alting.Codeliste = ing.ItemCode).ToList()
                                            ing.IngredientAlternative = New List(Of Models.IngredientAlternative)
                                            ing.IngredientAlternative.AddRange(alternativeingredients)

                                        Next
                                        recipedata.IngredientAlternative = ingredientalternative
                                    End If

                                    'Get Ingredient Alternative Translation JBQL 08192019
                                    dr.NextResult()
                                    If dr.HasRows Then
                                        Dim ingredientalternativetrans As New List(Of Models.IngredientAlternativeTranslation)
                                        While dr.Read
                                            ingredientalternativetrans.Add(New Models.IngredientAlternativeTranslation With {
                                                            .CodelisteMain = GetInt(dr("CodelisteMain")),
                                                            .Codeliste = GetInt(dr("Codeliste")),
                                                            .IngredientName = GetStr(dr("IngredientName")),
                                                            .CodelisteAlternative = GetInt(dr("CodelisteAlternative")),
                                                            .AlternativeName = GetStr(dr("AlternativeName")),
                                                            .CodeTrans = GetStr(dr("CodeTrans"))
                                                         })
                                        End While

                                        'For Each ing In recipedata.Ingredient
                                        '    For Each alting In ing.IngredientAlternative

                                        '        Dim alternativeingredientstranslation As New List(Of Models.IngredientAlternativeTranslation)
                                        '        alternativeingredientstranslation = ingredientalternativetrans.Where(Function(altingtrans) altingtrans.Codeliste = alting.Codeliste).ToList()
                                        '        'alternativeingredientstranslation = ingredientalternativetrans.Where(Function(altingtrans) altingtrans.Codeliste = alting.Codeliste And altingtrans.CodelisteAlternative = alting.CodelisteAlternative).ToList()

                                        '        Dim results = alternativeingredientstranslation.GroupBy(Function(x) x.CodeTrans).Select(Function(y) y.AsEnumerable).ToList()
                                        '        ing.IngredientAlternativeTranslation = New List(Of IEnumerable(Of Models.IngredientAlternativeTranslation))
                                        '        ing.IngredientAlternativeTranslation.AddRange(results)

                                        '    Next
                                        'Next

                                        For Each ing In recipedata.Ingredient
                                            For Each trans In ing.Translation
                                                Dim alternativeingredientstranslation As New List(Of Models.IngredientAlternativeTranslation)
                                                alternativeingredientstranslation = ingredientalternativetrans.Where(Function(altingtrans) altingtrans.Codeliste = ing.ItemCode And altingtrans.CodeTrans = trans.CodeTrans).ToList()
                                                trans.IngredientAlternativeTranslation = alternativeingredientstranslation
                                            Next
                                        Next

                                    End If

                                    dr.Close()
                                End Using
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Recipe")
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Recipe")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Recipe")
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try

            Return recipedata
        End Function

        ''' <summary>
        ''' Insert or update recipe information
        ''' </summary>
        ''' <param name="data"><c>Models.RecipeData</c></param>
        ''' <returns><c>Models.ResponseCallBack</c></returns>
        ''' <remarks></remarks>
        ''' 
        <HttpPost> <POST("api/recipe")> _
        Public Function SaveRecipe(data As Models.RecipeData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim _trans As SqlTransaction = Nothing
            Dim resultCode As Integer = 0
            Dim pictures As String = ""
            Dim arrDAMCode As New ArrayList
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Using cmd As New SqlCommand

                    ' Validation
                    If data Is Nothing Then
                        Throw (New ArgumentNullException("recipe data is empty"))
                    End If
                    If data.Info Is Nothing Then
                        Throw (New ArgumentNullException("invalid recipe data"))
                    End If

                    'm_strClientSerial = GetUserClientSerial(data.Info.CodeUser)

                    If Not data.Info.Pictures Is Nothing Then
                        arrPictures = data.Info.Pictures.Trim.Split(";")
                        If arrPictures.Length > 0 Then
                            For ctr As Integer = 0 To arrPictures.Length - 1
                                If arrPictures(ctr).Trim.Length > 0 Then
                                    If arrPictures(ctr).Trim.IndexOf("| DAM") <> -1 Then

                                        arrPictures(ctr) = arrPictures(ctr).Substring(0, arrPictures(ctr).LastIndexOf("|")).Trim

                                        arrDAMCode.Add(arrPictures(ctr).Trim().Substring(arrPictures(ctr).IndexOf("|") + 1) & "|" & (ctr + 1).ToString)
                                        arrPictures(ctr) = arrPictures(ctr).Substring(0, arrPictures(ctr).LastIndexOf("|")).Trim
                                        arrPictures(ctr) = "P" & Format(Now, "MMddyyHHmmss") & "_" & ctr & arrPictures(ctr).Substring(arrPictures(ctr).LastIndexOf(".")).Trim
                                    End If

                                End If
                            Next
                        End If
                        pictures = String.Join(";", arrPictures)
                    End If

                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try
                                If DebugEnabled Then Log.Info("Updating Main Information.")

                                Dim intCodeListe As Integer = -1
                                Dim intCodeSetPrice As Integer = 1
                                Dim intCodeUser As Integer = GetInt(data.Info.CodeModifiedBy) ' RBAJ-2013.12.19
                                ' Wait for 2 minutes for the query to execute before timing out
                                .CommandTimeout = 120

                                ''Main
                                .Connection = cn
                                .CommandText = "sp_egswListeUpdate"
                                .CommandType = CommandType.StoredProcedure

                                .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = data.Info.CodeListe
                                .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = data.Info.CodeSite
                                .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = data.Info.CodeUser
                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = data.Info.CodeTrans
                                .Parameters.Add("@intCodesetprice", SqlDbType.Int).Value = data.Info.CodeSetPrice 'LLG 01.04.2016 added codesetprice parameter
                                .Parameters.Add("@intType", SqlDbType.Int).Value = 8
                                .Parameters.Add("@nvcName", SqlDbType.NVarChar, 260).Value = Common.ReplaceSpecialCharacters(data.Info.Name)
                                .Parameters.Add("@nvcNumber", SqlDbType.NVarChar, 20).Value = Common.ReplaceSpecialCharacters(data.Info.Number)
                                .Parameters.Add("@nvcSubtitle", SqlDbType.NVarChar, 260).Value = Common.ReplaceSpecialCharacters(IIf(data.Info.SubName = Nothing, "", data.Info.SubName))
                                .Parameters.Add("@intCategory", SqlDbType.Int).Value = data.Info.CodeCategory
                                .Parameters.Add("@intSource", SqlDbType.Int).Value = data.Info.CodeSource
                                .Parameters.Add("@nvcRemark", SqlDbType.NVarChar, 1000).Value = Common.ReplaceSpecialCharacters(data.Info.Remark)
                                .Parameters.Add("@fltYield", SqlDbType.Float).Value = data.Info.Yield
                                .Parameters.Add("@intYieldUnit", SqlDbType.Int).Value = data.Info.CodeYieldUnit
                                .Parameters.Add("@sntPercent", SqlDbType.SmallInt).Value = data.Info.Percent
                                .Parameters.Add("@fltSrQty", SqlDbType.Float).Value = data.Info.SrQty
                                .Parameters.Add("@intSrUnit", SqlDbType.Int).Value = data.Info.SrUnitCode
                                .Parameters.Add("@nvcDescription", SqlDbType.NVarChar, 1000).Value = Common.ReplaceSpecialCharacters(data.Info.Description)
                                .Parameters.Add("@sdtDates", SqlDbType.SmallDateTime).Value = GetDate(data.Info.Dates)
                                .Parameters.Add("@fltSrWeight", SqlDbType.Float).Value = 0
                                .Parameters.Add("@fltYield2", SqlDbType.Float).Value = data.Info.Yield2
                                .Parameters.Add("@intYieldUnit2", SqlDbType.Int).Value = data.Info.CodeYieldUnit2
                                .Parameters.Add("@fltPortionSize", SqlDbType.Float).Value = 0
                                .Parameters.Add("@intPortionSizeUnit", SqlDbType.Int).Value = 0
                                .Parameters.Add("@bitWithDeclaration", SqlDbType.Bit).Value = data.Info.WithDeclaration 'ECAM 11-09-2015 This field is for manor.
                                .Parameters.Add("@CodeProductionLocation", SqlDbType.Int).Value = data.Info.CodeProductionLocation 'JOP 11.14.2016
                                ''Picture

                                .Parameters.Add("@nvcPictureName", SqlDbType.NVarChar, 200).Value = pictures 'JDO 2014-03-26
                                .Parameters.Add("@tntDefaultPicture", SqlDbType.TinyInt).Value = data.Info.DefaultPicture

                                ''Preparation
                                .Parameters.Add("@nvcNote", SqlDbType.NVarChar).Value = Common.ReplaceSpecialCharacters("")

                                ''HACCP, Temperature, Composition, etc.
                                .Parameters.Add("@nvcCoolingTime", SqlDbType.NVarChar, 25).Value = Common.ReplaceSpecialCharacters(data.Info.CoolingTime)
                                .Parameters.Add("@nvcHeatingTime", SqlDbType.NVarChar, 25).Value = Common.ReplaceSpecialCharacters(data.Info.HeatingTime)
                                .Parameters.Add("@nvcHeatingTemperature", SqlDbType.NVarChar, 25).Value = Common.ReplaceSpecialCharacters(data.Info.HeatingTemperature)
                                .Parameters.Add("@nvcHeatingMode", SqlDbType.NVarChar, 25).Value = Common.ReplaceSpecialCharacters(data.Info.HeatingMode)
                                .Parameters.Add("@nvcCCPDescription", SqlDbType.NVarChar, 2500).Value = Common.ReplaceSpecialCharacters(data.Info.CCPDescription)
                                .Parameters.Add("@nvcHACCP", SqlDbType.NVarChar, 4000).Value = Common.ReplaceSpecialCharacters(data.Info.HACCP) 'ECAM 01.25.2016
                                .Parameters.Add("@nvcIngredients", SqlDbType.NVarChar, 2000).Value = Common.ReplaceSpecialCharacters(data.Info.Ingredients) 'AGL 2014.11.14
                                .Parameters.Add("@nvcPreparation", SqlDbType.NVarChar, 700).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@nvcCookingTip", SqlDbType.NVarChar, 700).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@nvcRefinement", SqlDbType.NVarChar, 700).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@nvcStorage", SqlDbType.NVarChar, 700).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@nvcProductivity", SqlDbType.NVarChar, 700).Value = Common.ReplaceSpecialCharacters("")

                                ''Misc
                                .Parameters.Add("@bitProtected", SqlDbType.Bit).Value = False
                                .Parameters.Add("@intCodeLink", SqlDbType.Int).Value = 0
                                .Parameters.Add("@IsGlobal", SqlDbType.Bit).Value = data.Info.IsGlobal
                                .Parameters.Add("@bitUse", SqlDbType.Bit).Value = True
                                .Parameters.Add("@intEGSRef", SqlDbType.Int).Value = 0
                                .Parameters.Add("@intEGSID", SqlDbType.Int).Value = 0
                                .Parameters.Add("@bitCompareByCodeSite", SqlDbType.Bit).Value = False
                                .Parameters.Add("@vchCodeMergeList", SqlDbType.VarChar, 700).Value = ""
                                .Parameters.Add("@vchKeyField", SqlDbType.VarChar, 50).Value = ""
                                .Parameters.Add("@intOverwriteDescription", SqlDbType.Int).Value = 1
                                .Parameters.Add("@fltNetWeight", SqlDbType.Float).Value = 0
                                .Parameters.Add("@intTemplateCode", SqlDbType.Int).Value = 0
                                .Parameters.Add("@nvcNoteHeader", SqlDbType.NVarChar).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@bitAutoNum", SqlDbType.Bit).Value = CBool(intCodeListe > 0) ' RBAJ-2014.03.25
                                .Parameters.Add("@nvcCodeStyle", SqlDbType.NVarChar).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@sStoringTime", SqlDbType.NVarChar, 100).Value = Common.ReplaceSpecialCharacters(data.Info.StoringTime)
                                .Parameters.Add("@sStoringTemp", SqlDbType.NVarChar, 100).Value = Common.ReplaceSpecialCharacters(data.Info.StoringTemperature)
                                .Parameters.Add("@bitOnline", SqlDbType.Bit).Value = False
                                .Parameters.Add("@nvcProtectedNote", SqlDbType.NVarChar, 200).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@nvcProtectedComment", SqlDbType.NVarChar, 200).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@bAllowDuplicates", SqlDbType.Bit).Value = False
                                .Parameters.Add("@fltPriceSmallPortion", SqlDbType.Float).Value = data.Info.PriceSmallPortion 'LLG 11.12.2015 this field is for manor
                                .Parameters.Add("@fltPriceLargePortion", SqlDbType.Float).Value = data.Info.PriceLargePortion 'LLG 11.12.2015 this field is for manor
                                .Parameters.Add("@chrMethodFrmt", SqlDbType.Char, 1).Value = data.Info.MethodFormat
                                .Parameters.Add("@nvcSubHeading", SqlDbType.NVarChar, 255).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@nvcFootNote1", SqlDbType.NVarChar, 4000).Value = Common.ReplaceSpecialCharacters(data.Info.FootNote1)
                                .Parameters.Add("@nvcFootNote2", SqlDbType.NVarChar, 4000).Value = Common.ReplaceSpecialCharacters(data.Info.FootNote2)
                                .Parameters.Add("@intTemplate", SqlDbType.Int).Value = 1000
                                .Parameters.Add("@Version", SqlDbType.Int).Value = 1
                                .Parameters.Add("@Standard", SqlDbType.Int).Value = data.Info.Rating
                                .Parameters.Add("@Difficulty", SqlDbType.Int).Value = data.Info.Difficulty
                                .Parameters.Add("@Budget", SqlDbType.Int).Value = data.Info.Budget
                                '.Parameters.Add("@QuickAndEasy", SqlDbType.Bit).Value = data.Info.QuickAndEasy
                                .Parameters.Add("@QuickAndEasy", SqlDbType.Bit).Value = IIf(data.Info.QuickAndEasy = -1, Nothing, data.Info.QuickAndEasy)
                                .Parameters.Add("@ShowOff", SqlDbType.Bit).Value = False
                                .Parameters.Add("@ChefRecommended", SqlDbType.Bit).Value = False
                                .Parameters.Add("@nvcUPC", SqlDbType.NVarChar, 25).Value = Common.ReplaceSpecialCharacters("")
                                .Parameters.Add("@CostperServing", SqlDbType.Float).Value = 0
                                .Parameters.Add("@CostperRecipe", SqlDbType.Float).Value = 0
                                .Parameters.Add("@LegacyNumber", SqlDbType.NVarChar).Value = ""
                                .Parameters.Add("@ServeWith", SqlDbType.NVarChar).Value = ""
                                '.Parameters.Add("@PackagingCode", SqlDbType.Int).Value = data.Info.PackagingMethodCode
                                '.Parameters.Add("@CertificationCode", SqlDbType.Int).Value = data.Info.CertificationCode
                                '.Parameters.Add("@OriginCode", SqlDbType.Int).Value = 0
                                '.Parameters.Add("@TemperatureCode", SqlDbType.Int).Value = data.Info.TemperatureCode
                                '.Parameters.Add("@InformationCode", SqlDbType.Int).Value = data.Info.InformationCode

                                ''Not for Recipe
                                .Parameters.Add("@intBrand", SqlDbType.Int).Value = 0
                                .Parameters.Add("@intSupplier", SqlDbType.Int).Value = 0
                                .Parameters.Add("@sntWastage1", SqlDbType.SmallInt).Value = 0
                                .Parameters.Add("@sntWastage2", SqlDbType.SmallInt).Value = 0
                                .Parameters.Add("@sntWastage3", SqlDbType.SmallInt).Value = 0
                                .Parameters.Add("@sntWastage4", SqlDbType.SmallInt).Value = 0
                                .Parameters.Add("@dteMenuCardDateFrom", SqlDbType.DateTime).Value = Date.Now ' RBAJ-2013.12.18
                                .Parameters.Add("@dteMenuCardDateUntil", SqlDbType.DateTime).Value = Date.Now ' RBAJ-2013.12.18"
                                .Parameters.Add("@intMenuCardCodeSetPrice", SqlDbType.Int).Value = 0
                                .Parameters.Add("@sdtTested", SqlDbType.SmallDateTime).Value = GetDate(data.Info.DateTested)

                                ''Output Params
                                .Parameters.Add("@intCodeListeNew", SqlDbType.Int).Direction = ParameterDirection.Output
                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                _trans = cn.BeginTransaction
                                .Transaction = _trans
                                .ExecuteNonQuery()

                                intCodeListe = GetInt(.Parameters("@intCodeListeNew").Value, -1)
                                data.Info.CodeListe = intCodeListe
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Recipe update failed", resultCode))
                                End If

                                _trans.Commit()

                                ''Approver-WVM-2014.10.21
                                If data.hasApprover Then
                                    .CommandText = "sp_EgswListeApproveUpdate"
                                    .CommandType = CommandType.StoredProcedure
                                    .Parameters.Clear()
                                    .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = intCodeListe
                                    .Parameters.Add("@intRequestType", SqlDbType.Int).Value = IIf(data.Info.CodeListe > 0, 3, 2)
                                    .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = intCodeUser
                                    .Parameters.Add("@intCodeSetPrice", SqlDbType.Int).Value = 0
                                    .Parameters.Add("@fltApprovedPriceNew", SqlDbType.Int).Value = 0
                                    .Parameters.Add("@intCodeReplace", SqlDbType.Int).Value = 0
                                    .Parameters.Add("@intApproverRoleLevel", SqlDbType.Int).Value = data.NextRoleLevelApprover
                                    .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = 0
                                    .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                    .ExecuteNonQuery()
                                    resultCode = GetInt(.Parameters("@retval").Value, -1)
                                    If resultCode <> 0 Then
                                        Throw New DatabaseException(String.Format("[{0}] Update list approver failed", resultCode))
                                    End If
                                End If

                                ''Checkout recipe and update recipe status                            
                                .CommandText = "UPDATE EgswListe SET CheckOutUser=@CodeUser, RecipeState=@RecipeState, UpdatedBy=@CodeUser, LastModifiedBy=@CodeUser,TestedBy=@TestedBy, DateLastModified=GETDATE() WHERE Code=@CodeListe;"
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@RecipeState", SqlDbType.Int).Value = data.Info.CodeRecipeState
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = intCodeUser
                                .Parameters.Add("@TestedBy", SqlDbType.Int).Value = data.Info.TestedBy
                                .ExecuteNonQuery()

                                'TODO: RBAJ-2014.07.11 c/o JayR this should not be here!!!
                                'Dim intCreatedBy = GetInt(data.Info.CodeCreatedBy, -1)
                                'If intCreatedBy <= 0 Then
                                '    .CommandText = "UPDATE dbo.EgswListe SET CreatedBy=@CodeUser, DateCreated=GETDATE() WHERE Code = @CodeListe;"
                                '    .CommandType = CommandType.Text
                                '    .Parameters.Clear()
                                '    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                '    .Parameters.Add("@CodeUser", SqlDbType.Int).Value = intCodeUser
                                '    .ExecuteNonQuery()
                                'End If

                                ' Update liste history
                                .CommandText = "sp_egswListeHistoryUpdate"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@intCodeUserID", SqlDbType.Int).Value = intCodeUser ' RBAJ-2014.01.23
                                .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Update list history failed", resultCode))
                                End If

                                ''Pictures (files)
                                If data.Info.CustomTempPictures IsNot Nothing Then
                                    If data.Info.CustomTempPictures.Length > 0 Then
                                        m_PictureNames = data.Info.Pictures
                                        m_TempPictureNames = data.Info.CustomTempPictures
                                        arrPictures = pictures.Split(";")
                                        'Log.Info("arrayPictures" + arrPictures.ToString)
                                        Dim NewThread As Thread = New Thread(AddressOf SavePictures)
                                        NewThread.Priority = ThreadPriority.Lowest
                                        NewThread.Start()
                                    End If
                                End If

                                ''Time
                                If data.Time IsNot Nothing Then
                                    For Each t In data.Time
                                        .CommandText = "UPDATE_RecipeTime"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()

                                        .Parameters.Add("@RecipeID", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@RecipeTimeID", SqlDbType.Int).Value = t.RecipeTimeId
                                        .Parameters.Add("@Sequence", SqlDbType.Int).Value = t.Sequence
                                        .Parameters.Add("@ListOrderID", SqlDbType.Int).Value = t.Sequence
                                        .Parameters.Add("@RecipeTimeHH", SqlDbType.Int).Value = t.RecipeTimeHH
                                        .Parameters.Add("@RecipeTimeMM", SqlDbType.Int).Value = t.RecipeTimeMM
                                        .Parameters.Add("@RecipeTimeSS", SqlDbType.Int).Value = t.RecipeTimeSS

                                        .ExecuteNonQuery()
                                    Next
                                End If

                                ''Attachments
                                'Delete everything first
                                '// JDO-2014.04.23 Change method by creating and updating existing attachments and not deleting it
                                If data.Attachment Is Nothing OrElse data.Attachment.Count = 0 Then

                                    .CommandText = "DELETE FROM EgswListeFiles WHERE CodeListe=@CodeListe"
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()

                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .ExecuteNonQuery()
                                Else
                                    Dim arrAttachment As New ArrayList
                                    For Each attachment In data.Attachment
                                        arrAttachment.Add(attachment.Id)
                                    Next
                                    .CommandText = "DELETE FROM EgswListeFiles WHERE CodeListe=@CodeListe AND ID NOT IN (SELECT value from fn_EgswSplit(@CodeAttachment,','))"
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()

                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .Parameters.Add("@CodeAttachment", SqlDbType.NVarChar, 4000).Value = Common.Join(arrAttachment, "", "", ",")
                                    .ExecuteNonQuery()

                                    'Insert attachments
                                    For Each a In data.Attachment
                                        .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from EgswListeFiles where codeliste=@CodeListe and ID = @CodeAttachment)
                                                                BEGIN
                                                                INSERT INTO EgswListeFiles(CodeListe, [Filename], Filecaption, CodeEgsWTable, Flag, [Default]) VALUES(@CodeListe, @Filename, @Filecaption, @CodeEgsWTable, @Flagurl, @Default)
                                                                END</sql> 'AGL 2014.03.27 - Added @BrandClassification
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@CodeAttachment", SqlDbType.Int).Value = a.Id
                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@Filename", SqlDbType.NVarChar).Value = a.Resource
                                        .Parameters.Add("@Filecaption", SqlDbType.NVarChar).Value = a.Name
                                        .Parameters.Add("@CodeEgsWTable", SqlDbType.Int).Value = 50
                                        .Parameters.Add("@Flagurl", SqlDbType.Int).Value = a.Type
                                        .Parameters.Add("@Default", SqlDbType.Bit).Value = a.IsDefault

                                        .ExecuteNonQuery()
                                        .CommandText = <sql>IF EXISTS(SELECT CodeListe from EgswListeFiles where codeliste=@CodeListe and ID = @CodeAttachment)
                                                                BEGIN
                                                                    UPDATE  EgswListeFiles 
                                                                        SET [Filename] = @Filename, 
                                                                            Filecaption = @Filecaption, 
                                                                            CodeEgsWTable = @CodeEgsWTable, 
                                                                            Flag= @Flagurl, 
                                                                            [Default]= @Default 
                                                                    WHERE   CodeListe=@CodeListe 
                                                                            AND ID = @CodeAttachment
                                                                END</sql>.Value
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeAttachment", SqlDbType.Int).Value = a.Id
                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@Filename", SqlDbType.NVarChar).Value = a.Resource
                                        .Parameters.Add("@Filecaption", SqlDbType.NVarChar).Value = a.Name
                                        .Parameters.Add("@CodeEgsWTable", SqlDbType.Int).Value = 50
                                        .Parameters.Add("@Flagurl", SqlDbType.Int).Value = a.Type
                                        .Parameters.Add("@Default", SqlDbType.Bit).Value = a.IsDefault


                                        Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Saved attachment - Filename(" & a.Resource & "), FileCaption(" & a.Name & "), Default(" & a.IsDefault.ToString & ")")

                                        .ExecuteNonQuery()
                                    Next
                                End If

                                ''Attachments (files)
                                If data.Info.CustomTempAttachments IsNot Nothing AndAlso data.Info.CustomTempAttachments.Length > 0 Then
                                    m_Attachments = data.Attachment
                                    m_TempAttachments = data.Info.CustomTempAttachments
                                    m_intCodeListe = intCodeListe

                                    Dim NewThread As Thread = New Thread(AddressOf SaveAttachments)
                                    NewThread.Priority = ThreadPriority.Lowest
                                    NewThread.Start()
                                End If

                                ''Keyword
                                ''Delete everything first
                                '' JDO-2014.04.21 Change from deleting everything first to selective deletion and insertion
                                If data.Keyword Is Nothing OrElse data.Keyword.Count = 0 Then

                                    .CommandText = "DELETE FROM EgswKeyDetails WHERE CodeListe=@CodeListe"
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()

                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .ExecuteNonQuery()
                                Else
                                    Dim arrKeys As New ArrayList
                                    For Each keys In data.Keyword
                                        arrKeys.Add(keys.Code)
                                    Next
                                    .CommandText = <sql>DELETE FROM EgswKeyDetails WHERE CodeListe=@CodeListe
                                                        AND codekey not in (SELECT value from fn_EgswSplit(@CodeKey,',')) </sql>
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()

                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .Parameters.Add("@CodeKey", SqlDbType.NVarChar, 4000).Value = Common.Join(arrKeys, "", "", ",")
                                    .ExecuteNonQuery()

                                    'Insert keywords
                                    For Each k In data.Keyword
                                        .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from EgswKeyDetails where codeliste=@CodeListe and CodeKey = @CodeKey)
                                                                BEGIN
                                                                    INSERT INTO EgswKeyDetails(CodeListe, CodeKey, Derived) VALUES(@CodeListe, @CodeKey, 0)
                                                                END </sql>
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@CodeKey", SqlDbType.Int).Value = k.Code

                                        .ExecuteNonQuery()

                                    Next
                                End If

                                ''Nutrition
                                If DebugEnabled Then Log.Info("Updating Nutrition Information.")
                                If data.Nutrition IsNot Nothing AndAlso data.Nutrition.Count > 0 Then
                                    .CommandText = "[UPDATE_EgswNutrientValUpdateRecipeImposed]"
                                    .CommandType = CommandType.StoredProcedure

                                    Dim arrCodeNutrientSet As New ArrayList
                                    For Each n In data.Nutrition.OrderBy(Function(obj) obj.CodeNutrientSet).ToList()
                                        If arrCodeNutrientSet.IndexOf(n.CodeNutrientSet) = -1 Then
                                            arrCodeNutrientSet.Add(n.CodeNutrientSet)
                                        End If
                                    Next
                                    Dim _portionSize As String = "", _displayNutrition As Boolean = False, _nutritionBasis As String = "", _imposedType As Integer = 0
                                    Dim nutrition As Models.RecipeNutrition = Nothing

                                    For Each _codenutrientset In arrCodeNutrientSet
                                        nutrition = data.Nutrition.Where(Function(obj) obj.CodeNutrientSet = _codenutrientset).First()
                                        _imposedType = GetInt(nutrition.ImposedType)
                                        _displayNutrition = GetBool(nutrition.DisplayNutrition)
                                        _portionSize = Common.ReplaceSpecialCharacters(GetStr(nutrition.PortionSize))
                                        _nutritionBasis = Common.ReplaceSpecialCharacters(GetStr(nutrition.NutritionBasis))

                                        .Parameters.Clear()
                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@CodeLink", SqlDbType.VarChar, 20).Value = ""
                                        .Parameters.Add("@ImposedType", SqlDbType.SmallInt).Value = _imposedType
                                        .Parameters.Add("@PortionSize", SqlDbType.NVarChar, 255).Value = _portionSize
                                        .Parameters.Add("@DisplayNutrition", SqlDbType.Bit).Value = _displayNutrition
                                        .Parameters.Add("@NutritionBasis", SqlDbType.NVarChar, 350).Value = _nutritionBasis
                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        .Parameters.Add("@CodeSet", SqlDbType.Int).Value = _codenutrientset

                                        For Each n In data.Nutrition.Where(Function(obj) obj.CodeNutrientSet = _codenutrientset).ToList()
                                            .Parameters.Add("@N" & GetStr(n.Position), SqlDbType.Float).Value = GetDbl(n.Value, -1)
                                            .Parameters.Add("@N" & GetStr(n.Position) & "Impose", SqlDbType.Float).Value = GetDbl(n.Imposed, -1)
                                            .Parameters.Add("@N" & GetStr(n.Position) & "ImposePercent", SqlDbType.Float).Value = GetDbl(n.Percent, -1)
                                            .Parameters.Add("@N" & GetStr(n.Position) & "Display", SqlDbType.Bit).Value = GetBool(n.Display)
                                        Next

                                        .ExecuteNonQuery()
                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Update recipe imposed nutrients failed", resultCode))
                                        End If
                                    Next

                                End If

                                ''Ingredient
                                If DebugEnabled Then Log.Info("Updating Ingredient Information.")
                                _trans = cn.BeginTransaction
                                .Transaction = _trans
                                .CommandText = "sp_egswListeIngredientsGetInfo"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = data.Info.CodeTrans

                                Dim dsCurrentIngredients As New DataSet
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(dsCurrentIngredients)

                                If data.Ingredient IsNot Nothing AndAlso data.Ingredient.Count > 0 Then
                                    Dim intItemType As Integer = 0
                                    Dim intItemCode As Integer = 0
                                    Dim intCodeListeNew As Integer = 0
                                    Dim intCodeUnit As Integer = -1
                                    Dim intMetricCodeUnit As Integer = -1
                                    Dim intImperialCodeUnit As Integer = -1
                                    Dim isNewUnit As Boolean = False

                                    '' Check for deleted items
                                    If dsCurrentIngredients IsNot Nothing AndAlso dsCurrentIngredients.Tables.Count > 0 AndAlso dsCurrentIngredients.Tables(0).Rows.Count > 0 Then

                                        Dim dtIngredients As DataTable = dsCurrentIngredients.Tables(0)
                                        .CommandText = "sp_EgswDetailsDeleteItem"
                                        .CommandType = CommandType.StoredProcedure

                                        ' Get all deleted items (non Steps) and remove from the database
                                        Dim _itemID As Integer
                                        For Each dr As DataRow In dtIngredients.Select("ItemType <> 75")
                                            _itemID = GetInt(dr("itemID"))
                                            If data.Ingredient.Where(Function(s) s.ItemType <> 75 And s.ItemId = _itemID).Count = 0 Then
                                                .Parameters.Clear()
                                                .Parameters.Add("@intIDDetails", SqlDbType.Int).Value = _itemID
                                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                                .ExecuteNonQuery()
                                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                If resultCode <> 0 Then
                                                    Throw New DatabaseException(String.Format("[{0}] Delete items (non Steps) failed", resultCode))
                                                End If
                                            End If
                                        Next

                                        ' Get all deleted Steps and remove from the database
                                        Dim _step As Integer
                                        For Each dr As DataRow In dtIngredients.Select("ItemType = 75")
                                            _step = GetInt(dr("Step"))
                                            If data.Ingredient.Where(Function(s) s.ItemType = 75 And s.ItemId = _itemID).Count = 0 Then
                                                .Parameters.Clear()
                                                .Parameters.Add("@intIDDetails", SqlDbType.Int).Value = -1
                                                .Parameters.Add("@intStep", SqlDbType.Int).Value = _step
                                                .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                                .ExecuteNonQuery()
                                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                If resultCode <> 0 Then
                                                    Throw New DatabaseException(String.Format("[{0}] Delete step items failed", resultCode))
                                                End If
                                            End If
                                        Next

                                    End If

                                    '' Update ingredients
                                    Dim _detailID As Integer = 0
                                    For Each ingredient As Models.RecipeIngredient In data.Ingredient.Where(Function(s) s.ItemType <> 75)
                                        intItemType = GetInt(ingredient.ItemType)
                                        intItemCode = GetInt(ingredient.ItemCode)
                                        intCodeUnit = GetInt(ingredient.ItemCodeUnit, -1)
                                        intMetricCodeUnit = GetInt(ingredient.CodeUnitMetric, -1)
                                        intImperialCodeUnit = GetInt(ingredient.CodeUnitImperial, -1)
                                        isNewUnit = GetBool(intCodeUnit < 0)

                                        '' Add Text item if new
                                        If (intItemType = 4) And intItemCode = -1 Then
                                            .CommandText = "sp_egswListeUpdate"
                                            .CommandType = CommandType.StoredProcedure
                                            .Parameters.Clear()
                                            .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = -1
                                            .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = data.Info.CodeSite
                                            .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = data.Info.CodeUser
                                            .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = data.Info.CodeTrans
                                            .Parameters.Add("@intType", SqlDbType.Int).Value = intItemType
                                            .Parameters.Add("@nvcName", SqlDbType.NVarChar, 260).Value = IIf(intItemType = 0, ingredient.TmpName, ingredient.ItemName)

                                            ''Not for Texts                                      
                                            .Parameters.Add("@nvcNumber", SqlDbType.NVarChar, 20).Value = String.Empty
                                            .Parameters.Add("@nvcSubtitle", SqlDbType.NVarChar, 260).Value = String.Empty
                                            .Parameters.Add("@intCategory", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@intSource", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@nvcRemark", SqlDbType.NVarChar, 250).Value = String.Empty
                                            .Parameters.Add("@fltYield", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@intYieldUnit", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@sntPercent", SqlDbType.SmallInt).Value = 0
                                            .Parameters.Add("@fltSrQty", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@intSrUnit", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@nvcDescription", SqlDbType.NVarChar, 800).Value = String.Empty
                                            .Parameters.Add("@sdtDates", SqlDbType.SmallDateTime).Value = DateTime.Now
                                            .Parameters.Add("@fltSrWeight", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@fltYield2", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@intYieldUnit2", SqlDbType.Int).Value = DBNull.Value
                                            .Parameters.Add("@fltPortionSize", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@intPortionSizeUnit", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@nvcPictureName", SqlDbType.NVarChar, 200).Value = String.Empty
                                            .Parameters.Add("@tntDefaultPicture", SqlDbType.TinyInt).Value = 0
                                            .Parameters.Add("@nvcNote", SqlDbType.NVarChar).Value = String.Empty
                                            .Parameters.Add("@nvcCoolingTime", SqlDbType.NVarChar, 25).Value = String.Empty
                                            .Parameters.Add("@nvcHeatingTime", SqlDbType.NVarChar, 25).Value = String.Empty
                                            .Parameters.Add("@nvcHeatingTemperature", SqlDbType.NVarChar, 25).Value = String.Empty
                                            .Parameters.Add("@nvcHeatingMode", SqlDbType.NVarChar, 25).Value = String.Empty
                                            .Parameters.Add("@nvcCCPDescription", SqlDbType.NVarChar, 2500).Value = String.Empty
                                            .Parameters.Add("@nvcHACCP", SqlDbType.NVarChar, 4000).Value = String.Empty
                                            .Parameters.Add("@nvcIngredients", SqlDbType.NVarChar, 2000).Value = String.Empty
                                            .Parameters.Add("@nvcPreparation", SqlDbType.NVarChar, 2000).Value = String.Empty
                                            .Parameters.Add("@nvcCookingTip", SqlDbType.NVarChar, 700).Value = String.Empty
                                            .Parameters.Add("@nvcRefinement", SqlDbType.NVarChar, 700).Value = String.Empty
                                            .Parameters.Add("@nvcStorage", SqlDbType.NVarChar, 700).Value = String.Empty
                                            .Parameters.Add("@nvcProductivity", SqlDbType.NVarChar, 700).Value = String.Empty
                                            .Parameters.Add("@bitProtected", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@intCodeLink", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@IsGlobal", SqlDbType.Bit).Value = 0
                                            .Parameters.Add("@bitUse", SqlDbType.Bit).Value = True
                                            .Parameters.Add("@intEGSRef", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@intEGSID", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@bitCompareByCodeSite", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@vchCodeMergeList", SqlDbType.VarChar, 700).Value = String.Empty
                                            .Parameters.Add("@vchKeyField", SqlDbType.VarChar, 50).Value = String.Empty
                                            .Parameters.Add("@intOverwriteDescription", SqlDbType.Int).Value = 1
                                            .Parameters.Add("@fltNetWeight", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@intTemplateCode", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@nvcNoteHeader", SqlDbType.NVarChar).Value = String.Empty
                                            .Parameters.Add("@bitAutoNum", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@nvcCodeStyle", SqlDbType.NVarChar).Value = String.Empty
                                            .Parameters.Add("@sStoringTime", SqlDbType.NVarChar, 100).Value = String.Empty
                                            .Parameters.Add("@sStoringTemp", SqlDbType.NVarChar, 100).Value = String.Empty
                                            .Parameters.Add("@bitOnline", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@nvcProtectedNote", SqlDbType.NVarChar, 200).Value = String.Empty
                                            .Parameters.Add("@nvcProtectedComment", SqlDbType.NVarChar, 200).Value = String.Empty
                                            .Parameters.Add("@bAllowDuplicates", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@fltPriceSmallPortion", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@fltPriceLargePortion", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@chrMethodFrmt", SqlDbType.Char, 1).Value = String.Empty
                                            .Parameters.Add("@nvcSubHeading", SqlDbType.NVarChar, 255).Value = String.Empty
                                            .Parameters.Add("@nvcFootNote1", SqlDbType.NVarChar, 4000).Value = String.Empty
                                            .Parameters.Add("@nvcFootNote2", SqlDbType.NVarChar, 4000).Value = String.Empty
                                            .Parameters.Add("@intTemplate", SqlDbType.Int).Value = 1000
                                            .Parameters.Add("@Version", SqlDbType.Int).Value = 1
                                            .Parameters.Add("@Standard", SqlDbType.Int).Value = DBNull.Value
                                            .Parameters.Add("@Difficulty", SqlDbType.Int).Value = DBNull.Value
                                            .Parameters.Add("@Budget", SqlDbType.Int).Value = DBNull.Value
                                            .Parameters.Add("@QuickAndEasy", SqlDbType.Bit).Value = DBNull.Value
                                            .Parameters.Add("@ShowOff", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@ChefRecommended", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@nvcUPC", SqlDbType.NVarChar, 25).Value = String.Empty
                                            .Parameters.Add("@CostperServing", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@CostperRecipe", SqlDbType.Float).Value = 0
                                            .Parameters.Add("@LegacyNumber", SqlDbType.NVarChar).Value = String.Empty
                                            .Parameters.Add("@ServeWith", SqlDbType.NVarChar).Value = String.Empty
                                            .Parameters.Add("@PackagingCode", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@CertificationCode", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@OriginCode", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@TemperatureCode", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@InformationCode", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@intBrand", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@intSupplier", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@sntWastage1", SqlDbType.SmallInt).Value = 0
                                            .Parameters.Add("@sntWastage2", SqlDbType.SmallInt).Value = 0
                                            .Parameters.Add("@sntWastage3", SqlDbType.SmallInt).Value = 0
                                            .Parameters.Add("@sntWastage4", SqlDbType.SmallInt).Value = 0
                                            .Parameters.Add("@dteMenuCardDateFrom", SqlDbType.DateTime).Value = Date.Now ' RBAJ-2013.12.18
                                            .Parameters.Add("@dteMenuCardDateUntil", SqlDbType.DateTime).Value = Date.Now ' RBAJ-2013.12.18
                                            .Parameters.Add("@intMenuCardCodeSetPrice", SqlDbType.Int).Value = 0

                                            ''Output Params
                                            .Parameters.Add("@intCodeListeNew", SqlDbType.Int).Direction = ParameterDirection.Output
                                            .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                            .ExecuteNonQuery()
                                            resultCode = GetInt(.Parameters("@retval").Value, -1)
                                            If resultCode = -3 Or resultCode = 0 Then
                                                intItemCode = GetInt(.Parameters("@intCodeListeNew").Value)
                                            ElseIf resultCode <> 0 Then
                                                Throw New DatabaseException(String.Format("[{0}] Add text ingredients failed", resultCode))
                                            End If

                                        End If

                                        '' Update/add ingredient unit                                    
                                        If (intItemType = 2 Or intItemType = 8) Then

                                            If intCodeUnit < 0 Then
                                                'Check first if unit already exist
                                                .CommandType = CommandType.StoredProcedure
                                                .CommandText = "sp_EgswUnitGetList"
                                                .Parameters.Clear()
                                                .Parameters.Add("@intCode", SqlDbType.Int).Value = -1
                                                .Parameters.Add("@tntType", SqlDbType.TinyInt).Value = intItemType
                                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = data.Info.CodeTrans
                                                .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = data.Info.CodeSite
                                                .Parameters.Add("@intCodeProperty", SqlDbType.Int).Value = -1
                                                .Parameters.Add("@Status", SqlDbType.TinyInt).Value = 255
                                                .Parameters.Add("@vchName", SqlDbType.NVarChar, 32).Value = GetStr(ingredient.ItemUnit).Trim()
                                                .Parameters.Add("@IsYield", SqlDbType.Int).Value = DBNull.Value
                                                .Parameters.Add("@IsIngredient", SqlDbType.Int).Value = DBNull.Value
                                                .Parameters.Add("@IsStock", SqlDbType.Int).Value = DBNull.Value
                                                .Parameters.Add("@IsTransportation", SqlDbType.Int).Value = DBNull.Value
                                                .Parameters.Add("@IsPackaging", SqlDbType.Int).Value = DBNull.Value

                                                Using dr As SqlDataReader = .ExecuteReader()
                                                    dr.Read()
                                                    If dr.HasRows Then
                                                        intCodeUnit = GetInt(dr("Code"), -1)
                                                    End If
                                                    dr.Close()
                                                End Using

                                                If intCodeUnit < 0 Then ' Add as new unit
                                                    Dim strUnit As String = GetStr(ingredient.ItemUnit).Trim()
                                                    .CommandText = "sp_EgswUnitUpdate"
                                                    .CommandType = CommandType.StoredProcedure
                                                    .Parameters.Clear()
                                                    .Parameters.Add("@retval", SqlDbType.Int)
                                                    .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = data.Info.CodeModifiedBy
                                                    .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = data.Info.CodeSite
                                                    .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeUnit
                                                    .Parameters.Add("@nvcNameDef", SqlDbType.NVarChar, 32).Value = strUnit
                                                    .Parameters.Add("@nvcNamePlural", SqlDbType.NVarChar, 32).Value = strUnit
                                                    .Parameters.Add("@nvcNameDisp", SqlDbType.NVarChar, 32).Value = strUnit
                                                    .Parameters.Add("@nvcAutoConversion", SqlDbType.NVarChar, 500).Value = strUnit
                                                    .Parameters.Add("@IsBasic", SqlDbType.Bit).Value = False
                                                    .Parameters.Add("@IsStock", SqlDbType.Bit).Value = False
                                                    .Parameters.Add("@IsPackaging", SqlDbType.Bit).Value = False
                                                    .Parameters.Add("@IsTranspo", SqlDbType.Bit).Value = False
                                                    .Parameters.Add("@IsIngredient", SqlDbType.Bit).Value = True
                                                    .Parameters.Add("@IsYield", SqlDbType.Bit).Value = False
                                                    .Parameters.Add("@IsServing", SqlDbType.Bit).Value = False
                                                    .Parameters.Add("@fltFactor", SqlDbType.Float).Value = 1
                                                    .Parameters.Add("@intTypeMain", SqlDbType.Int).Value = 0
                                                    .Parameters.Add("@IsMetric", SqlDbType.Bit).Value = True
                                                    .Parameters.Add("@nvcFormat", SqlDbType.NVarChar, 15).Value = "#,##0.000"
                                                    .Parameters.Add("@IsAdded", SqlDbType.Bit).Value = True
                                                    .Parameters.Add("@intPosition", SqlDbType.Int).Value = 0
                                                    .Parameters.Add("@IsGlobal", SqlDbType.Bit).Value = 1
                                                    .Parameters.Add("@bitUseMakes", SqlDbType.Bit).Value = False ' RDC 07.30.2013 : Use Makes [nth] [Unit] or  Ingredients for [nth] [Unit]
                                                    .Parameters.Add("@tntTranMode", SqlDbType.TinyInt).Value = 1 ' @TRAN_ADD
                                                    .Parameters.Add("@vchCodeSiteList", SqlDbType.VarChar, 8000).Value = "(" + data.Info.CodeSite.ToString + ")"
                                                    .Parameters("@intCode").Direction = ParameterDirection.InputOutput
                                                    .Parameters("@retval").Direction = ParameterDirection.ReturnValue
                                                    .ExecuteNonQuery()

                                                    intCodeUnit = GetInt(.Parameters("@intCode").Value, -1)
                                                    resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                    If resultCode <> 0 Then
                                                        Throw New DatabaseException(String.Format("[{0}] Update ingredient unit failed", resultCode))
                                                    End If

                                                    If isNewUnit AndAlso intCodeUnit >= 0 Then
                                                        ' Get last set price position
                                                        Dim intPosition As Integer = 0
                                                        .CommandText = "SELECT @Pos = ISNULL(MAX(Position), 0) FROM dbo.EgswListeSetPrice WHERE CodeListe = @CodeListe"
                                                        .CommandType = CommandType.Text
                                                        .Parameters.Clear()
                                                        .Parameters.Add("@Pos", SqlDbType.Int).Direction = ParameterDirection.Output
                                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intItemCode
                                                        .ExecuteNonQuery()
                                                        intPosition = GetInt(.Parameters("@Pos").Value, 0)

                                                        ' Update price of merchandise/recipe
                                                        .CommandText = "sp_egswListeSetPriceUpdate"
                                                        .CommandType = CommandType.StoredProcedure
                                                        .Parameters.Clear()
                                                        .Parameters.Add("@intID", SqlDbType.Int).Value = -1
                                                        .Parameters.Add("@intCodeSetPrice", SqlDbType.Int).Value = 1
                                                        .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = intItemCode
                                                        .Parameters.Add("@intCodeUnit", SqlDbType.Int).Value = intCodeUnit
                                                        .Parameters.Add("@fltPrice", SqlDbType.Float).Value = 0
                                                        .Parameters.Add("@intPosition", SqlDbType.Int).Value = intPosition + 1
                                                        .Parameters.Add("@fltRatio", SqlDbType.Float).Value = 0
                                                        .Parameters.Add("@fltRatioNut", SqlDbType.Float).Value = 0
                                                        .Parameters.Add("@vchFnc", SqlDbType.VarChar, 20).Value = "UPDATEPRICE"
                                                        .Parameters.Add("@intTax", SqlDbType.Int).Value = 0
                                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                                        .ExecuteNonQuery()
                                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                        If resultCode <> 0 Then
                                                            Throw New DatabaseException(String.Format("[{0}] Update ingredient setprice failed", resultCode))
                                                        End If

                                                        ' Update unit translation
                                                        .CommandText = "sp_EgswItemTranslationUpdate"
                                                        .CommandType = CommandType.StoredProcedure
                                                        .Parameters.Clear()
                                                        .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeUnit
                                                        .Parameters.Add("@nvcName", SqlDbType.NVarChar, 260).Value = strUnit
                                                        .Parameters.Add("@nvcName2", SqlDbType.NVarChar, 150).Value = strUnit 'MRC - 08.07.08 - For Ducasse customization.
                                                        .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = data.Info.CodeTrans
                                                        .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = data.Info.CodeSite
                                                        .Parameters.Add("@tntListType", SqlDbType.Int).Value = 3
                                                        .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = data.Info.CodeModifiedBy
                                                        .Parameters.Add("@tntType", SqlDbType.Int).Value = 0
                                                        .Parameters.Add("@nvcPlural", SqlDbType.NVarChar, 150).Value = ""
                                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                                        .ExecuteNonQuery()
                                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                        If resultCode <> 0 Then
                                                            Throw New DatabaseException(String.Format("[{0}] Update unit translation failed", resultCode))
                                                        End If

                                                        ''2017.01.20 Added this SP in sp_egswListeSetPriceUpdate
                                                        '' Recompute rationut
                                                        '.CommandText = "sp_EgswListeSetPriceUpdateRecomputeRatioNut"
                                                        '.CommandType = CommandType.StoredProcedure
                                                        '.Parameters.Clear()
                                                        '.Parameters.Add("@intCodeListe", SqlDbType.Float).Value = intItemCode
                                                        '.Parameters.Add("@SelectedCodeSetPrice", SqlDbType.Int).Value = -1
                                                        '.Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                                        '.ExecuteNonQuery()
                                                        'resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                        'If resultCode <> 0 Then
                                                        '    Throw New DatabaseException(String.Format("[{0}] Recompute ingredient setprice failed", resultCode))
                                                        'End If
                                                    End If

                                                End If
                                            End If

                                            If ingredient.Price <> CStr(GetDbl(ingredient.Price)) Then
                                                Log.Warn("Price Format Warning: " & ingredient.Price & "; GetDbl()=" & GetDbl(ingredient.Price))
                                            End If

                                            'MKAM 2016.02.06 - disable for now
                                            ''NBG 12.1.2015 adding for manor
                                            'start
                                            'Update price of merchandise/recipe
                                            'If ingredient.Price <> ingredient.OrigPrice Then 'Comment Remove price update of merchandise from ingredient
                                            '    .CommandText = "sp_EgswListeSetPriceUpdateMerch"
                                            '    .CommandType = CommandType.StoredProcedure
                                            '    .Parameters.Clear()
                                            '    .Parameters.Add("@intCodeSetPrice", SqlDbType.Int).Value = intCodeListe
                                            '    .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = intItemCode
                                            '    .Parameters.Add("@CodeSetprice", SqlDbType.Int).Value = data.Info.CodeSetPrice 'LLG 01.04.2016 added codesetprice parameter
                                            '    .Parameters.Add("@intCodeUnit", SqlDbType.Int).Value = intCodeUnit
                                            '    .Parameters.Add("@fltPrice", SqlDbType.Float).Value = GetDbl(ingredient.Price)  'IIf(ingredient.Price Is Nothing, 0, ingredient.Price)
                                            '    .Parameters.Add("@vchFnc", SqlDbType.VarChar, 20).Value = "UPDATEPRICE"
                                            '    .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                            '    .ExecuteNonQuery()
                                            '    resultCode = GetInt(.Parameters("@retval").Value, -1)
                                            '    If resultCode <> 0 Then
                                            '        Throw New DatabaseException(String.Format("[{0}] Update ingredient setprice failed", resultCode))
                                            '    End If
                                            'End If

                                        End If

                                        '' Recompute rationut
                                        '.CommandText = "sp_EgswListeSetPriceUpdateRecomputeRatioNut"
                                        '.CommandType = CommandType.StoredProcedure
                                        '.Parameters.Clear()
                                        '.Parameters.Add("@intCodeListe", SqlDbType.Float).Value = intCodeListe
                                        '.Parameters.Add("@SelectedCodeSetPrice", SqlDbType.Int).Value = -1
                                        '.Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        '.ExecuteNonQuery()
                                        'resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        'If resultCode <> 0 Then
                                        '    Throw New DatabaseException(String.Format("[{0}] Recompute ingredient setprice failed", resultCode))
                                        'End If
                                        'end


                                        If DebugEnabled Then Log.Info("Updating Ingredient Information - " & intItemCode)
                                        '' Update/insert details
                                        .CommandText = "sp_EgswDetailsUpdate"
                                        .CommandType = CommandType.StoredProcedure

                                        .Parameters.Clear()
                                        .Parameters.Add("@intID", SqlDbType.Int).Direction = ParameterDirection.InputOutput
                                        .Parameters("@intID").Value = ingredient.ItemId
                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue

                                        .Parameters.Add("@intFirstCode", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@intSecondCode", SqlDbType.Int).Value = IIf(intItemCode = -1, 0, intItemCode)
                                        .Parameters.Add("@intPosition", SqlDbType.Int).Value = GetInt(ingredient.Position)
                                        .Parameters.Add("@intStep", SqlDbType.Int).Value = GetInt(ingredient.Step)

                                        .Parameters.Add("@fltQuantity", SqlDbType.Float).Value = GetDbl(ingredient.ItemQty)
                                        .Parameters.Add("@intCodeUnit", SqlDbType.Int).Value = GetInt(IIf(intCodeUnit < 0, 0, intCodeUnit))

                                        .Parameters.Add("@nvcComplement", SqlDbType.NVarChar, 2000).Value = GetStr(ingredient.Complement)
                                        .Parameters.Add("@nvcPreparation", SqlDbType.NVarChar, 2000).Value = GetStr(ingredient.Preparation)
                                        .Parameters.Add("@AlternativeIngredient", SqlDbType.NVarChar, 300).Value = GetStr(ingredient.AlternativeIngredient)
                                        .Parameters.Add("@intWastage1", SqlDbType.Int).Value = GetInt(ingredient.Wastage1)
                                        .Parameters.Add("@intWastage2", SqlDbType.Int).Value = GetInt(ingredient.Wastage2)
                                        .Parameters.Add("@intWastage3", SqlDbType.Int).Value = GetInt(ingredient.Wastage3)
                                        .Parameters.Add("@intWastage4", SqlDbType.Int).Value = GetInt(ingredient.Wastage4)
                                        .Parameters.Add("@blnIsQuickEncode", SqlDbType.Bit).Value = (intItemType = 0)

                                        If (intItemType = 0) Then
                                            .Parameters.Add("@nvcTmpQty", SqlDbType.NVarChar, 25).Value = GetStr(ingredient.TmpQty)
                                            .Parameters.Add("@nvcTmpUnit", SqlDbType.NVarChar, 25).Value = GetStr(ingredient.TmpUnit)
                                            .Parameters.Add("@nvcTmpName", SqlDbType.NVarChar, 260).Value = GetStr(ingredient.TmpName)
                                            .Parameters.Add("@nvcTmpComplement", SqlDbType.NVarChar, 2000).Value = GetStr(ingredient.TmpComplement)
                                            .Parameters.Add("@nvcTmpPreparation", SqlDbType.NVarChar, 2000).Value = GetStr(ingredient.TmpPreparation)
                                        End If

                                        'For approval
                                        .Parameters.Add("@intApprovalStatusCode", SqlDbType.Int).Value = GetInt(ingredient.ApprovalStatusCode)
                                        .Parameters.Add("@intApprovalRequestedBy", SqlDbType.Int).Value = GetInt(ingredient.ApprovalRequestedBy)
                                        .Parameters.Add("@dtApprovalRequestedDate", SqlDbType.DateTime).Value = GetDate(ingredient.ApprovalRequestedDate)

                                        .Parameters.Add("@IsAllowMetricImperial", SqlDbType.Bit).Value = GetBool(ingredient.IsAllowMetricImperial)
                                        .Parameters.Add("@fltQuantityMetric", SqlDbType.Float).Value = GetDbl(ingredient.QuantityMetric)
                                        .Parameters.Add("@intCodeUnitMetric", SqlDbType.Int).Value = GetInt(IIf(intMetricCodeUnit < 0, 0, intMetricCodeUnit))
                                        .Parameters.Add("@fltQuantityImperial", SqlDbType.Float).Value = GetDbl(ingredient.QuantityImperial)
                                        .Parameters.Add("@intCodeUnitImperial", SqlDbType.Int).Value = GetInt(IIf(intImperialCodeUnit < 0, 0, intImperialCodeUnit))
                                        .Parameters.Add("@intConvertDirection", SqlDbType.Int).Value = GetInt(ingredient.ConvertDirection)

                                        'Required by storedproc but not needed for recipe
                                        .Parameters.Add("@fltCoeff", SqlDbType.Float).Value = 0
                                        .Parameters.Add("@fltMenuCardApprovedPriceNew", SqlDbType.Float).Value = 0
                                        .Parameters.Add("@fltMenuCardCostPrice", SqlDbType.Float).Value = 0
                                        .Parameters.Add("@FreakOutMoment", SqlDbType.Bit).Value = 0

                                        .Parameters.Add("@CodeUnitDisplaySelection", SqlDbType.Int).Value = ingredient.CodeUnitDisplaySelection

                                        .ExecuteNonQuery()

                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Update recipe ingredients failed", resultCode))
                                        End If

                                        '' Get current/new detail id
                                        If ingredient.ItemId <= 0 Then
                                            _detailID = GetInt(.Parameters("@intID").Value)
                                        Else
                                            _detailID = ingredient.ItemId
                                        End If

                                        '' Ingredient Translation
                                        If ingredient.Translation IsNot Nothing AndAlso ingredient.Translation.Count > 0 AndAlso (ingredient.ItemType = 2 Or ingredient.ItemType = 8) Then
                                            .CommandText = "sp_egswDetailsTranslationUpdate"
                                            .CommandType = CommandType.StoredProcedure
                                            For Each item As Models.RecipeIngredientTranslation In ingredient.Translation
                                                .Parameters.Clear()
                                                .Parameters.Add("@intIDDetails", SqlDbType.Int).Value = _detailID
                                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = item.CodeTrans
                                                .Parameters.Add("@nvcComplement", SqlDbType.NVarChar, 2000).Value = ReplaceSpecialCharacters(item.Complement)
                                                .Parameters.Add("@nvcPreparation", SqlDbType.NVarChar, 2000).Value = ReplaceSpecialCharacters(item.Preparation)
                                                .Parameters.Add("@nvcTip", SqlDbType.NVarChar, 4000).Value = String.Empty
                                                .Parameters.Add("@nvcName", SqlDbType.NVarChar, 260).Value = ReplaceSpecialCharacters(item.Name)
                                                .Parameters.Add("@nvcAlternativeIngredient", SqlDbType.NVarChar, 2000).Value = ReplaceSpecialCharacters(item.AlternativeIngredient)
                                                .Parameters.Add("@CodeUnitDisplaySelection", SqlDbType.Int).Value = item.CodeUnitDisplaySelection
                                                .Parameters.Add("@CodePrefix", SqlDbType.Int).Value = item.PrefixCode
                                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                                .ExecuteNonQuery()
                                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                If resultCode <> 0 Then
                                                    Throw New DatabaseException(String.Format("[{0}] Update recipe ingredient translation failed", resultCode))
                                                End If
                                            Next

                                        ElseIf ingredient.Translation IsNot Nothing AndAlso ingredient.Translation.Count > 0 AndAlso (ingredient.ItemType = 4) Then
                                            ''WVM-2015-10.28-BEGIN
                                            'Update Text Translation
                                            For Each item As Models.RecipeIngredientTranslation In ingredient.Translation
                                                .Parameters.Clear()
                                                .CommandText = "sp_EgswTextTranslationUpdate"
                                                .CommandType = CommandType.StoredProcedure
                                                .Parameters.Clear()
                                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                                .Parameters.Add("@intIDDetails", SqlDbType.Int).Value = _detailID
                                                .Parameters.Add("@nvcName", SqlDbType.NVarChar).Value = item.Name
                                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = item.CodeTrans

                                                Try
                                                    .ExecuteNonQuery()
                                                Catch ex As Exception
                                                    Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Error in Text Translation Update. Current Parameter Count: " & .Parameters.Count.ToString, ex)
                                                End Try

                                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                If resultCode <> 0 Then
                                                    Throw New DatabaseException(String.Format("[{0}] Update recipe texts translation failed", resultCode))
                                                End If
                                            Next
                                            ''WVM-2015-10.28-END.
                                        End If

                                        '' Details set price
                                        If data.Calculation IsNot Nothing Then
                                            .CommandText = "sp_egswDetailSetPriceUpdate"
                                            .CommandType = CommandType.StoredProcedure
                                            For Each calc In data.Calculation
                                                intCodeSetPrice = GetInt(calc.CodeSetPrice, 1) ' RBAJ-2013.12.18
                                                .Parameters.Clear()
                                                .Parameters.Add("@intIDDetails", SqlDbType.Int).Value = _detailID
                                                .Parameters.Add("@intFirstCodeSetPrice", SqlDbType.Int).Value = intCodeSetPrice
                                                .Parameters.Add("@intSecondCodeSetPrice", SqlDbType.Int).Value = intCodeSetPrice
                                                .Parameters.Add("@fltConst", SqlDbType.Float).Value = calc.Coef
                                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                                .ExecuteNonQuery()
                                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                If resultCode <> 0 Then
                                                    Throw New DatabaseException(String.Format("[{0}] Update recipe details price failed", resultCode))
                                                End If
                                            Next
                                        End If

                                        ''Update Pictures/Videos -WVM-2014.11.11-BEGIN
                                        If ingredient.Pictures IsNot Nothing Or ingredient.Videos IsNot Nothing Then
                                            .CommandText = "[dbo].[API_UPDATE_ListeFiles]"
                                            .CommandType = CommandType.StoredProcedure
                                            .Parameters.Clear()
                                            .Parameters.Add("@FirstCode", SqlDbType.Int).Value = intCodeListe
                                            .Parameters.Add("@SecondCode", SqlDbType.Int).Value = intItemCode
                                            .Parameters.Add("@Type", SqlDbType.Int).Value = ingredient.ItemType
                                            .Parameters.Add("@Pictures", SqlDbType.NVarChar).Value = ingredient.Pictures
                                            .Parameters.Add("@Videos", SqlDbType.NVarChar).Value = ingredient.Videos
                                            .ExecuteNonQuery()
                                        End If

                                        'Save Picture
                                        m_PictureNames = ingredient.Pictures
                                        m_TempPictureNames = ingredient.tempPictures
                                        arrPictures = ingredient.Pictures.Split(";")
                                        'Log.Info("arrayPictures" + arrPictures.ToString)
                                        Dim NewThreadPic As Thread = New Thread(AddressOf SavePictures)
                                        NewThreadPic.Priority = ThreadPriority.Lowest
                                        NewThreadPic.Start()

                                        'Save Video
                                        m_Videos = ingredient.Videos
                                        m_TempVideos = ingredient.tempVideos
                                        arrVideos = ingredient.Videos.Split(";")
                                        'Log.Info("arrayPictures" + arrVideos.ToString)
                                        Dim NewThreadVideo As Thread = New Thread(AddressOf SaveVideos)
                                        NewThreadVideo.Priority = ThreadPriority.Lowest
                                        NewThreadVideo.Start()
                                        ''-WVM-2014.11.11-END.

                                    Next

                                    For Each ingredient As Models.RecipeIngredient In data.Ingredient.Where(Function(s) s.ItemType <> 75)
                                        intItemType = GetInt(ingredient.ItemType)
                                        intItemCode = GetInt(ingredient.ItemCode)
                                        'LLG 01.21.2016 for recalculation sub recipe
                                        'start
                                        'Update price of sub recipe
                                        If intItemType = 8 Then
                                            .CommandText = "sp_egswListeRecipeSubRecipesRecomputePricePerSetPrice"
                                            .CommandType = CommandType.StoredProcedure
                                            .Parameters.Clear()
                                            .Parameters.Add("@intCode", SqlDbType.Int).Value = intItemCode
                                            .Parameters.Add("@intCodeSetprice", SqlDbType.Int).Value = data.Info.CodeSetPrice
                                            .Parameters.Add("@bitUpdateNutrient", SqlDbType.Bit).Value = 0
                                            .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                            .ExecuteNonQuery()
                                            resultCode = GetInt(.Parameters("@retval").Value, -1)
                                            If resultCode <> 0 Then
                                                Throw New DatabaseException(String.Format("[{0}] Update ingredient subrecipe failed", resultCode))
                                            End If
                                        End If
                                    Next
                                    Try
                                        .CommandText = "sp_EgswListeSubRecipeRecomputePerSetPrice"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()
                                        .Parameters.Add("@intCode", SqlDbType.Int).Value = data.Info.CodeListe
                                        .Parameters.Add("@intCodeSetprice", SqlDbType.Int).Value = data.Info.CodeSetPrice
                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        .ExecuteNonQuery()
                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Update ingredient subrecipe failed", resultCode))
                                        End If
                                    Catch ex As Exception
                                        Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ":Recomputing Main Recipe Calc Price: " & .Parameters.Count.ToString, ex)
                                    End Try




                                    '' Update steps

                                    For Each item As Models.RecipeIngredient In data.Ingredient.Where(Function(s) s.ItemType = 75)
                                        .CommandText = "sp_EgswDetailsStepUpdate"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()
                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@nvcName", SqlDbType.NVarChar, 250).Value = GetStr(item.ItemName)
                                        .Parameters.Add("@nvcProcedure", SqlDbType.NVarChar, -1).Value = item.Preparation 'AGL 2014.06.09 replaced String.Empty
                                        .Parameters.Add("@intStep", SqlDbType.Int).Value = GetInt(item.Step)
                                        .Parameters.Add("@intPosition", SqlDbType.Int).Value = GetInt(item.Position)
                                        .Parameters.Add("@intCodeTemplate", SqlDbType.Int).Value = 0
                                        .ExecuteNonQuery()

                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Update recipe steps failed", resultCode))
                                        End If

                                        'AGL 2014.06.09
                                        'Update Step Translation
                                        If item.Translation IsNot Nothing AndAlso item.Translation.Count > 0 Then
                                            For Each steptrans As Models.RecipeIngredientTranslation In item.Translation
                                                .CommandText = "sp_EgswStepTranslationUpdate"
                                                .CommandType = CommandType.StoredProcedure
                                                .Parameters.Clear()
                                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue

                                                .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@intStep", SqlDbType.Int).Value = steptrans.Step
                                                .Parameters.Add("@nvcName", SqlDbType.NVarChar).Value = steptrans.Name
                                                .Parameters.Add("@nvcProcedure", SqlDbType.NVarChar).Value = steptrans.Preparation
                                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = steptrans.CodeTrans

                                                Try
                                                    .ExecuteNonQuery()
                                                Catch ex As Exception
                                                    Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Error in Step Translation Update. Current Parameter Count: " & .Parameters.Count.ToString, ex)
                                                End Try


                                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                                If resultCode <> 0 Then
                                                    Throw New DatabaseException(String.Format("[{0}] Update recipe steps translation failed", resultCode))
                                                End If
                                            Next
                                        End If

                                        ''Update Pictures/Videos -WVM-2014.11.11-BEGIN
                                        If item.Pictures IsNot Nothing Or item.Videos IsNot Nothing Then
                                            .CommandText = "[dbo].[API_UPDATE_ListeFiles]"
                                            .CommandType = CommandType.StoredProcedure
                                            .Parameters.Clear()
                                            .Parameters.Add("@FirstCode", SqlDbType.Int).Value = intCodeListe
                                            .Parameters.Add("@SecondCode", SqlDbType.Int).Value = -1
                                            .Parameters.Add("@Type", SqlDbType.Int).Value = item.ItemType
                                            .Parameters.Add("@Pictures", SqlDbType.NVarChar).Value = item.Pictures
                                            .Parameters.Add("@Videos", SqlDbType.NVarChar).Value = item.Videos
                                            .ExecuteNonQuery()
                                        End If

                                        'Save Picture
                                        m_PictureNames = item.Pictures
                                        m_TempPictureNames = item.tempPictures
                                        arrPictures = item.Pictures.Split(";")
                                        'Log.Info("arrayPictures" + arrPictures.ToString)
                                        Dim NewThreadPic As Thread = New Thread(AddressOf SavePictures)
                                        NewThreadPic.Priority = ThreadPriority.Lowest
                                        NewThreadPic.Start()

                                        'Save Video
                                        m_Videos = item.Videos
                                        m_TempVideos = item.tempVideos
                                        arrVideos = item.Videos.Split(";")
                                        'Log.Info("arrayPictures" + arrVideos.ToString)
                                        Dim NewThreadVideo As Thread = New Thread(AddressOf SaveVideos)
                                        NewThreadVideo.Priority = ThreadPriority.Lowest
                                        NewThreadVideo.Start()
                                        ''-WVM-2014.11.11-END.

                                    Next


                                    '' Update Alternative Ingredient 'JBQL -08132019
                                    If data.IngredientAlternative IsNot Nothing AndAlso data.IngredientAlternative.Count > 0 Then

                                        If data.IngredientAlternative.First().CodelisteMain = -1 Then
                                            For Each item In data.IngredientAlternative
                                                item.CodelisteMain = intCodeListe
                                            Next
                                        End If

                                    Else
                                        data.IngredientAlternative.Add(New Models.IngredientAlternative With {
                                                        .CodelisteMain = intCodeListe,
                                                        .Codeliste = 0,
                                                        .IngredientName = "",
                                                        .CodelisteAlternative = 0,
                                                        .AlternativeName = ""
                                                     })
                                    End If

                                    Try
                                        Dim tblAlternativeIngredients As DataTable
                                        Dim result = data.IngredientAlternative.Select(Function(ing) New With {
                                                                                                ing.CodelisteMain,
                                                                                                ing.Codeliste,
                                                                                                ing.IngredientName,
                                                                                                ing.CodelisteAlternative,
                                                                                                ing.AlternativeName
                                                                                           }).ToList()

                                        tblAlternativeIngredients = Common.ConvertToDataTable(result)
                                        .CommandText = "[dbo].[sp_InsertAlternativeIngredient]"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()
                                        .Parameters.Add("@tblAltIngredient", SqlDbType.Structured).Value = tblAlternativeIngredients

                                        .ExecuteNonQuery()
                                    Catch ex As Exception
                                        Dim err As String = ex.Message
                                    End Try


                                ElseIf data.Ingredient IsNot Nothing AndAlso data.Ingredient.Count = 0 Then
                                    'Delete all ingredients
                                    .CommandText = <sql>
                                        DELETE FROM dbo.EgswDetailsTranslation
                                        WHERE IDdetails IN ( SELECT ID FROM dbo.EgswDetails WHERE FirstCode = @CodeListe );
                                        DELETE FROM dbo.EgswDetailsSetPrice
                                        WHERE IDdetails IN ( SELECT ID FROM dbo.EgswDetails WHERE FirstCode = @CodeListe );
                                        DELETE FROM dbo.EgswDetails
                                        WHERE FirstCode = @CodeListe;
                                        DELETE FROM dbo.EgsWDetailsStepTrans WHERE CodeListe = @CodeListe;
			                            DELETE FROM dbo.EgswDetailsStep WHERE CodeListe = @CodeListe;
                                    </sql>.Value
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()
                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .ExecuteNonQuery()
                                End If

                                _trans.Commit()

                                ''Procedure
                                Dim dsCurrentProcedure As New DataSet
                                .CommandText = "sp_EgswGetInstruction"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = data.Info.CodeTrans
                                _da = New SqlDataAdapter(cmd)
                                _da.Fill(dsCurrentProcedure)

                                If data.Procedure IsNot Nothing AndAlso data.Procedure.Count > 0 Then
                                    Dim _noteID As Integer
                                    'Delete removed procedure items
                                    If dsCurrentProcedure IsNot Nothing AndAlso dsCurrentProcedure.Tables.Count > 0 AndAlso dsCurrentProcedure.Tables(0).Rows.Count > 0 Then
                                        Dim dtProcedure As DataTable = dsCurrentProcedure.Tables(0)
                                        .CommandText = <sql>
                                            DELETE FROM EgswListeNoteTrans WHERE EgswListeNoteID = @NoteID; 
                                            DELETE FROM EgswListeNote WHERE ID = @NoteID;
                                        </sql>.Value
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@NoteID", SqlDbType.Int)

                                        For Each dr As DataRow In dtProcedure.Rows
                                            _noteID = GetInt(dr("ID"))
                                            If data.Procedure.Where(Function(s) s.NoteId = _noteID).Count = 0 Then
                                                .Parameters("@NoteID").Value = _noteID
                                                .ExecuteNonQuery()
                                            End If
                                        Next
                                    End If

                                    Dim procpics As String = ""
                                    'Insert/update procedure items
                                    For Each procedure As Models.RecipeProcedure In data.Procedure
                                        .CommandText = "sp_EgswListeNoteUpdate"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()
                                        .Parameters.Add("@NoteId", SqlDbType.Int).Value = procedure.NoteId
                                        .Parameters.Add("@Codeliste", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@Position", SqlDbType.Int).Value = procedure.Position
                                        .Parameters.Add("@DigitalAsset", SqlDbType.NVarChar, 2000).Value = DBNull.Value
                                        .Parameters.Add("@Picture", SqlDbType.NVarChar, 2000).Value = procedure.Picture
                                        .Parameters.Add("@FreakOutMoment", SqlDbType.Bit).Value = DBNull.Value
                                        .Parameters.Add("@ID", SqlDbType.Int).Direction = ParameterDirection.Output
                                        .Parameters.Add("@retVal", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        .ExecuteNonQuery()
                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Update recipe notes failed", resultCode))
                                        End If
                                        If procedure.NoteId <= 0 Then
                                            _noteID = GetInt(.Parameters("@ID").Value, -1)
                                        Else
                                            _noteID = procedure.NoteId
                                        End If

                                        'Insert/update translation
                                        If _noteID > 0 Then
                                            .CommandText = <sql>
                                                            IF EXISTS ( SELECT ID FROM EgsWListeNoteTrans WHERE EgswListeNoteId = @NoteID AND CodeTrans = @Codetrans ) 
                                                            BEGIN 
                                                                UPDATE EgswListeNoteTrans
                                                                SET Note = @Note, Comment = @Comment, CookMode = @CookMode
                                                                WHERE EgswListeNoteId = @NoteID AND CodeTrans = @Codetrans
                                                            END ELSE BEGIN
                                                                INSERT INTO EgswListeNoteTrans ( EgswListeNoteID, CodeTrans, Note, Comment, CookMode )
                                                                VALUES ( @NoteID, @CodeTrans, @Note, @Comment, @CookMode ) 
                                                            END
                                                       </sql>.Value
                                            .CommandType = CommandType.Text
                                            For Each item As Models.RecipeProcedureTranslation In procedure.Translation
                                                .Parameters.Clear()
                                                .Parameters.Add("@NoteID", SqlDbType.Int).Value = _noteID
                                                .Parameters.Add("@Codetrans", SqlDbType.Int).Value = item.CodeTrans
                                                .Parameters.Add("@Note", SqlDbType.NVarChar, 2000).Value = item.Note
                                                .Parameters.Add("@Comment", SqlDbType.NVarChar, 2000).Value = String.Empty
                                                .Parameters.Add("@CookMode", SqlDbType.NVarChar, 4000).Value = item.AbbrevNote
                                                .ExecuteNonQuery()
                                            Next
                                        End If
                                        procpics += procedure.Picture + ";"
                                    Next
                                    m_PictureNames = procpics
                                    m_TempPictureNames = data.TempProcPicture
                                    arrPictures = procpics.Split(";")
                                    'Log.Info("arrayPictures" + arrPictures.ToString)
                                    Dim NewThread As Thread = New Thread(AddressOf SavePictures)
                                    NewThread.Priority = ThreadPriority.Lowest
                                    NewThread.Start()
                                ElseIf data.Procedure IsNot Nothing AndAlso data.Procedure.Count = 0 Then
                                    'Delete all procedure
                                    .CommandText = <sql>
                                        DELETE FROM dbo.EgswListeNoteTrans WHERE EgswListeNoteID IN ( SELECT ID FROM dbo.EgswListeNote WHERE CodeListe = @CodeListe );
                                        DELETE FROM dbo.EgswListeNote WHERE CodeListe = @CodeListe;
                                    </sql>.Value
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()
                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .ExecuteNonQuery()
                                End If

                                ''Kiosk/BrandSite
                                ''Delete everything first
                                '// JDO-2014.04.23
                                If data.BrandSite IsNot Nothing Then
                                    If data.BrandSite.Count = 0 Then
                                        .CommandText = "DELETE FROM RecipeBrandSite WHERE CodeListe=@CodeListe"
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .ExecuteNonQuery()
                                    Else
                                        Dim arrBrandSite As New ArrayList
                                        For Each brandSite In data.BrandSite
                                            arrBrandSite.Add(brandSite.Code)
                                        Next
                                        .CommandText = "DELETE FROM RecipeBrandSite WHERE CodeListe=@CodeListe AND CodeBrandSite NOT IN (SELECT value from fn_EgswSplit(@CodeBrandSite,','))"
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@CodeBrandSite", SqlDbType.NVarChar, 4000).Value = Common.Join(arrBrandSite, "", "", ",")
                                        .ExecuteNonQuery()

                                        'Insert brandsites
                                        For Each b In data.BrandSite
                                            If b.Enabled Then
                                                .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from RecipeBrandSite where codeliste=@CodeListe and CodeBrandSite = @CodeBrandSite)
                                                                BEGIN
                                                                INSERT INTO RecipeBrandSite(CodeListe,CodeBrandSite,BrandSiteDateFrom,BrandSiteDateTo) VALUES(@CodeListe,@CodeBrandSite,@DateFrom,@DateTo)
                                                                END</sql>
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()

                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@CodeBrandSite", SqlDbType.Int).Value = b.Code
                                                .Parameters.Add("@DateFrom", SqlDbType.DateTime).Value = GetDate(b.DateFrom) ''JDO 12.19.2013 CWA-10402
                                                .Parameters.Add("@DateTo", SqlDbType.DateTime).Value = GetDate(b.DateTo) ''JDO 12.19.2013 CWA-10402
                                            Else
                                                .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from RecipeBrandSite where codeliste=@CodeListe and CodeBrandSite = @CodeBrandSite)
                                                                BEGIN
                                                               INSERT INTO RecipeBrandSite(CodeListe,CodeBrandSite,BrandSiteDateFrom,BrandSiteDateTo) VALUES(@CodeListe,@CodeBrandSite,null,null)
                                                                END</sql>

                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()

                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@CodeBrandSite", SqlDbType.Int).Value = b.Code
                                            End If

                                            .ExecuteNonQuery()
                                            If b.Enabled Then
                                                .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from RecipeBrandSite where codeliste=@CodeListe and CodeBrandSite = @CodeBrandSite and BrandSiteDateFrom = @DateFrom and BrandSiteDateTo = @DateTo )
                                                                BEGIN
                                                                UPDATE RecipeBrandSite SET BrandSiteDateFrom = @DateFrom, BrandSiteDateTo = @DateTo where  codeliste=@CodeListe and CodeBrandSite = @CodeBrandSite
                                                                END</sql>
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()

                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@CodeBrandSite", SqlDbType.Int).Value = b.Code
                                                .Parameters.Add("@DateFrom", SqlDbType.DateTime).Value = GetDate(b.DateFrom) ''JDO 12.19.2013 CWA-10402
                                                .Parameters.Add("@DateTo", SqlDbType.DateTime).Value = GetDate(b.DateTo) ''JDO 12.19.2013 CWA-10402
                                            Else
                                                .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from RecipeBrandSite where codeliste=@CodeListe and CodeBrandSite = @CodeBrandSite and BrandSiteDateFrom is null and BrandSiteDateTo is null )
                                                                BEGIN
                                                                UPDATE RecipeBrandSite SET BrandSiteDateFrom = null, BrandSiteDateTo = null where  codeliste=@CodeListe and CodeBrandSite = @CodeBrandSite
                                                                END</sql>
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()

                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@CodeBrandSite", SqlDbType.Int).Value = b.Code


                                            End If
                                            .ExecuteNonQuery()
                                        Next
                                    End If
                                End If

                                ''Brands /* For generic clients, save only brandclassification=1 (Primary Brand) */    \
                                '' JDO-2014.04.21 Change from deleting everything first to selective deletion and insertion
                                If data.Brands IsNot Nothing Then
                                    Dim arrBrand As New ArrayList
                                    For Each brand In data.Brands
                                        arrBrand.Add(brand.Code)
                                    Next
                                    ''Delete everything first
                                    .CommandText = "DELETE FROM RecipeBrand WHERE CodeListe=@CodeListe AND BRAND NOT IN (SELECT value from fn_EgswSplit(@CodeBrand,','))"
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()

                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .Parameters.Add("@CodeBrand", SqlDbType.NVarChar, 4000).Value = Common.Join(arrBrand, "", "", ",")
                                    .ExecuteNonQuery()

                                    If data.Brands.Count > 0 Then
                                        'Insert brands
                                        Dim seed As Integer = 1
                                        For Each b In data.Brands
                                            .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from recipeBrand where codeliste=@CodeListe and Brand = @CodeBrand)
                                                                BEGIN
                                                                INSERT INTO RecipeBrand(CodeListe, Brand, BrandClassification, Sequence) 
                                                                VALUES(@CodeListe, @CodeBrand, @BrandClassification, @Sequence)
                                                                END</sql> 'AGL 2014.03.27 - Added @BrandClassification
                                            .CommandType = CommandType.Text
                                            .Parameters.Clear()

                                            .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                            .Parameters.Add("@CodeBrand", SqlDbType.Int).Value = b.Code
                                            .Parameters.Add("@Sequence", SqlDbType.Int).Value = 0
                                            .Parameters.Add("@BrandClassification", SqlDbType.Int).Value = b.Classification


                                            .ExecuteNonQuery()
                                            .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from recipeBrand where codeliste=@CodeListe and Brand = @CodeBrand and BrandClassification=@BrandClassification )
                                                                BEGIN
                                                                UPDATE RecipeBrand SET BrandClassification = @BrandClassification WHERE CodeListe=@CodeListe AND Brand = @CodeBrand 
                                                                END</sql>
                                            .CommandType = CommandType.Text
                                            .Parameters.Clear()

                                            .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                            .Parameters.Add("@CodeBrand", SqlDbType.Int).Value = b.Code
                                            .Parameters.Add("@BrandClassification", SqlDbType.Int).Value = b.Classification


                                            .ExecuteNonQuery()
                                            ' Set primary brand of recipe
                                            If seed = 1 Then ' RBAJ-2014.01.23
                                                .CommandText = "UPDATE EgswListe SET BRAND = @Brand WHERE Code = @CodeListe"
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()
                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@Brand", SqlDbType.Int).Value = GetInt(b.Code)
                                                .ExecuteNonQuery()
                                            End If
                                            seed += 1
                                        Next
                                    Else ' RBAJ-2014.01.23
                                        .CommandText = "UPDATE EgswListe SET BRAND = NULL WHERE Code = @CodeListe"
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .ExecuteNonQuery()
                                    End If
                                End If

                                ''Publication
                                If data.Publication IsNot Nothing Then
                                    If data.Publication.Count = 0 Then
                                        .CommandText = "DELETE FROM EgswListePlacement WHERE CodeListe=@CodeListe"
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .ExecuteNonQuery()
                                    Else
                                        For Each pub In data.Publication
                                            If pub.Code > 0 Then
                                                Dim sql As New StringBuilder
                                                .CommandText = "UPDATE EgswListePlacement SET Placement=@Placement, Dates=@Dates, [Description]=@Description,isCurrent=@isCurrent WHERE Code=@Code"
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()

                                                .Parameters.Add("@Code", SqlDbType.Int).Value = pub.Code
                                                .Parameters.Add("@Placement", SqlDbType.NVarChar, 50).Value = pub.Name
                                                .Parameters.Add("@Description", SqlDbType.NVarChar, 2000).Value = pub.Description
                                                .Parameters.Add("@Dates", SqlDbType.DateTime).Value = GetDate(pub.Dates)
                                                .Parameters.Add("@isCurrent", SqlDbType.Bit).Value = pub.isCurrent

                                                .ExecuteNonQuery()
                                            Else
                                                If pub.PlacementId = 0 AndAlso pub.CodeBrandSite = 0 Then
                                                    .CommandText = "INSERT INTO EgswListePlacement(CodeListe,Placement,Dates,[Description],CodeBrand,CodeBrandSite,PlacementId,CodeLBS,isCurrent) VALUES (@CodeListe,@Placement,@Dates,@Description,null,null,null,null,@isCurrent) SET @Code=@@IDENTITY"
                                                ElseIf pub.PlacementId > 0 Then
                                                    .CommandText = "INSERT INTO EgswListePlacement(CodeListe,Placement,Dates,[Description],CodeBrand,CodeBrandSite,PlacementId,CodeLBS,isCurrent) VALUES (@CodeListe,@Placement,@Dates,@Description,null,null,@PlacementId,null,@isCurrent) SET @Code=@@IDENTITY"
                                                Else
                                                    .CommandText = "INSERT INTO EgswListePlacement(CodeListe,Placement,Dates,[Description],CodeBrand,CodeBrandSite,PlacementId,CodeLBS,isCurrent) VALUES (@CodeListe,@Placement,@Dates,@Description,null,null,null,@CodeLBS,@isCurrent) SET @Code=@@IDENTITY"
                                                End If

                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()

                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@Placement", SqlDbType.NVarChar, 50).Value = pub.Name
                                                .Parameters.Add("@Description", SqlDbType.NVarChar, 2000).Value = pub.Description
                                                .Parameters.Add("@Dates", SqlDbType.SmallDateTime).Value = GetDate(pub.Dates, Date.Now)
                                                .Parameters.Add("@CodeBrand", SqlDbType.Int).Value = -1
                                                .Parameters.Add("@CodeBrandSite", SqlDbType.Int).Value = -1
                                                .Parameters.Add("@PlacementId", SqlDbType.Int).Value = pub.PlacementId
                                                .Parameters.Add("@CodeLBS", SqlDbType.Int).Value = pub.CodeBrandSite
                                                .Parameters.Add("@isCurrent", SqlDbType.Bit).Value = pub.isCurrent
                                                .Parameters.Add("@Code", SqlDbType.Int).Direction = ParameterDirection.Output

                                                .ExecuteNonQuery()

                                                pub.Code = GetInt(.Parameters("@Code").Value)

                                            End If
                                        Next

                                        ''Delete Stuff                                
                                        Dim arr As New ArrayList
                                        For Each pub In data.Publication
                                            arr.Add(pub.Code)
                                        Next
                                        Dim strCodes As String = Join(arr, "(", ")", ",")

                                        .CommandText = "DELETE FROM EgswListePlacement WHERE CodeListe=@CodeListe AND Code NOT IN " & strCodes
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .ExecuteNonQuery()

                                    End If
                                End If

                                ''SharingCountryOfProduction
                                If data.Sharing IsNot Nothing Then
                                    If data.Sharing.Count > 0 Then
                                        .CommandText = "DELETE FROM EgswSharing WHERE Code=@CodeListe AND CodeEgswTable=50"
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .ExecuteNonQuery()
                                        'Insert sharing for user owner ' RBAJ-2014.01.23
                                        .CommandText = <sql>
                                                           INSERT INTO [dbo].[EgswSharing]
                                                                ([Code]
                                                                ,[CodeUserOwner]
                                                                ,[CodeUserSharedTo]
                                                                ,[Type]
                                                                ,[CodeEgswTable]
                                                                ,[Position]
                                                                ,[Status]
                                                                ,[IsGlobal])
                                                            VALUES
                                                                (@CodeListe
                                                                ,@CodeUser
                                                                ,@CodeUser
                                                                ,8
                                                                ,50
                                                                ,0
                                                                ,1
                                                                ,0)
                                                       </sql>.Value
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.Info.CodeUser
                                        .ExecuteNonQuery()

                                        If data.NextRoleLevelApprover = -1 Then
                                            'Insert sharing for site
                                            Dim seed As Integer = 1
                                            For Each sh In data.Sharing
                                                .CommandText = <sql>
                                                           INSERT INTO [dbo].[EgswSharing]
                                                                ([Code]
                                                                ,[CodeUserOwner]
                                                                ,[CodeUserSharedTo]
                                                                ,[Type]
                                                                ,[CodeEgswTable]
                                                                ,[Position]
                                                                ,[Status]
                                                                ,[IsGlobal])
                                                            VALUES
                                                                (@CodeListe
                                                                ,@CodeUserOwner
                                                                ,@CodeSite
                                                                ,1
                                                                ,50
                                                                ,0
                                                                ,1
                                                                ,@Global)
                                                       </sql>.Value
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()
                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@CodeUserOwner", SqlDbType.Int).Value = data.Info.CodeSite
                                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = sh.Code
                                                .Parameters.Add("@Position", SqlDbType.Int).Value = seed
                                                .Parameters.Add("@Global", SqlDbType.Bit).Value = GetBool(sh.Value)

                                                .ExecuteNonQuery()
                                                seed += 1
                                            Next
                                        End If

                                    End If
                                End If

                                ''Project
                                ''Delete everything first
                                '// JDO-2014.04.23
                                If data.Project IsNot Nothing Then

                                    If data.Project.Count = 0 Then

                                        .CommandText = "DELETE FROM RecipeProject WHERE CodeListe=@CodeListe"
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .ExecuteNonQuery()
                                    Else
                                        Dim arrProject As New ArrayList
                                        For Each Project In data.Project
                                            arrProject.Add(Project.Code)
                                        Next
                                        .CommandText = "DELETE FROM RecipeProject WHERE CodeListe=@CodeListe and CodeProject not in (select value from fn_EgswSplit(@CodeProject,','))"
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()

                                        .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@CodeProject", SqlDbType.NVarChar, 4000).Value = Common.Join(arrProject, "", "", ",")
                                        .ExecuteNonQuery()

                                        'Insert projects
                                        For Each p In data.Project
                                            .CommandText = <sql>IF NOT EXISTS(SELECT CodeListe from RecipeProject where codeliste=@CodeListe and CodeProject = @CodeProject)
                                                                BEGIN
                                                                    INSERT INTO RecipeProject(CodeListe, CodeProject) VALUES(@CodeListe, @CodeProject)
                                                                END</sql>

                                            .CommandType = CommandType.Text
                                            .Parameters.Clear()

                                            .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                            .Parameters.Add("@CodeProject", SqlDbType.Int).Value = p.Code

                                            .ExecuteNonQuery()
                                        Next
                                    End If
                                End If

                                ''Translation
                                If data.Translation IsNot Nothing Then
                                    '.CommandText = <sql>
                                    '                   IF EXISTS(SELECT Id FROM EgswListeTranslation WHERE CodeListe=@CodeListe AND CodeTrans=@CodeTrans)
                                    '                        BEGIN
                                    '                     UPDATE EgswListeTranslation SET [Name]=@Name, [SubTitle]=@SubName, [Remark]=@Remark, [Description]=@Description, [FootNote1]=@FootNote1, [FootNote2]=@FootNote2,  [FootNote1Clean]=dbo.[fn_CleanText](@FootNote1), [FootNote2Clean]=dbo.[fn_CleanText](@FootNote2), [CCPDescription]=@CCPDescription, Ingredients=@Ingredients WHERE CodeListe=@CodeListe AND CodeTrans=@CodeTrans
                                    '                     END
                                    '                   ELSE
                                    '                     BEGIN
                                    '                     INSERT INTO EgswListeTranslation(CodeListe, CodeTrans, [Name], [SubTitle], [Remark], [Description], [FootNote1], [FootNote2], [FootNote1Clean], [FootNote2Clean], [CCPDescription], [Ingredients]) VALUES(@CodeListe, @CodeTrans, @Name, @SubName, @Remark, @Description, @FootNote1, @FootNote2, dbo.[fn_CleanText](@FootNote1), dbo.[fn_CleanText](@FootNote2), @CCPDescription, @Ingredients)
                                    '                     END
                                    '               </sql>.Value
                                    '.CommandType = CommandType.Text
                                    .CommandText = "API_UPDATE_ListeTranslation"
                                    .CommandType = CommandType.StoredProcedure
                                    For Each t In data.Translation
                                        If data.Info.CodeTrans <> t.CodeTrans Then
                                            .Parameters.Clear()
                                            .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                            .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = t.CodeTrans
                                            .Parameters.Add("@Name", SqlDbType.NVarChar).Value = t.Name
                                            .Parameters.Add("@SubName", SqlDbType.NVarChar).Value = t.SubName
                                            .Parameters.Add("@Remark", SqlDbType.NVarChar, 1000).Value = t.Remark
                                            .Parameters.Add("@Description", SqlDbType.NVarChar, 1000).Value = t.Description
                                            .Parameters.Add("@FootNote1", SqlDbType.NVarChar).Value = t.Notes ' RBAJ-2014.03.18 Changed to FootNote1
                                            .Parameters.Add("@FootNote2", SqlDbType.NVarChar).Value = GetStr(t.AdditionalNotes)
                                            .Parameters.Add("@CCPDescription", SqlDbType.NVarChar, 2500).Value = GetStr(t.CCPDescription)
                                            .Parameters.Add("@Ingredients", SqlDbType.NVarChar).Value = GetStr(t.Ingredients)
                                            .Parameters.Add("@HACCP", SqlDbType.NVarChar).Value = GetStr(t.HACCP)
                                            .Parameters.Add("@DeclarationName", SqlDbType.NVarChar).Value = GetStr(t.DeclarationName)
                                            .Parameters.Add("@SpecificDetermination", SqlDbType.NVarChar).Value = GetStr(t.SpecificDetermination)
                                            .Parameters.Add("@IsVerified", SqlDbType.Bit).Value = GetBool(t.Verified)

                                            'If Not data.Label Is Nothing Then
                                            '    .Parameters.Add("@SpecificDetermination", SqlDbType.NVarChar).Value = data.Label.SpecificDetermination
                                            'End If

                                            .ExecuteNonQuery()
                                        End If
                                    Next
                                Else '' Default translation only, for single-translation sites, the Translation tabs may not be visible

                                End If

                                .CommandText = "sp_EgswListeFullyTranslateUpdate" ' RBAJ-2014.01.23
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@nCode", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = data.Info.CodeSite
                                .Parameters.Add("@Flag", SqlDbType.Int).Value = 8 ' For recipe
                                .Parameters.Add("@Output", SqlDbType.Bit).Direction = ParameterDirection.Output
                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Update full translation failed", resultCode))
                                End If

                                ''Comment
                                If data.Comment IsNot Nothing Then
                                    .CommandText = "DELETE FROM EgswListeComment WHERE CodeListe=@CodeListe" ' RBAJ-2014.01.23 LLG
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()
                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .ExecuteNonQuery()

                                    If data.Comment.Count > 0 Then
                                        'Insert comments
                                        Dim _sequence As Integer = 1
                                        For Each c In data.Comment
                                            If GetDate(c.DateLastModified) > #4/30/1900# Then
                                                .CommandText = <sql>
                                                           INSERT INTO EgswListeComment (CodeListe, Sequence, Description, SubmitDate, CommentOwner, DateLastModified)
                                                           VALUES (@CodeListe, @Sequence, @Description, @SubmitDate, @CommentOwner, @DateLastModified) 
                                                           </sql>.Value
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()

                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@Sequence", SqlDbType.Int).Value = _sequence
                                                .Parameters.Add("@CommentOwner", SqlDbType.Int).Value = c.Owner
                                                .Parameters.Add("@Description", SqlDbType.NVarChar, 2000).Value = c.Description
                                                .Parameters.Add("@SubmitDate", SqlDbType.DateTime).Value = GetDate(c.SubmitDate)
                                                .Parameters.Add("@DateLastModified", SqlDbType.DateTime).Value = GetDate(c.DateLastModified)
                                            Else
                                                .CommandText = <sql>
                                                           INSERT INTO EgswListeComment (CodeListe, Sequence, Description, SubmitDate, CommentOwner)
                                                           VALUES (@CodeListe, @Sequence, @Description, @SubmitDate, @CommentOwner) 
                                                       </sql>.Value
                                                .CommandType = CommandType.Text
                                                .Parameters.Clear()

                                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                                .Parameters.Add("@Sequence", SqlDbType.Int).Value = _sequence
                                                .Parameters.Add("@CommentOwner", SqlDbType.Int).Value = c.Owner
                                                .Parameters.Add("@Description", SqlDbType.NVarChar, 2000).Value = c.Description
                                                .Parameters.Add("@SubmitDate", SqlDbType.DateTime).Value = GetDate(c.SubmitDate)
                                            End If

                                            .ExecuteNonQuery()
                                            _sequence += 1
                                        Next
                                    End If
                                End If

                                ''Allergens
                                If data.Allergen IsNot Nothing Then
                                    '<allergen code="123" contain="1" trace="1" nonallergen="1" derived ="1" added="1" hidden="1"/>
                                    Dim allergenXML As String = ""
                                    For Each item In data.Allergen
                                        allergenXML &= "<allergen code=""" & item.CodeAllergen & _
                                                            """ contain=""" & item.Contain & _
                                                            """ trace=""" & item.Trace & _
                                                            """ nonallergen=""" & item.NonAllergen & _
                                                            """ derived=""" & item.Derived & _
                                                            """ hidden=""" & item.Hidden & """/>"
                                    Next

                                    .CommandText = "[dbo].[sp_EgswListeAllergensUpdate]"
                                    .CommandType = CommandType.StoredProcedure
                                    .Parameters.Clear()
                                    .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = intCodeListe
                                    .Parameters.Add("@nvcAllergenXml", SqlDbType.NVarChar, 4000).Value = allergenXML
                                    .ExecuteNonQuery()

                                    'JBQL 2016.12.18 - Moved derived allergens recalculations to sp_EgswListeAllergensUpdate
                                    '.CommandText = "[dbo].[sp_EgswAllergensUpdateDerived]"
                                    '.CommandType = CommandType.StoredProcedure
                                    '.Parameters.Clear()
                                    '.Parameters.Add("@intFirstCode", SqlDbType.Int).Value = intCodeListe
                                    '.ExecuteNonQuery()
                                End If

                                'JBQL 2016.12.18 - Moved derived allergens recalculations to sp_EgswListeAllergensUpdate
                                ''AGL 2014.12.02
                                ''if recipe is used as subrecipe, update derived allergens of all other recipes that uses this as sub-recipe 
                                '.CommandText = "[dbo].[sp_EgswListeMerchandiseUpdateAllAllergensDerived]"
                                '.CommandType = CommandType.StoredProcedure
                                '.Parameters.Clear()
                                '.Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeListe
                                '.ExecuteNonQuery()

                                'Recipe links -WVM-2014.09.30
                                If data.RecipeLink IsNot Nothing Then

                                    .CommandText = "DELETE FROM EgswListeLink WHERE Code1=@CodeListe"
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()
                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .ExecuteNonQuery()

                                    If data.RecipeLink.Count > 0 Then
                                        For Each rlink In data.RecipeLink
                                            If rlink.Code > 0 Then
                                                .CommandText = "[dbo].[API_Update_RecipeRelated]"
                                                .CommandType = CommandType.StoredProcedure
                                                .Parameters.Clear()
                                                .Parameters.Add("@Code1", SqlDbType.Int).Value = GetInt(intCodeListe)
                                                .Parameters.Add("@Code2", SqlDbType.Int).Value = GetInt(rlink.Code)
                                                .Parameters.Add("@LinkDescription", SqlDbType.Int).Value = GetInt(rlink.LinkDescription)
                                                .ExecuteNonQuery()
                                            End If
                                        Next

                                    End If
                                End If

                                Try
                                    If arrDAMCode.Count <> 0 Then
                                        For Each code In arrDAMCode
                                            .CommandText = "[dbo].[sp_UpdateEgswDigitalAssetRecipeNumber]"
                                            .CommandType = CommandType.StoredProcedure
                                            .Parameters.Clear()
                                            .Parameters.Add("@id", SqlDbType.Int).Value = GetInt(code.ToString.Split("|")(0))
                                            .Parameters.Add("@nvcNumber", SqlDbType.NVarChar, 4000).Value = GetStr(Common.ReplaceSpecialCharacters(data.Info.Number))
                                            .Parameters.Add("@Position", SqlDbType.Int).Value = GetInt(code.ToString.Split("|")(1))
                                            .ExecuteNonQuery()
                                        Next
                                    End If

                                Catch ex As Exception
                                    Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)

                                End Try

                                'AGL 2014.07.02 - moved here, in order to ensure cost of recipe is calculated. this section of code was previously set before saving of ingredients
                                ''Calculation                            
                                If data.Calculation IsNot Nothing AndAlso data.Calculation.Count > 0 Then
                                    .CommandTimeout = 50000
                                    For Each calc In data.Calculation
                                        intCodeSetPrice = GetInt(calc.CodeSetPrice, 1) ' RBAJ-2013.12.18

                                        .CommandText = "sp_egswListeSetPriceCalcUpdate"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()
                                        .Parameters.Add("@intCodeliste", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@intCodeSetPrice", SqlDbType.Int).Value = intCodeSetPrice
                                        .Parameters.Add("@fltCoeff", SqlDbType.Float).Value = calc.Coef
                                        .Parameters.Add("@fltImposedPrice", SqlDbType.Float).Value = calc.ImposedPrice
                                        .Parameters.Add("@fltApprovedPrice", SqlDbType.Float).Value = 0
                                        .Parameters.Add("@intTax", SqlDbType.Int).Value = calc.Tax
                                        .Parameters.Add("@bitUpdateCoeff", SqlDbType.Bit).Value = True
                                        .Parameters.Add("@bitUpdateImposedPrice", SqlDbType.Bit).Value = True
                                        .Parameters.Add("@bitUpdateApprovedPrice", SqlDbType.Bit).Value = False
                                        .Parameters.Add("@bitUpdateTax", SqlDbType.Bit).Value = True
                                        .Parameters.Add("@fltPackaging", SqlDbType.Float).Value = calc.Packaging
                                        .Parameters.Add("@fltPackagingFactor", SqlDbType.Float).Value = calc.PackagingFactor
                                        .Parameters.Add("@bitUpdatePackaging", SqlDbType.Bit).Value = True
                                        .Parameters.Add("@bitUpdatePackagingFactor", SqlDbType.Bit).Value = True
                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        .ExecuteNonQuery()
                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Recipe price update failed", resultCode))
                                        End If
                                        Log.Info("sp_egswListeSetPriceCalcUpdate Executed")

                                        ' Update recipe price
                                        .CommandText = "sp_egswListeRecipeSubRecipesRecomputePricePerSetPrice"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()
                                        .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeListe
                                        .Parameters.Add("@intCodeSetprice", SqlDbType.Int).Value = intCodeSetPrice
                                        .Parameters.Add("@bitUpdateNutrient", SqlDbType.Bit).Value = 0
                                        .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                        .ExecuteNonQuery()
                                        resultCode = GetInt(.Parameters("@retval").Value, -1)
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Update nutrient values failed", resultCode))
                                        End If
                                        Log.Info("sp_egswListeRecipeSubRecipesRecomputePricePerSetPrice Executed: @intCode = " & intCodeListe.ToString & ", @intCodeSetprice = " & intCodeSetPrice & ", @bitUpdateNutrient = 0")
                                    Next
                                    .CommandTimeout = 120 ' Return to default timeout
                                End If
                                ''### START: Long running queries here! ###
                                ' Wait for 1 hour for the query to execute before timing out
                                .CommandTimeout = 3600


                                ''Keywords Derived
                                .CommandText = "sp_EgswListeRecipesUpdateKeywordsDerived"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Update keywords derived failed", resultCode))
                                End If

                                ''EgswDigitalAssetsRecipeNumber - Save Position Number
                                .CommandText = "sp_EgswListeRecipesUpdateKeywordsDerived"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Update keywords derived failed", resultCode))
                                End If

                                If Not data.Info.Pictures Is Nothing Then
                                    arrPictures = data.Info.Pictures.Trim.Split(";")
                                    If arrPictures.Length > 0 Then
                                        For ctr As Integer = 0 To arrPictures.Length - 1
                                            If arrPictures(ctr).Trim.Length > 0 Then
                                                If arrPictures(ctr).Trim.IndexOf("| DAM") <> -1 Then

                                                    arrPictures(ctr) = arrPictures(ctr).Substring(0, arrPictures(ctr).LastIndexOf("|")).Trim

                                                    arrDAMCode.Add(arrPictures(ctr).Trim().Substring(arrPictures(ctr).IndexOf("|") + 1))
                                                    arrPictures(ctr) = arrPictures(ctr).Substring(0, arrPictures(ctr).LastIndexOf("|")).Trim
                                                    arrPictures(ctr) = "P" & Format(Now, "MMddyyHHmmss") & "_" & ctr & arrPictures(ctr).Substring(arrPictures(ctr).LastIndexOf(".")).Trim
                                                End If

                                            End If
                                        Next
                                    End If
                                    pictures = String.Join(";", arrPictures)
                                End If

                                ' Update recipe nutrient info
                                .CommandText = "sp_EgswNutrientValUpdateRecipe"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = intCodeSetPrice
                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Update nutrient values failed", resultCode))
                                End If

                                ' Subrecipe Level
                                .CommandText = "sp_egswListeRecipeFixSRLevel"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@intCode", SqlDbType.Int).Value = intCodeListe
                                .Parameters.Add("@retval", SqlDbType.Int).Direction = ParameterDirection.ReturnValue
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Update subrecipe level failed", resultCode))
                                End If

                                ' Update Label
                                If Not data.Label.CodeListe = 0 Then
                                    .CommandText = "[API_UPDATE_Label]"
                                    .CommandType = CommandType.StoredProcedure
                                    .Parameters.Clear()
                                    .Parameters.Add("@Code", SqlDbType.Int).Value = data.Label.Code
                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.Info.CodeSite
                                    .Parameters.Add("@DeclarationName", SqlDbType.NVarChar).Value = data.Label.DeclarationName
                                    .Parameters.Add("@SpecificDetermination", SqlDbType.NVarChar).Value = data.Label.SpecificDetermination
                                    .Parameters.Add("@Number", SqlDbType.NVarChar).Value = data.Label.Number
                                    .Parameters.Add("@Barcode", SqlDbType.NVarChar).Value = data.Label.Barcode
                                    .Parameters.Add("@Consumption", SqlDbType.Float).Value = data.Label.Consumption
                                    .Parameters.Add("@Sold", SqlDbType.Float).Value = data.Label.Sold
                                    .Parameters.Add("@Weight", SqlDbType.Float).Value = data.Label.Weight
                                    .Parameters.Add("@Unit", SqlDbType.Int).Value = data.Label.Unit
                                    .Parameters.Add("@Price", SqlDbType.Float).Value = data.Label.Price
                                    .Parameters.Add("@PriceFor", SqlDbType.Float).Value = data.Label.PriceFor
                                    .Parameters.Add("@Calculated", SqlDbType.Float).Value = data.Label.Calculated
                                    .Parameters.Add("@Note1", SqlDbType.Int).Value = data.Label.Note1
                                    .Parameters.Add("@Note2", SqlDbType.Int).Value = data.Label.Note2
                                    .Parameters.Add("@Note3", SqlDbType.Int).Value = data.Label.Note3
                                    .Parameters.Add("@Certification", SqlDbType.Int).Value = data.Label.Certification
                                    .Parameters.Add("@CountryOfProduction", SqlDbType.Int).Value = data.Label.CountryOfProduction
                                    .Parameters.Add("@PackagingMethod", SqlDbType.Int).Value = data.Label.PackagingMethod
                                    .Parameters.Add("@Storage", SqlDbType.Int).Value = data.Label.Storage
                                    .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = data.Info.CodeTrans

                                    .ExecuteNonQuery()
                                End If


                                'Label Composition
                                ''ECAM - 08.13.2015 - Saving of Label Composition
                                '.CommandText = "DELETE FROM EgswLabelComposition WHERE CodeListe=@CodeListe"
                                '.CommandType = CommandType.Text
                                '.Parameters.Clear()
                                '.Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                '.ExecuteNonQuery()

                                If Not data.LabelComposition Is Nothing Then

                                    If data.LabelComposition.Count > 0 Then
                                        'Insert comments
                                        For Each c In data.LabelComposition
                                            .CommandText = <sql>
                                                                IF NOT EXISTS (SELECT * FROM EgswLabelComposition WHERE CodeListe = @CodeListe AND CompoType = @CompoType AND CodeTrans = @CodeTrans)
                                                                    INSERT INTO EgswLabelComposition (CodeListe, CompoType, CodeTrans, ImposedComposition, IsValidated)
                                                                    VALUES (@CodeListe, @CompoType, @CodeTrans, @ImposedComposition, @IsValidated)
                                                                ELSE
                                                                    UPDATE EgswLabelComposition SET ImposedComposition = @ImposedComposition, IsValidated = @IsValidated
                                                                    WHERE CodeListe = @CodeListe AND CompoType = @CompoType AND CodeTrans = @CodeTrans
                                                           </sql>.Value
                                            .CommandType = CommandType.Text
                                            .Parameters.Clear()

                                            .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                            .Parameters.Add("@CompoType", SqlDbType.Int).Value = c.CompoType
                                            .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = c.CodeTrans
                                            If c.ImposedComposition = "<br>" Then
                                                c.ImposedComposition = ""
                                            End If

                                            .Parameters.Add("@ImposedComposition", SqlDbType.NVarChar, 4000).Value = IIf(c.ImposedComposition = Nothing, "", c.ImposedComposition)
                                            .Parameters.Add("@IsValidated", SqlDbType.Bit).Value = c.IsValidated

                                            .ExecuteNonQuery()
                                        Next
                                    End If
                                End If

                                ''NutrientSet
                                If Not data.NutrientSetCode = Nothing Then
                                    .CommandText = <sql>
                                                      IF EXISTS ( SELECT CodeListe FROM EgswNutrientSetDefault WHERE CodeListe = @CodeListe ) 
                                                            BEGIN 
                                                                UPDATE EgswNutrientSetDefault
                                                                SET NutrientSetCode = @NutrientCode, NutrientSetValue = @NutrientValue
                                                                WHERE CodeListe = @CodeListe
                                                            END ELSE BEGIN
                                                                INSERT INTO EgswNutrientSetDefault ( CodeListe, NutrientSetCode, NutrientSetValue )
                                                                VALUES ( @CodeListe, @NutrientCode, @NutrientValue ) 
                                                            END
                                                   </sql>.Value
                                    .CommandType = CommandType.Text
                                    .Parameters.Clear()

                                    .Parameters.Add("@CodeListe", SqlDbType.Int).Value = intCodeListe
                                    .Parameters.Add("@NutrientCode", SqlDbType.Int).Value = data.NutrientSetCode
                                    .Parameters.Add("@NutrientValue", SqlDbType.Text).Value = data.NutrientSetValue

                                    .ExecuteNonQuery()

                                End If

                                ''### END: Long running queries here! ###

                                ' Done without errors
                                response.Code = 0
                                response.ReturnValue = intCodeListe
                                response.Message = Common.ReplaceSpecialCharacters(data.Info.Name) & " successfully saved."
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                Try
                                    _trans.Rollback()
                                    If Not _trans Is Nothing Then
                                        CType(_trans, IDisposable).Dispose()
                                    End If
                                Catch
                                End Try
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Save recipe failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Recipe")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using

                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Recipe")
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Recipe")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Recipe")
            End Try
            Return response

        End Function

        <HttpGet> <[GET]("/api/recipe/ingredient/{codeliste:int}/{codesite}/{codetrans}/{codesetprice}")> _
        Public Function GetRecipeIngredient(codeliste As Integer, Optional codesite As Integer = -1, Optional codetrans As Integer = -1, Optional codesetprice As Integer = 0)
            'LLG 01.04.2016 added codesetprice parameter
            Dim ingredients As New List(Of Models.RecipeIngredient)
            Dim ingredientTranslation As New List(Of Models.RecipeIngredientTranslation)
            Dim ingredientalternative As New List(Of Models.IngredientAlternative)
            Dim ingredientalternativetrans As New List(Of Models.IngredientAlternativeTranslation)

            Try
                Using cmd As New SqlCommand
                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                cn.Open()

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "API_GET_RecipeIngredientTranslation"
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@ExcludeCodeTrans", SqlDbType.Int).Value = codetrans

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    While dr.Read
                                        If dr.HasRows Then
                                            ingredientTranslation.Add(
                                                New Models.RecipeIngredientTranslation With {
                                                    .ItemId = GetInt(dr("ID")),
                                                    .CodeTrans = GetInt(dr("CodeTrans")),
                                                    .Name = GetStr(dr("Name")),
                                                    .Complement = GetStr(dr("Complement")),
                                                    .Preparation = GetStr(dr("Preparation")),
                                                    .AlternativeIngredient = GetStr(dr("AlternativeIngredient")),
                                                    .Step = GetStr(dr("Step")),
                                                    .CodeUnitDisplaySelection = GetInt(dr("CodeUnitDisplaySelection")),
                                                    .IsGenderSensitive = GetBool(dr("IsGenderSensitive")),
                                                    .PrefixCode = GetInt(dr("PrefixCode")),
                                                    .PrefixGender = IIf(GetBool(dr("IsFemale")) = True, "Feminine", "Masculine")
                                                }
                                            )
                                        End If
                                    End While
                                    dr.Close()
                                End Using

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "API_GET_RecipeIngredient"
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = codesetprice 'LLG 01.04.2016 added codesetprice parameter
                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    While dr.Read
                                        If dr.HasRows Then
                                            ' MKAM 2016.03.04
                                            '.ItemQty = GetDbl(dr("ItemQty")), _
                                            '.QuantityMetric = GetDbl(dr("QuantityMetric")), _
                                            '.QuantityImperial = GetDbl(dr("QuantityImperial")), _
                                            ingredients.Add(
                                                New Models.RecipeIngredient With {
                                                    .CodeListe = codeliste,
                                                    .CodeUser = GetInt(dr("CodeUser")),
                                                    .ItemId = GetInt(dr("ItemId")),
                                                    .ItemCode = GetInt(dr("ItemCode")),
                                                    .ItemName = GetStr(dr("ItemName")),
                                                    .ItemNumber = GetStr(dr("ItemNumber")),
                                                    .ItemType = GetInt(dr("ItemType")),
                                                    .ItemQty = GetDbl(Format(dr("ItemQty"), dr("ItemUnitFormat"))),
                                                    .ItemCodeUnit = GetInt(dr("ItemCodeUnit")),
                                                    .ItemUnit = GetStr(dr("ItemUnit")),
                                                    .Step = GetInt(dr("Step")),
                                                    .Position = GetInt(dr("Position")),
                                                    .Complement = GetStr(dr("Complement")),
                                                    .Preparation = GetStr(dr("Preparation")),
                                                    .AlternativeIngredient = GetStr(dr("AlternativeIngredient")),
                                                    .TmpName = GetStr(dr("TmpName")),
                                                    .TmpQty = GetStr(dr("TmpQty")),
                                                    .TmpUnit = GetStr(dr("TmpUnit")),
                                                    .TmpComplement = GetStr(dr("TmpComplement")),
                                                    .TmpPreparation = GetStr(dr("TmpPreparation")),
                                                    .Wastage1 = GetInt(dr("Wastage1")),
                                                    .Wastage2 = GetInt(dr("Wastage2")),
                                                    .Wastage3 = GetInt(dr("Wastage3")),
                                                    .Wastage4 = GetInt(dr("Wastage4")),
                                                    .Price = GetDbl(dr("Price")),
                                                    .PriceUnit = GetStr(dr("PriceUnit")),
                                                    .Amount = GetDbl(dr("Amount")),
                                                    .QuantityMetric = GetDbl(Format(GetDbl(dr("QuantityMetric")), dr("ItemUnitFormat"))),
                                                    .CodeUnitMetric = GetInt(dr("CodeUnitMetric")),
                                                    .UnitMetric = GetStr(dr("UnitMetric")),
                                                    .QuantityImperial = GetDbl(Format(GetDbl(dr("QuantityImperial")), dr("ItemUnitFormat"))),
                                                    .CodeUnitImperial = GetInt(dr("CodeUnitImperial")),
                                                    .UnitImperial = GetStr(dr("UnitImperial")),
                                                    .ConvertDirection = GetInt(dr("ConvertDirection")),
                                                    .IsQuickEncode = GetBool(.ItemType = 0),
                                                    .IsAllowMetricImperial = False,
                                                    .ApprovalStatusCode = GetInt(dr("ApprovalStatusCode")),
                                                    .ApprovalRequestedBy = GetInt(dr("ApprovalRequestedBy")),
                                                    .ApprovalRequestedDate = GetStr(dr("ApprovalRequestedDate")),
                                                    .ApprovalBy = GetInt(dr("ApprovalBy")),
                                                    .ApprovalDate = GetStr(dr("ApprovalDate")),
                                                    .CodeBrand = GetInt(dr("CodeBrand")),
                                                    .Translation = IIf(GetInt(dr("ItemType")) <> 75, ingredientTranslation.Where(Function(c) c.ItemId = .ItemId).ToList(), ingredientTranslation.Where(Function(c) c.Step = .Step).ToList()),
                                                    .CodeUnitDisplaySelection = GetInt(dr("CodeUnitDisplaySelection")),
                                                    .CodeTrans = GetInt(dr("CodeTrans")),
                                                    .IsGenderSensitive = GetBool(dr("IsGenderSensitive")),
                                                    .PrefixCode = GetInt(dr("PrefixCode")),
                                                    .PrefixGender = IIf(GetBool(dr("IsFemale")) = True, "Feminine", "Masculine"),
                                                    .IngredientStatus = GetInt(dr("IngredientStatus")),
                                                    .isLocked = GetBool(dr("isLocked"))
                                                }
                                            )
                                        End If
                                    End While
                                    dr.Close()
                                End Using

                                ' JBQL 09132019 GET Alternative Ingredients

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "sp_egswGetListeAlternativeIngredients"
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    While dr.Read
                                        If dr.HasRows Then
                                            ingredientalternative.Add(New Models.IngredientAlternative With {
                                                        .CodelisteMain = GetInt(dr("CodelisteMain")),
                                                        .Codeliste = GetInt(dr("Codeliste")),
                                                        .IngredientName = GetStr(dr("IngredientName")),
                                                        .CodelisteAlternative = GetInt(dr("CodelisteAlternative")),
                                                        .AlternativeName = GetStr(dr("AlternativeName"))
                                                     })
                                        End If
                                    End While
                                    dr.Close()
                                End Using

                                For Each ing In ingredients
                                    Dim alternativeingredients As New List(Of Models.IngredientAlternative)
                                    alternativeingredients = ingredientalternative.Where(Function(alting) alting.Codeliste = ing.ItemCode).ToList()
                                    ing.IngredientAlternative = New List(Of Models.IngredientAlternative)
                                    ing.IngredientAlternative.AddRange(alternativeingredients)
                                Next

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "sp_egswGetListeAlternativeIngredientsTranslation"
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    While dr.Read
                                        If dr.HasRows Then
                                            ingredientalternativetrans.Add(New Models.IngredientAlternativeTranslation With {
                                                        .CodelisteMain = GetInt(dr("CodelisteMain")),
                                                        .Codeliste = GetInt(dr("Codeliste")),
                                                        .IngredientName = GetStr(dr("IngredientName")),
                                                        .CodelisteAlternative = GetInt(dr("CodelisteAlternative")),
                                                        .AlternativeName = GetStr(dr("AlternativeName")),
                                                        .CodeTrans = GetStr(dr("CodeTrans"))
                                                     })
                                        End If
                                    End While
                                    dr.Close()
                                End Using

                                'ingredients.AddRange(ingredientalternativetrans)

                                For Each ing In ingredients
                                    For Each trans In ing.Translation
                                        Dim alternativeingredientstranslation As New List(Of Models.IngredientAlternativeTranslation)
                                        alternativeingredientstranslation = ingredientalternativetrans.Where(Function(altingtrans) altingtrans.Codeliste = ing.ItemCode And altingtrans.CodeTrans = trans.CodeTrans).ToList()
                                        trans.IngredientAlternativeTranslation = alternativeingredientstranslation
                                    Next
                                Next


                                'For Each ing In ingredients
                                '    For Each alting In ing.IngredientAlternative
                                '        Dim alternativeingredientstranslation As New List(Of Models.IngredientAlternativeTranslation)
                                '        alternativeingredientstranslation = ingredientalternativetrans.Where(Function(altingtrans) altingtrans.Codeliste = alting.Codeliste And altingtrans.CodelisteAlternative = alting.CodelisteAlternative).ToList()
                                '        alting.AlternativeIngredientTranslation = New List(Of Models.IngredientAlternativeTranslation)
                                '        alting.AlternativeIngredientTranslation.AddRange(alternativeingredientstranslation)
                                '    Next
                                'Next

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
            Return ingredients
        End Function

        <HttpGet> <[GET]("/api/recipe/procedure/{codeliste:int}/{codesite}/{codetrans}")> _
        Public Function GetRecipeProcedure(codeliste As Integer, Optional codesite As Integer = -1, Optional codetrans As Integer = -1
            ) As List(Of Models.RecipeProcedure)

            Dim procedure As New List(Of Models.RecipeProcedure)
            Dim procedureTranslation As New List(Of Models.RecipeProcedureTranslation)

            Try
                Using cmd As New SqlCommand
                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                cn.Open()

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "API_GET_RecipeProcedureTranslation"
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@ExcludeCodeTrans", SqlDbType.Int).Value = codetrans

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    While dr.Read
                                        If dr.HasRows Then
                                            procedureTranslation.Add(
                                                New Models.RecipeProcedureTranslation With {
                                                    .NoteId = GetInt(dr("NoteId")), _
                                                    .CodeTrans = GetInt(dr("CodeTrans")), _
                                                    .Note = GetStr(dr("Note")), _
                                                    .AbbrevNote = GetStr(dr("AbbrevNote")), _
                                                    .Position = GetInt(dr("Position"))
                                                    }
                                                )
                                        End If
                                    End While
                                    dr.Close()
                                End Using

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "API_GET_RecipeProcedure"
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    While dr.Read
                                        If dr.HasRows Then
                                            procedure.Add(
                                                New Models.RecipeProcedure With {
                                                    .NoteId = GetInt(dr("NoteId")), _
                                                    .Position = GetInt(dr("Position")), _
                                                    .Note = GetStr(dr("Note")), _
                                                    .AbbrevNote = GetStr(dr("AbbrevNote")), _
                                                    .Translation = procedureTranslation.Where(Function(c) c.NoteId = .NoteId).ToList(), _
                                                    .Picture = GetStr(dr("Picture")), _
                                                    .hasPicture = GetStr(dr("hasPicture"))
                                                    })
                                        End If
                                    End While
                                    dr.Close()
                                End Using

                                Return procedure
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
            Return procedure
        End Function

        <HttpGet> <[GET]("/api/recipe/history/{codeliste:int}/{codetrans}")> _
        Public Function GetRecipeHistorys(codeliste As Integer, codetrans As Integer, Optional codeuser As Integer = -1, Optional skip As Integer = 0, _
                                 Optional take As Integer = 10, Optional datefilter As Integer = 0, Optional datefrom As String = "", Optional dateto As String = "", Optional ActionType As Integer = 0
            ) As Models.RecipeHistoryResponse
            Dim histories As New List(Of Models.RecipeHistory)

            Try
                Using cmd As New SqlCommand
                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                cn.Open()

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "sp_EgswListeGetHistoryLogs"
                                .Parameters.Clear()
                                .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = codeuser
                                .Parameters.Add("@intFieldCode", SqlDbType.Int).Value = -1
                                .Parameters.Add("@bitFirstFewRecords", SqlDbType.Bit).Value = 0
                                .Parameters.Add("@intDateFilterOption", SqlDbType.Int).Value = GetInt(datefilter)
                                .Parameters.Add("@dteDateFrom", SqlDbType.DateTime).Value = IIf(String.IsNullOrEmpty(datefrom), DBNull.Value, GetDate(datefrom, Date.Now))
                                .Parameters.Add("@dteDateTo", SqlDbType.DateTime).Value = IIf(String.IsNullOrEmpty(dateto), DBNull.Value, GetDate(dateto, Date.Now))
                                .Parameters.Add("@intActionType", SqlDbType.Int).Value = ActionType

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    While dr.Read
                                        If dr.HasRows Then
                                            histories.Add(
                                                New Models.RecipeHistory With {
                                                    .DateAudit = GetStr(dr("DateAudit")), _
                                                    .FieldName = GetStr(dr("FieldName")), _
                                                    .Time = GetStr(dr("Time")), _
                                                    .FieldCode = GetStr(dr("FieldCode")), _
                                                    .Previous = GetStr(dr("Previous")), _
                                                    .HNew = GetStr(dr("New")), _
                                                    .User = GetStr(dr("User")), _
                                                    .AuditType = GetStr(dr("AuditType")), _
                                                    .CodeListe = GetStr(dr("CodeListe")), _
                                                    .CodeUser = GetStr(dr("CodeUser")), _
                                                    .IsCode = GetStr(dr("IsCode"))
                                                    }
                                                )
                                        End If
                                    End While
                                    dr.Close()
                                End Using
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim totalCount As Integer = histories.Count
                take = IIf(take > totalCount + 1, totalCount, take) ' Prevent overflow of take
                take = IIf(take <= 0, 1, take) ' Prevent overflow of take
                Dim totalPages As Integer = Math.Ceiling(totalCount / take)
                skip = IIf(skip > totalPages, totalPages, skip) ' Prevent overflow of skip
                skip = IIf(skip < 1, 0, skip) ' Prevent overflow of skip

                ' RBAJ-2014.04.14 Added default sorting
                'Dim x = New Models.RecipeHistoryResponse(
                '    histories _
                '    .OrderByDescending(Function(obj) Date.Parse(obj.DateAudit)) _
                '    .ThenByDescending(Function(obj) obj.FieldName) _
                '    .ThenByDescending(Function(obj) Date.Parse(obj.Time)) _
                '    .Skip(take * skip) _
                '    .Take(take).ToList, _
                '    totalCount
                ')

                Dim x = New Models.RecipeHistoryResponse(
                   histories _
                   .Skip(take * skip) _
                   .Take(take).ToList, _
                   totalCount
               )
                Return x
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
        <HttpGet> <[GET]("/api/recipe/historys/{codeliste:int}/{codetrans}")> _
        Public Function GetRecipeHistory(codeliste As Integer, codetrans As Integer, Optional codeuser As Integer = -1, Optional skip As Integer = 0, _
                                 Optional take As Integer = 10, Optional datefilter As Integer = 0, Optional datefrom As String = "", Optional dateto As String = "", Optional ActionType As Integer = 0
            ) As Models.RecipeHistoryResponse
            Dim histories As New List(Of Models.RecipeHistory)

            Try
                Using cmd As New SqlCommand
                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                cn.Open()

                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "sp_EgswListeGetHistoryLogs"
                                .Parameters.Clear()
                                .Parameters.Add("@intCodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = codeuser
                                .Parameters.Add("@intFieldCode", SqlDbType.Int).Value = -1
                                .Parameters.Add("@bitFirstFewRecords", SqlDbType.Bit).Value = 0
                                .Parameters.Add("@intDateFilterOption", SqlDbType.Int).Value = GetInt(datefilter)
                                .Parameters.Add("@dteDateFrom", SqlDbType.DateTime).Value = IIf(String.IsNullOrEmpty(datefrom), DBNull.Value, GetDate(datefrom, Date.Now))
                                .Parameters.Add("@dteDateTo", SqlDbType.DateTime).Value = IIf(String.IsNullOrEmpty(dateto), DBNull.Value, GetDate(dateto, Date.Now))
                                .Parameters.Add("@intActionType", SqlDbType.Bit).Value = ActionType

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    While dr.Read
                                        If dr.HasRows Then
                                            histories.Add(
                                                New Models.RecipeHistory With {
                                                    .DateAudit = GetStr(dr("DateAudit")), _
                                                    .FieldName = GetStr(dr("FieldName")), _
                                                    .Time = GetStr(dr("Time")), _
                                                    .FieldCode = GetStr(dr("FieldCode")), _
                                                    .Previous = GetStr(dr("Previous")), _
                                                    .HNew = GetStr(dr("New")), _
                                                    .User = GetStr(dr("User")), _
                                                    .AuditType = GetStr(dr("AuditType")), _
                                                    .CodeListe = GetStr(dr("CodeListe")), _
                                                    .CodeUser = GetStr(dr("CodeUser")), _
                                                    .IsCode = GetStr(dr("IsCode"))
                                                    }
                                                )
                                        End If
                                    End While
                                    dr.Close()
                                End Using
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim totalCount As Integer = histories.Count
                take = IIf(take > totalCount + 1, totalCount, take) ' Prevent overflow of take
                take = IIf(take <= 0, 1, take) ' Prevent overflow of take
                Dim totalPages As Integer = Math.Ceiling(totalCount / take)
                skip = IIf(skip > totalPages, totalPages, skip) ' Prevent overflow of skip
                skip = IIf(skip < 1, 0, skip) ' Prevent overflow of skip

                ' RBAJ-2014.04.14 Added default sorting


                Dim x = New Models.RecipeHistoryResponse(
                    histories _
                    .Skip(take * skip) _
                    .Take(take).ToList, _
                    totalCount
                )
                Return x
                'Return New Models.RecipeHistoryResponse(histories _
                '                                        .Skip(take * skip).Take(take).ToList, totalCount)
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/recipe/status/{type:int}/{codetrans:int}")> _
        Public Function GetRecipeStatus(type As Integer, codetrans As Integer) As List(Of Models.GenericList)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_EGSWSTATUSList]" ''aGET_EGSWSTATUSList
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim status As New List(Of Models.GenericList)
                For Each r In ds.Tables(0).Rows
                    status.Add(New Models.GenericList With {.Code = GetInt(r("Code")), .Value = GetStr(r("Name"))})
                Next

                Return status.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/recipe/usedasingredient/{codetrans:int}/{codeliste:int}")> _
        Public Function GetUsedAsIngredient(codetrans As Integer, codeliste As Integer) As List(Of Models.RecipeUsedAsIngredient) ''JDO 1.17.2014
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_RecipeUsedAsIngredient]"
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim recipe As New List(Of Models.RecipeUsedAsIngredient)
                For Each r In ds.Tables(0).Rows
                    recipe.Add(New Models.RecipeUsedAsIngredient With {
                                    .Code = GetInt(r("Code")), _
                                    .Number = GetStr(r("Number")), _
                                    .Name = GetStr(r("Name"))})
                Next

                Return recipe.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        '<HttpPost> <POST("api/recipe/weight")> _
        'Public Function GetRecipeWeight(ingredients As Models.IngredientWeightList) As Models.ResponseCallBack ' RBAJ-2014.04.04
        '    Dim response As New Models.ResponseCallBack
        '    Try
        '        If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(ingredients, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

        '        Using cmd As New SqlCommand
        '            If ingredients Is Nothing Then
        '                Throw (New ArgumentNullException("ingredient data is empty"))
        '            End If

        '            With cmd
        '                Using cn As New SqlConnection(ConnectionString)
        '                    Try
        '                        .Connection = cn
        '                        .CommandType = CommandType.Text
        '                        .CommandText = <sql>
        '				     DECLARE @Weight AS FLOAT;
        '					 EXEC @Weight = dbo.[fn_GetIngredientWeight] @CodeListe=@CodeListe,@CodeSetPrice=@CodeSetPrice,@CodeUnit=@CodeUnit,@Quantity=@Quantity
        '					 SELECT @Weight AS [Weight]
        '			   </sql>.Value
        '                        .Connection.Open()
        '                        Dim totalWeight As Double = 0
        '                        For Each item In ingredients.Data
        '                            .Parameters.Clear()
        '                            .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(item.Code)
        '                            .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = GetInt(item.CodeSetPrice)
        '                            .Parameters.Add("@CodeUnit", SqlDbType.Int).Value = GetInt(item.CodeUnit)
        '                            .Parameters.Add("@Quantity", SqlDbType.Float).Value = GetDbl(item.Quantity)
        '                            .Parameters.Add("@DisplayCodeUnit", SqlDbType.Int).Value = GetInt(ingredients.DisplayCodeUnit)
        '                            totalWeight += GetDbl(cmd.ExecuteScalar())
        '                        Next

        '                        .CommandText = "SELECT Factor FROM dbo.EgswUnit WHERE Code = @DisplayCodeUnit "
        '                        .Parameters.Clear()
        '                        .Parameters.Add("@DisplayCodeUnit", SqlDbType.Int).Value = GetInt(ingredients.DisplayCodeUnit)
        '                        Dim unitFactor As Double = GetDbl(cmd.ExecuteScalar())

        '                        If totalWeight > 0 AndAlso unitFactor > 0 Then
        '                            totalWeight = totalWeight / unitFactor
        '                        Else
        '                            totalWeight = 0
        '                        End If

        '                        ' Done without errors
        '                        response.Code = 0
        '                        response.Message = "OK"
        '                        response.ReturnValue = totalWeight
        '                        response.Status = True
        '                    Finally
        '                        If Not cn Is Nothing Then
        '                            cn.Close()
        '                            CType(cn, IDisposable).Dispose()
        '                        End If
        '                    End Try
        '                End Using
        '            End With
        '        End Using
        '    Catch aex As ArgumentException
        '        Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
        '        response.Code = 400
        '        response.Message = "Missing or invalid parameters"
        '        response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
        '    Catch hex As HttpResponseException
        '        Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
        '        Throw hex
        '    Catch ex As Exception
        '        Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
        '        response.Status = False
        '        response.Message = "Unexpected error occured"
        '        response.Code = 500
        '    End Try
        '    Return response
        'End Function

        '//NBG 12.2.2015 Add Codeliste For computation
        <HttpPost> <POST("api/recipe/weight/{codeliste:int}/{codesetprice}")> _
        Public Function GetRecipeWeight(codeliste As Integer, codesetprice As Integer, ingredients As Models.IngredientWeightList) As Models.ResponseCallBack ' RBAJ-2014.04.04
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString)
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.Text
                                .CommandText = <sql>
        				                 DECLARE @Weight AS FLOAT;
        					             EXEC @Weight = dbo.[fn_EgsWGETRecipeWeightActual] @p_nCodeListe=@p_nCodeListe, @p_nCodeSetPrice = @p_nCodeSetPrice
        					             SELECT @Weight AS [Weight]
        			            </sql>.Value
                                .Connection.Open()
                                .Parameters.Add("@p_nCodeListe", SqlDbType.Int).Value = GetInt(codeliste)
                                .Parameters.Add("@p_nCodeSetPrice", SqlDbType.Int).Value = GetInt(codesetprice)
                                Dim totalWeight As String = 0

                                totalWeight += GetDbl(cmd.ExecuteScalar())


                                .CommandText = "SELECT Factor FROM dbo.EgswUnit WHERE Code = @DisplayCodeUnit "
                                .Parameters.Clear()
                                .Parameters.Add("@DisplayCodeUnit", SqlDbType.Int).Value = GetInt(ingredients.DisplayCodeUnit)
                                Dim unitFactor As Double = GetDbl(cmd.ExecuteScalar())

                                .CommandText = "SELECT Format FROM dbo.EgswUnit WHERE Code = @DisplayCodeUnit "
                                .Parameters.Clear()
                                .Parameters.Add("@DisplayCodeUnit", SqlDbType.Int).Value = GetInt(ingredients.DisplayCodeUnit)
                                Dim unitFormat As String = GetStr(cmd.ExecuteScalar())

                                If totalWeight > 0 AndAlso unitFactor > 0 Then
                                    totalWeight = totalWeight / unitFactor
                                Else
                                    totalWeight = 0
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = Format(Convert.ToDecimal(totalWeight), unitFormat) 'Format(totalWeight, unitFormat) 'totalWeight
                                response.Status = True
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("api/recipe/composition/actual/{codeliste:int}/{codetrans}/{ishtml}/{codesetprice}/{isdisplayingredient}/{isdisplayweightperc}")> _
        Public Function GetRecipeCompositionActual(codeliste As Integer, codetrans As Integer, ishtml As Boolean, codesetprice As Integer, isdisplayingredient As Boolean, isdisplayweightperc As Boolean) As Models.ResponseCallBack ' RBAJ-2014.04.04
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString & ", codetrans=" & codetrans.ToString & ", isHtml=" & ishtml.ToString & ", isDisplayIngredient=" & isdisplayingredient.ToString & ", isDisplayWeightPerc=" & isdisplayweightperc.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.Text
                                .CommandText = <sql>
												     DECLARE @strComposition AS NVARCHAR(4000);
													 SELECT @strComposition = dbo.[GetEULaw](@CodeListe,@IsHtml,@CodeTrans,@CodeSetPrice,@IsDisplayIngredient,@IsDisplayWeightPerc)
													 SELECT @strComposition AS Composition
											   </sql>.Value

                                .Connection.Open()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste)
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = GetInt(codetrans)
                                .Parameters.Add("@IsHtml", SqlDbType.Bit).Value = GetBool(ishtml)
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = GetInt(codesetprice)
                                .Parameters.Add("@IsDisplayIngredient", SqlDbType.Bit).Value = GetBool(isdisplayingredient)
                                .Parameters.Add("@IsDisplayWeightPerc", SqlDbType.Bit).Value = GetBool(isdisplayweightperc)

                                Dim strComposition As String = cmd.ExecuteScalar()

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = strComposition
                                response.Status = True
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("api/recipe/composition/swisslaw/{codeliste:int}/{codetrans}/{codesetprice}/{issubrecipe}")> _
        Public Function GetRecipeSwissLaw(codeliste As Integer, codetrans As Integer, codesetprice As Integer, issubrecipe As Boolean) As Models.ResponseCallBack ' ECAM-2015.07.27
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString & ", codetrans=" & codetrans.ToString & ", codesetprice=" & codesetprice.ToString & ", issubrecipe =" & issubrecipe.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.Text
                                .CommandText = <sql>
												     DECLARE @strComposition AS NVARCHAR(4000);
													 SELECT @strComposition = dbo.[GetSwissLaw](@CodeListe,@CodeTrans,@CodeSetPrice,@IsSubrecipe)
													 SELECT @strComposition AS Composition
											   </sql>.Value
                                .Connection.Open()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste)
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = GetInt(codetrans)
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = GetInt(codesetprice)
                                .Parameters.Add("@IsSubrecipe", SqlDbType.Bit).Value = GetBool(issubrecipe)

                                Dim strComposition As String = cmd.ExecuteScalar()

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = strComposition
                                response.Status = True
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("api/recipe/composition/genericlaw/{codeliste:int}/{codetrans}/{codesetprice}/{issubrecipe}/{comptype}")> _
        Public Function GetRecipeGenericLaw(codeliste As Integer, codetrans As Integer, codesetprice As Integer, issubrecipe As Boolean, compType As Integer) As Models.ResponseCallBack ' ECAM-2015.07.31
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString & ", codetrans=" & codetrans.ToString & ", codesetprice=" & codesetprice.ToString & ", issubrecipe =" & issubrecipe.ToString & ", compType =" & compType.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.Text
                                .CommandText = <sql>
												     DECLARE @strComposition AS NVARCHAR(4000);
													 SELECT @strComposition = dbo.[GetGenericLaw](@CodeListe,@CodeTrans,@CodeSetPrice,@IsSubrecipe,@CompType)
													 SELECT @strComposition AS Composition
											   </sql>.Value
                                .Connection.Open()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste)
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = GetInt(codetrans)
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = GetInt(codesetprice)
                                .Parameters.Add("@IsSubrecipe", SqlDbType.Bit).Value = GetBool(issubrecipe)
                                .Parameters.Add("@CompType", SqlDbType.Int).Value = GetInt(compType)

                                Dim strComposition As String = cmd.ExecuteScalar()

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = strComposition
                                response.Status = True
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("api/recipe/composition/getallsubingredients/{codeliste:int}/{codetrans}/{codesetprice}/{isdisplaypercentage}")> _
        Public Function GetAllSubIngredients(codeliste As Integer, codetrans As Integer, codesetprice As Integer, isdisplaypercentage As Boolean) As Models.ResponseCallBack ' ECAM-2015.08.11
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString & ", codetrans=" & codetrans.ToString & ", codesetprice=" & codesetprice.ToString & ", isdisplaypercentage =" & isdisplaypercentage.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.Text
                                .CommandText = <sql>
												     DECLARE @strComposition AS NVARCHAR(4000);
													 SELECT @strComposition = dbo.[GetAllSubIngredients](@CodeListe,@CodeTrans,@CodeSetPrice,@IsDisplayPercentage)
													 SELECT @strComposition AS Composition
											   </sql>.Value
                                .Connection.Open()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste)
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = GetInt(codetrans)
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = GetInt(codesetprice)
                                .Parameters.Add("@IsDisplayPercentage", SqlDbType.Bit).Value = GetBool(isdisplaypercentage)

                                Dim strComposition As String = cmd.ExecuteScalar()

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = strComposition
                                response.Status = True
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("api/recipe/composition/manorrezept/{codeliste:int}")> _
        Public Function ManorGetRezept(codeliste As Integer) As DataTable ' ECAM-2015.09.10
            Dim _dt As New DataTable
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "sp_ManorExportGetCompoARezept"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Connection.Open()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste)
                                .Parameters.Add("@GetAllergen", SqlDbType.Bit).Value = 1

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(_dt)


                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
            End Try
            Return _dt
        End Function

        <HttpGet> <[GET]("api/recipe/composition/manorautocompo/{codeliste:int}/{codetrans:int}")> _
        Public Function ManorAutoComposition(codeliste As Integer, codetrans As Integer) As DataTable ' ECAM-2015.09.10
            Dim _dt As New DataTable
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "sp_ManorGetRecipeAutoComposition"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Connection.Open()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste)
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = GetInt(codetrans)

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(_dt)


                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
            End Try
            Return _dt
        End Function

        <HttpGet> <[GET]("api/recipe/manorgetspecificdetermination/{codeliste:int}")> _
        Public Function ManorGetSpecificDetermination(codeliste As Integer) As DataTable ' ECAM-2015.09.10
            Dim _dt As New DataTable
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = <sql>
                                                SELECT largePortion FROM EgswListe WHERE Code = @CodeListe
                                                </sql>.Value
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                .Connection.Open()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste)

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(_dt)

                                .CommandText = <sql>
                                                SELECT descr_d, descr_f, descr_i FROM A_REZEPT WHERE rp_rp_id = @LargePortion
                                                </sql>.Value
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                Dim aaa As String = _dt.Rows(0).Item(0).ToString()
                                .Parameters.Add("@LargePortion", SqlDbType.VarChar).Value = _dt.Rows(0).Item(0).ToString()

                                _dt = New DataTable()
                                _da = New SqlDataAdapter(cmd)
                                _da.Fill(_dt)

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
            End Try
            Return _dt
        End Function

        <HttpGet> <[GET]("api/recipe/composition/manorgetapprovedreviewed/{codeliste:int}")> _
        Public Function ManorGetApprovedReviewed(codeliste As Integer) As DataTable ' ECAM-2015.09.10
            Dim _dt As New DataTable
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = <sql>
                                                SELECT * FROM a_rezept_recipecompo_approved WHERE CodeListe = @CodeListe
                                                </sql>.Value
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                .Connection.Open()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste)

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(_dt)

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
            End Try
            Return _dt
        End Function

        <HttpGet> <[GET]("api/recipe/getTranslationLanguage/{codetrans:int}")> _
        Public Function GetTranslationLanguage(codetrans As Integer) As Models.ResponseCallBack ' ECAM-2015.09.21
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codetrans.ToString)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = <sql>
                                        SELECT L.Language FROM
                                        EgswTranslation T
                                        INNER JOIN EgswLanguage L ON L.Code = T.CodeDictionary
                                        WHERE T.Code = @CodeTrans</sql>.Value
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                .Connection.Open()
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = GetInt(codetrans)
                                Dim Language As String = GetStr(cmd.ExecuteScalar())

                                'Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = Language
                                response.Status = True
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
            End Try
            Return response
        End Function

        Private Sub SavePictures()
            Try

                Dim strTempFolder As String = TempFolder2
                'If m_strClientSerial <> "" Then
                '    strTempFolder = IIf(strTempFolder.EndsWith("\"), strTempFolder, strTempFolder & "\") & m_strClientSerial & "\"
                'Else
                '    strTempFolder = IIf(strTempFolder.EndsWith("\"), strTempFolder, strTempFolder & "\")
                'End If

                If m_PictureNames IsNot Nothing AndAlso m_PictureNames.Trim.Length > 0 Then
                    Dim arrPictureNames() As String = m_PictureNames.Trim.Split(";")
                    m_PictureNames = String.Join(";", arrPictures)
                    If arrPictureNames.Length > 0 Then
                        For ctr As Integer = 0 To arrPictureNames.Length - 1
                            If arrPictureNames(ctr).Trim.Length > 0 Then

                                Dim pic As String = arrPictureNames(ctr)
                                Dim _source As String 'JDO 2014-03-26
                                If pic.Trim.IndexOf("| DAM") <> -1 Then

                                    pic = pic.Substring(0, pic.IndexOf("|")).Trim
                                    _source = DamFolder & pic
                                    File.Copy(_source, strTempFolder & arrPictures(ctr))
                                    pic = arrPictures(ctr)
                                End If
                                _source = strTempFolder & pic
                                If File.Exists(_source) And Not File.Exists(PicNormalFolder & pic) Then ''WVM-by pass if filename already exists in PicOriginalFolder

                                    'Save picoriginal
                                    File.Copy(_source, PicOriginalFolder & pic)
                                    '_source = PicOriginalFolder & pic
                                    'Save picnormal
                                    fctResizeConvertImage(_source, PicNormalFolder & pic, 300, 300, False)

                                    'Save picthumbnail
                                    fctResizeConvertImage(_source, PicThumbnailFolder & pic, 200, 200, False)
                                    Log.Info("Picture saved:" + _source)
                                End If
                            End If
                        Next
                    End If
                End If

                ''Remove pictures stored in the temp and those in picnormal, picthumbnail, picoriginal
                If m_TempPictureNames IsNot Nothing AndAlso m_TempPictureNames.Length > 0 Then
                    Dim arrPictureNames() As String = m_TempPictureNames.Trim.Split(";")
                    If arrPictureNames.Length > 0 Then
                        For Each pic As String In arrPictureNames

                            If pic.Trim.Length > 0 Then
                                If pic.Trim.LastIndexOf("| DAM") = -1 Then
                                    Dim _source As String = strTempFolder & pic
                                    If File.Exists(_source) Then
                                        File.Delete(_source)

                                    End If

                                    If m_PictureNames.IndexOf(pic) = -1 Then
                                        'Delete from picoriginal
                                        If File.Exists(PicOriginalFolder & pic) Then
                                            File.Delete(PicOriginalFolder & pic)
                                        End If

                                        'Delete from picnormal
                                        If File.Exists(PicNormalFolder & pic) Then
                                            File.Delete(PicNormalFolder & pic)
                                        End If

                                        'Delete from picthumbnail
                                        If File.Exists(PicThumbnailFolder & pic) Then
                                            File.Delete(PicThumbnailFolder & pic)
                                        End If
                                        Log.Info("Picture deleted:" + pic)
                                    End If

                                End If
                            End If

                        Next
                    End If
                End If

            Catch ex As Exception
                Log.Error("Save pictures failed: " & m_PictureNames, ex)
            End Try
        End Sub

        Private Sub SaveAttachments()
            Try
                Dim strFilesFolderForListe As String = FilesFolder
                Dim strTempFolder As String = TempFolder2

                'If m_strClientSerial <> "" Then
                '    strFilesFolderForListe = IIf(strFilesFolderForListe.EndsWith("\"), strFilesFolderForListe, strFilesFolderForListe & "\") & m_strClientSerial & "\" & m_intCodeListe.ToString & "\"
                '    strTempFolder = IIf(strTempFolder.EndsWith("\"), strTempFolder, strTempFolder & "\") & m_strClientSerial & "\"
                'Else
                '    strFilesFolderForListe = IIf(strFilesFolderForListe.EndsWith("\"), strFilesFolderForListe, strFilesFolderForListe & "\") & m_intCodeListe.ToString & "\"
                '    strTempFolder = IIf(strTempFolder.EndsWith("\"), strTempFolder, strTempFolder & "\")
                'End If

                strFilesFolderForListe = IIf(strFilesFolderForListe.EndsWith("\"), strFilesFolderForListe, strFilesFolderForListe & "\") & m_intCodeListe.ToString & "\"
                strTempFolder = IIf(strTempFolder.EndsWith("\"), strTempFolder, strTempFolder & "\")

                If m_Attachments IsNot Nothing AndAlso m_Attachments.Count > 0 Then
                    For Each a As Models.RecipeAttachment In m_Attachments
                        If a.Type = 0 AndAlso a.Resource.Trim.Length > 0 Then
                            Dim _source As String = strTempFolder & a.Resource
                            If File.Exists(_source) Then
                                'check if directory is existing, if not, create
                                If Directory.Exists(strFilesFolderForListe) = False Then
                                    Directory.CreateDirectory(strFilesFolderForListe)
                                End If
                                'Save to files folder
                                File.Copy(_source, strFilesFolderForListe & a.Resource)
                            End If
                        End If
                    Next
                End If

                ''Remove files stored in the temp and those in files folder
                If m_TempAttachments IsNot Nothing AndAlso m_TempAttachments.Length > 0 Then
                    Dim arrAttachments() As String = m_TempAttachments.Trim.Split(";")
                    If arrAttachments.Length > 0 Then
                        For Each a As String In arrAttachments
                            If a.Trim.Length > 0 Then
                                Dim _source As String = strTempFolder & a
                                If File.Exists(_source) Then
                                    File.Delete(_source)
                                End If

                                Dim delete As Boolean = True
                                If m_Attachments IsNot Nothing Then
                                    For Each a_del As Models.RecipeAttachment In m_Attachments
                                        If a_del.Type = 0 AndAlso a_del.Resource.Trim = a.Trim Then
                                            delete = False
                                            Exit For
                                        End If
                                    Next
                                End If

                                If delete Then
                                    'Delete from picoriginal
                                    If File.Exists(strFilesFolderForListe & a) Then
                                        File.Delete(strFilesFolderForListe & a)
                                    End If
                                End If
                            End If
                        Next
                    End If
                End If

            Catch ex As Exception
                Log.Error("Save attachment failed", ex)
            End Try
        End Sub

        '-WVM-2014.11.11-BEGIN
        Private Sub SaveVideos()
            Try

                Dim strTempFolder As String = TempFolder2
                If m_Videos.Trim.Length > 0 Then
                    Dim arrVideos() As String = m_Videos.Trim.Split(";")
                    m_Videos = String.Join(";", arrVideos)
                    If arrVideos.Length > 0 Then
                        For ctr As Integer = 0 To arrVideos.Length - 1
                            If arrVideos(ctr).Trim.Length > 0 Then

                                Dim video As String = arrVideos(ctr)
                                Dim _source As String

                                _source = strTempFolder & video
                                If File.Exists(_source) And Not File.Exists(VideoFolder & video) Then

                                    'Save 
                                    File.Copy(_source, VideoFolder & video)

                                    Log.Info("Video saved:" + _source)
                                End If
                            End If
                        Next
                    End If
                End If

                ''Remove videos stored in the temp and those in videos
                If m_TempVideos.Length > 0 Then
                    Dim arrVideos() As String = m_TempVideos.Trim.Split(";")
                    If arrVideos.Length > 0 Then
                        For Each video As String In arrVideos

                            If video.Trim.Length > 0 Then
                                If video.Trim.LastIndexOf("| DAM") = -1 Then
                                    Dim _source As String = strTempFolder & video
                                    If File.Exists(_source) Then
                                        File.Delete(_source)

                                    End If

                                    If m_Videos.IndexOf(video) = -1 Then
                                        'Delete from Video Folder
                                        If File.Exists(VideoFolder & video) Then
                                            File.Delete(VideoFolder & video)
                                        End If

                                        Log.Info("Video deleted:" + video)
                                    End If

                                End If
                            End If

                        Next
                    End If
                End If

            Catch ex As Exception
                Log.Error("Save videos failed", ex)
            End Try
        End Sub
        '-WVM-2014.11.11-END.

        Public ReadOnly Property TempFolder2() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("temp")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("temp")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property DamFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("dam")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("DigitalAssets")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property PicNormalFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("picnormal")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("picnormal")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property PicThumbnailFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("picthumbnail")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("picthumbnail")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property PicOriginalFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("picoriginal")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("picoriginal")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property FilesFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("files")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("files")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property VideoFolder() As String
            Get
                Dim tmp As String = GetStr(ConfigurationManager.AppSettings("video")).Trim()
                If tmp.Equals(String.Empty) Then
                    tmp = Common.MapPath("video")
                End If
                Return tmp.TrimEnd("\") + "\"
            End Get
        End Property

        Public ReadOnly Property PicSrc() As String
            Get
                Return ConfigurationManager.AppSettings("picsrc")
            End Get
        End Property

        Private Function fctResizeConvertImage(ByVal strFile As String, _
                                               ByVal strDestination As String, _
                                               ByVal newWidth As Integer, _
                                               ByVal newHeight As Integer, _
                                               Optional ByVal blnDelete As Boolean = False) As Boolean
            Try
                Dim dblTempW As Double
                Dim dblTempH As Double
                Dim H1 As Integer
                Dim W1 As Integer
                Dim strNewFile As String

                Dim FileToResize As String = strFile 'Server.MapPath("~/images/1.jpg")
                Dim originalBitmap As Bitmap = Bitmap.FromFile(FileToResize, True)
                Dim WidthVsHeightRatio = CDec(originalBitmap.Height) / CDec(originalBitmap.Width)

                If newHeight > newWidth Then
                    dblTempH = CDbl(newHeight)
                    dblTempW = dblTempH / WidthVsHeightRatio
                Else
                    dblTempW = CDbl(newWidth)
                    dblTempH = dblTempW * WidthVsHeightRatio
                End If
                Do While (dblTempW > CDbl(newWidth) Or dblTempH > CDbl(newHeight))
                    dblTempW = (dblTempW * 0.999)
                    dblTempH = (dblTempH * 0.999)
                Loop
                W1 = CInt(dblTempW)
                H1 = CInt(dblTempH)

                Dim newbmp As Bitmap = New Bitmap(W1, H1)
                Using newg As Graphics = Graphics.FromImage(newbmp)
                    newg.SmoothingMode = Drawing2D.SmoothingMode.HighQuality
                    newg.Clear(Color.White)
                    newg.DrawImage(originalBitmap, 0, 0, W1, H1)
                    newg.Save()
                End Using
                strNewFile = Replace(Path.GetFileName(strFile), Path.GetExtension(strFile), ".jpg")
                newbmp = RotateImage(newbmp, originalBitmap)
                newbmp.Save(strDestination, System.Drawing.Imaging.ImageFormat.Jpeg)
                originalBitmap.Dispose()
                If blnDelete Then File.Delete(strFile)

            Catch ex As Exception
                Log.Error("ResizeConvertImage failed", ex)
                Return False
            End Try
            Return True
        End Function

        Public Function RotateImage(bmp As Bitmap, originalbmp As Bitmap) As Bitmap
            Dim rft As RotateFlipType = RotateFlipType.RotateNoneFlipNone
            Dim img As Bitmap = bmp
            Dim imgOrig As Bitmap = originalbmp
            Dim properties As PropertyItem() = imgOrig.PropertyItems
            Dim bReturn As Boolean = False
            For Each p As PropertyItem In properties
                If p.Id = 274 Then
                    Dim orientation As Short = BitConverter.ToInt16(p.Value, 0)
                    Select Case orientation
                        Case 1
                            rft = RotateFlipType.RotateNoneFlipNone
                        Case 3
                            rft = RotateFlipType.Rotate180FlipNone
                        Case 6
                            rft = RotateFlipType.Rotate90FlipNone
                        Case 8
                            rft = RotateFlipType.Rotate270FlipNone
                    End Select
                End If
            Next
            If rft <> RotateFlipType.RotateNoneFlipNone Then
                img.RotateFlip(rft)
                'System.IO.File.Delete(sImageFilePath)
                'img.Save(sImageFilePath, System.Drawing.Imaging.ImageFormat.Jpeg)
                bReturn = True
            End If
            Return img
        End Function

        <HttpPost> <POST("api/recipe/checkout")> _
        Public Function CheckOut(data As Models.RecipeCheckout) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Using cmd As New SqlCommand
                    If data Is Nothing Then
                        Throw (New ArgumentNullException("recipe data is empty"))
                    End If

                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = <sql>
                                               UPDATE EgswListe SET CheckOutUser=@CodeUser, sLastAccess=GETDATE() WHERE Code=@CodeListe
                                           </sql>.Value
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(data.CodeListe, -1)
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = GetInt(data.CodeUser, 0)
                                .Connection.Open()
                                .ExecuteNonQuery()

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = data.CodeListe
                                response.Status = True
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), aex.Message.ToString(), aex.StackTrace.ToString(), "Recipe")
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), hex.Message.ToString(), hex.StackTrace.ToString(), "Recipe")
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Recipe")
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("/api/recipe/ischeckout/{codeliste:int}")> _
        Public Function IsCheckout(codeliste As Integer) As Models.GenericList
            Dim result As New Models.GenericList
            Try
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.Text
                                .CommandText = <sql>
                                       SELECT @CodeUser = ISNULL(CheckOutUser,0) FROM [dbo].[EgswListe] WITH(NOLOCK) WHERE Code = @CodeListe
                                   </sql>.Value ' RBAJ-2014.01.21 Added with nolock
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = GetInt(codeliste, -1)
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Direction = ParameterDirection.Output
                                cn.Open()
                                .ExecuteNonQuery()

                                ' Done without errors
                                result.Code = GetInt(.Parameters("@CodeUser").Value, -1)
                                result.Value = ""
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
            Return result
        End Function

        <HttpGet> <[GET]("/api/recipelink/{codetrans:int}/{codeliste:int}/{link:int}")> _
        Public Function GetRelatedRecipes(codetrans As Integer, _
                                 codeliste As Integer, link As Integer) As Object
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try

                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_RecipeRelated]"
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@link", SqlDbType.Int).Value = link
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                If link > 0 Then
                    Dim recipes As New List(Of Models.GenericTree)
                    For Each r In ds.Tables(0).Rows
                        recipes.Add(New Models.GenericTree With {
                                        .Code = GetInt(r("Code")), _
                                        .Name = GetStr(r("Name")), _
                                        .ParentCode = GetInt(r("ParentCode")), _
                                        .link = GetStr(r("Link")), _
                                        .Flagged = GetBool(r("Flag")), _
                                        .Note = GetStr(r("Note"))})

                    Next

                    Dim recipelistdata As New List(Of Models.TreeNode)

                    Dim parents = recipes.Where(Function(obj) obj.ParentCode = Nothing).OrderBy(Function(obj) obj.Name).ToList()

                    For Each p In parents
                        If recipelistdata.Where(Function(obj) obj.key = p.Code).Count = 0 Then
                            Dim parent As New Models.TreeNode
                            parent.title = p.Name
                            parent.key = p.Code
                            parent.icon = False
                            parent.children = CreateChildren(recipes, p.Code)
                            parent.select = p.Flagged
                            parent.selected = p.Flagged
                            parent.parenttitle = p.ParentName
                            parent.note = p.Note
                            parent.link = p.link
                            recipelistdata.Add(parent)
                        End If
                    Next

                    Return recipelistdata
                Else
                    Dim result As New List(Of Models.GenericCodeValueList)
                    For Each r In ds.Tables(0).Rows
                        result.Add(New Models.GenericCodeValueList With {
                                        .Code = GetInt(r("Code")), _
                                        .Value = GetStr(r("Name"))})

                    Next
                    Return result
                End If

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        'START - Raqi Pinili 09.03.2015
        '<HttpPost> <[POST]("/api/recipelink/{codetrans:int}/{codeliste:int}/{link:int}")> _
        <HttpPost> <[POST]("/api/recipelink/search")> _
        Public Function GetRelatedRecipes(data As Models.ConfigurationcSearch) As Object
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try

                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_RecipeRelated]"
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = data.CodeTrans
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = data.CodeListe
                                .Parameters.Add("@link", SqlDbType.Int).Value = data.Link
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                If ds.Tables.Count > 0 Then
                    If data.Link > 0 Then
                        Dim recipes As New List(Of Models.GenericTree)
                        For Each r In ds.Tables(0).Rows
                            recipes.Add(New Models.GenericTree With {
                                            .Code = GetInt(r("Code")), _
                                            .Name = GetStr(r("Name")), _
                                            .ParentCode = GetInt(r("ParentCode")), _
                                            .link = GetStr(r("Link")), _
                                            .Flagged = GetBool(r("Flag")), _
                                            .Note = GetStr(r("Note"))})

                        Next

                        Dim recipelistdata As New List(Of Models.TreeNode)

                        Dim parents = recipes.Where(Function(obj) obj.ParentCode = Nothing).OrderBy(Function(obj) obj.Name).ToList()

                        For Each p In parents
                            If recipelistdata.Where(Function(obj) obj.key = p.Code).Count = 0 Then
                                Dim parent As New Models.TreeNode
                                parent.title = p.Name
                                parent.key = p.Code
                                parent.icon = False
                                parent.children = CreateChildren(recipes, p.Code)
                                parent.select = p.Flagged
                                parent.selected = p.Flagged
                                parent.parenttitle = p.ParentName
                                parent.note = p.Note
                                parent.link = p.link
                                recipelistdata.Add(parent)
                            End If
                        Next

                        Return recipelistdata
                    Else
                        Dim result As New List(Of Models.GenericList)
                        For Each r In ds.Tables(0).Rows
                            result.Add(New Models.GenericList With {
                                            .Code = GetInt(r("Code")), _
                                            .Value = GetStr(r("Name"))})

                        Next
                        Return result
                    End If
                End If


            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function
        'END - Raqi Pinili 09.03.2015

        <HttpGet> <[GET]("/api/merchandiselink/{codetrans:int}/{codeliste:int}/{link:int}")> _
        Public Function GetListRecipes(codetrans As Integer, _
                                 codeliste As Integer, link As Integer) As Object
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try

                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_RecipeRelated]"
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@link", SqlDbType.Int).Value = link
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                If ds.Tables.Count > 0 Then
                    If link > 0 Then
                        Dim recipes As New List(Of Models.GenericTree)
                        For Each r In ds.Tables(0).Rows
                            recipes.Add(New Models.GenericTree With {
                                            .Code = GetInt(r("Code")), _
                                            .Name = GetStr(r("Name")), _
                                            .ParentCode = GetInt(r("ParentCode")), _
                                            .link = GetStr(r("Link")), _
                                            .Note = GetStr(r("Note"))})

                        Next

                        Dim recipelistdata As New List(Of Models.TreeNode)

                        Dim parents = recipes.Where(Function(obj) obj.ParentCode = Nothing).OrderBy(Function(obj) obj.Name).ToList()

                        For Each p In parents
                            If recipelistdata.Where(Function(obj) obj.key = p.Code).Count = 0 Then
                                Dim parent As New Models.TreeNode
                                parent.title = p.Name
                                parent.key = p.Code
                                parent.icon = False
                                parent.children = CreateChildren(recipes, p.Code)
                                parent.select = p.Flagged
                                parent.parenttitle = p.ParentName
                                parent.note = p.Note
                                parent.link = p.link
                                recipelistdata.Add(parent)
                            End If
                        Next

                        Return recipelistdata
                    Else
                        Dim result As New List(Of Models.GenericList)
                        For Each r In ds.Tables(0).Rows
                            result.Add(New Models.GenericList With {
                                            .Code = GetInt(r("Code")), _
                                            .Value = GetStr(r("Name"))})

                        Next
                        Return result
                    End If
                End If


            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        Private Function CreateChildren(_recipe As List(Of Models.GenericTree),
                                        _code As Integer) As List(Of Models.TreeNode)

            Dim children As New List(Of Models.TreeNode)

            If _recipe IsNot Nothing Then
                Dim kids = _recipe.Where(Function(obj) obj.Code <> _code And obj.ParentCode = _code And _code > 0).OrderBy(Function(obj) obj.Name).ToList()

                For Each k In kids
                    Dim child As New Models.TreeNode
                    child.title = k.Name
                    child.key = k.Code
                    child.icon = False
                    child.children = CreateChildren(_recipe, k.Code)
                    children.Add(child)
                    child.select = k.Flagged
                    child.parenttitle = k.ParentName
                    child.note = k.Note
                    child.link = k.link
                Next
            End If

            Return children

        End Function

        <HttpGet> <[GET]("/api/listefiles/{firstcode?}/{secondcode?}/{type?}")> _
        Public Function GetListeFiles(Optional firstcode As Integer = -1, Optional secondcode As Integer = -1, Optional type As Integer = -1) As Object
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try

                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_ListeFiles]"
                                .Parameters.Add("@FirstCode", SqlDbType.Int).Value = firstcode
                                .Parameters.Add("@SecondCode", SqlDbType.Int).Value = secondcode
                                .Parameters.Add("@type", SqlDbType.Int).Value = type
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim listefiles As New List(Of Models.ListeFiles)
                For Each r In ds.Tables(0).Rows
                    listefiles.Add(New Models.ListeFiles With {
                                    .Code = GetInt(r("Code")), _
                                    .Pictures = GetStr(r("Pictures")), _
                                    .Videos = GetStr(r("Videos"))})

                Next

                Return listefiles

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/ispriceused/{intID?}")> _
        Public Function IsPriceUsed(ByVal intID As Integer) As Boolean
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try

                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[sp_egswIsPriceUsed]"
                                .Parameters.Add("@intID", SqlDbType.Int).Value = intID
                                .Parameters.Add("@IsUsed", SqlDbType.Int).Direction = ParameterDirection.Output
                                cn.Open()

                                .ExecuteNonQuery()

                                Return CBool(.Parameters("@IsUsed").Value)

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using


            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/recipelabel/{codeliste?}")> _
        Public Function GetRecipeLabel(ByVal codeliste As Integer) As Models.Label
            Try
                Dim ds As New DataSet
                Dim label As New Models.Label
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try

                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Labels]"
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                cn.Open()

                                Using dr As SqlDataReader = cmd.ExecuteReader()
                                    If dr.HasRows Then
                                        While dr.Read
                                            With label
                                                .Code = GetInt(dr("Code"))
                                                .CodeListe = GetInt(dr("CodeListe"))
                                                .DeclarationName = GetStr(dr("DeclarationName"))
                                                .SpecificDetermination = GetStr(dr("SpecificDetermination"))
                                                .Number = GetStr(dr("Number"))
                                                .Barcode = GetStr(dr("Barcode"))
                                                .Consumption = GetDbl(dr("Consumption"))
                                                .Sold = GetDbl(dr("Sold"))
                                                .Composition = GetStr(dr("Composition"))
                                                .Weight = GetDbl(dr("Weight"))
                                                .Price = GetDbl(dr("Price"))
                                                .PriceFor = GetDbl(dr("PriceFor"))
                                                .Calculated = GetDbl(dr("Calculated"))
                                                .Unit = GetInt(dr("Unit"))
                                                .Note1 = GetInt(dr("Note1"))
                                                .Note2 = GetInt(dr("Note2"))
                                                .Note3 = GetInt(dr("Note3"))
                                                .Certification = GetInt(dr("Certification"))
                                                .CountryOfProduction = GetInt(dr("CountryOfProduction"))
                                                .PackagingMethod = GetInt(dr("PackagingMethod"))
                                                .Storage = GetInt(dr("Storage"))
                                            End With
                                        End While
                                    End If
                                End Using

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Return label
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/recipelabelcomposition/{codeliste?}")> _
        Public Function GetRecipeLabelComposition(ByVal codeliste As Integer) As List(Of Models.LabelComposition)
            Try
                Dim ds As New DataSet
                'Dim labelComposition As New Models.LabelComposition
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_LabelsComposition]"
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using
                'Using dr As SqlDataReader = cmd.ExecuteReader()
                '    If dr.HasRows Then
                '        While dr.Read
                '            With labelComposition
                '                .CodeListe = GetInt(dr("CodeListe"))
                '                .CompoType = GetInt(dr("CompoType"))
                '                .ImposedComposition = GetStr(dr("ImposedComposition"))
                '            End With
                '        End While
                '    End If
                'End Using

                Dim labelComposition As New List(Of Models.LabelComposition)
                For Each lc In ds.Tables(0).Rows
                    labelComposition.Add(New Models.LabelComposition With {
                                .CodeListe = GetInt(lc("CodeListe")), _
                                .CodeTrans = GetInt(lc("CodeTrans")), _
                                .CompoType = GetInt(lc("CompoType")), _
                                .ImposedComposition = GetStr(lc("ImposedComposition")), _
                                .IsValidated = GetBool(lc("IsValidated"))})
                Next

                Return labelComposition.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        ''IAA 01.11.2016
        <HttpGet> <[GET]("/api/recipe/composition/export/{codeliste}/{formattype}")> _
        Public Function GetExportedComposition(ByVal codeliste As Integer, ByVal formattype As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": codeliste=" & codeliste.ToString & ", formatType=" & formattype.ToString)

                Dim Report As New EGSTelerikReport.Manor
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[sp_ManorExportGetCompoForLabel]"
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@PosVersion", SqlDbType.Bit).Value = 0
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = Report.GetReportComposition(ds, formattype, FolderPath, ReportURL)
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("/api/recipelabelsalessite/{codeuser?}")> _
        Public Function GetRecipeLabelSalesSite(ByVal codeuser As Integer) As List(Of Models.LabelSalesSite)
            Try
                Dim _dt As New DataTable
                'Dim labelComposition As New Models.LabelComposition
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = <sql>
                                                SELECT CodeSalesSite FROM EgswUser WHERE Code = @CodeUser
                                                </sql>.Value
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                .Connection.Open()
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = GetInt(codeuser)

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(_dt)

                                .CommandText = <sql>
                                               SELECT * FROM dbo.EgswSalesSite WHERE Code = @CodeSalesSite
                                                </sql>.Value
                                .CommandType = CommandType.Text
                                .Parameters.Clear()
                                Dim aaa As String = _dt.Rows(0).Item(0).ToString()
                                .Parameters.Add("@CodeSalesSite", SqlDbType.VarChar).Value = _dt.Rows(0).Item(0).ToString()

                                _dt = New DataTable()
                                _da = New SqlDataAdapter(cmd)
                                _da.Fill(_dt)

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

                Dim labelSalesSite As New List(Of Models.LabelSalesSite)
                For Each lsS In _dt.Rows
                    labelSalesSite.Add(New Models.LabelSalesSite With {
                                .Code = GetInt(lsS("Code")), _
                                .LocationNumber = GetStr(lsS("LocationNumber")), _
                                .Name = GetStr(lsS("Name")), _
                                .Street = GetStr(lsS("Street")), _
                                .ZipCode = GetInt(lsS("ZipCode")), _
                                .City = GetStr(lsS("City")), _
                                .CertificationID = GetStr(lsS("CertificationID")), _
                                .IsProductionLocation = GetBool(lsS("IsProductionLocation")), _
                                .IsSalesSite = GetBool(lsS("IsSalesSite"))})
                Next

                Return labelSalesSite.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        ''IAA 01.11.2016
        <HttpGet> <[GET]("/api/recipe/manor/exporttoexcel/{codesite}")> _
        Public Function GetExportedComposition(ByVal codesite As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.Manor
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            .Connection = cn
                            .CommandType = CommandType.StoredProcedure
                            .CommandTimeout = 1000
                            .CommandText = "[dbo].[GetManorExportToExcel]"
                            .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                            cn.Open()

                            Dim _da As New SqlDataAdapter(cmd)
                            _da.Fill(ds)

                            ' Done without errors
                            response.Code = 0
                            response.Message = "OK"
                            response.ReturnValue = Report.GetExportToExcel(ds, FolderPath, ReportURL)
                            response.Status = True
                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        ''IAA 02.05.2016
        <HttpGet> <[GET]("/api/recipe/msc/report/foodandbeverage/{codeliste?}/{codesite?}/{codetrans?}/{isfood?}/{baseurl?}")> _
        Public Function GetMSCFoodAndBeverageReport(ByVal codeliste As Integer, ByVal codesite As Integer, ByVal codetrans As Integer, ByVal isfood As Boolean, ByVal baseurl As String) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.MSC
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_Catalog_FoodAndBeverage]"
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                If isfood = True Then
                                    result = Report.GetReportFood(ds, FolderPath, ReportURL)
                                Else
                                    result = Report.GetReportBeverage(ds, FolderPath, ReportURL)
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        ''IAA 02.05.2016
        <HttpGet> <[GET]("/api/recipe/msc/report/menucostweekly/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{codesetprice?}/{culture?}/{byPortion?}/{days?}/{CodeUser?}")> _
        Public Function GetMSCMenuCostWeeklyReport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer, ByVal baseurl As String,
                                                   ByVal codesetprice As Integer, ByVal culture As String, ByVal byPortion As Integer, ByVal days As Integer, ByVal CodeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.MSC
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(CodeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_MSC_MenuCostingWeekly]"
                                .Parameters.Add("@CodeMainMenu", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@CodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                '.Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = codesetprice
                                .Parameters.Add("@Culture", SqlDbType.VarChar).Value = culture
                                .Parameters.Add("@ByPortion", SqlDbType.Bit).Value = byPortion
                                .Parameters.Add("@Days", SqlDbType.Int).Value = days
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = CodeUser
                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                'ds.Tables(0).Columns.Add("Culture")

                                'For c As Integer = 0 To ds.Tables(0).Rows.Count - 1
                                '    ds.Tables(0).Rows(c)("Culture") = culture.ToString
                                'Next

                                result = Report.GetReportMenuCostWeekly(ds, FolderPath, ReportURL)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        ''IAA 02.05.2016
        <HttpGet> <[GET]("/api/recipe/msc/report/menucostsummary/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{codesetprice?}/{culture?}/{byPortion?}/{days?}/{CodeUser?}")> _
        Public Function GetMSCMenuCostSummaryReport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer, ByVal baseurl As String,
                                                    ByVal codesetprice As Integer, ByVal culture As String, ByVal byPortion As Integer, ByVal days As Integer, ByVal CodeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.MSC
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(CodeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_MSC_MenuCostingSummary]"
                                .Parameters.Add("@CodeMainMenu", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@CodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                '.Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                .Parameters.Add("@CodeSetPrice", SqlDbType.Int).Value = codesetprice
                                .Parameters.Add("@Culture", SqlDbType.VarChar).Value = culture
                                .Parameters.Add("@ByPortion", SqlDbType.Bit).Value = byPortion
                                .Parameters.Add("@Days", SqlDbType.Int).Value = days
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = CodeUser

                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                'ds.Tables(0).Columns.Add("Culture")

                                'For c As Integer = 0 To ds.Tables(0).Rows.Count - 1
                                '    ds.Tables(0).Rows(c)("Culture") = culture.ToString
                                'Next

                                result = Report.GetReportMenuCostSummary(ds, FolderPath, ReportURL)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("/api/recipe/msc/report/menunutrientdetails/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{codeNutrientSet?}/{culture?}/{CodeUser?}")> _
        Public Function GetMSCMenuNutrientDetailsReport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer, ByVal baseurl As String,
                                                        ByVal codeNutrientSet As Integer, ByVal culture As String, ByVal CodeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.MSC
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(CodeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_MSC_MenuNutrientDetails]"
                                .Parameters.Add("@CodeMainMenu", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@CodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                .Parameters.Add("@codeNutrientSet", SqlDbType.Int).Value = codeNutrientSet
                                .Parameters.Add("@UserCulture", SqlDbType.VarChar).Value = culture
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = CodeUser
                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                'ds.Tables(0).Columns.Add("UserCulture")

                                'For c As Integer = 0 To ds.Tables(0).Rows.Count - 1
                                '    ds.Tables(0).Rows(c)("UserCulture") = culture.ToString
                                'Next

                                result = Report.GetReportMenuPlanNutrientDetail(ds, FolderPath, ReportURL)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        ''IAA 07.27.2016
        <HttpGet> <[GET]("/api/recipe/msc/report/menureciperepetition/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{CodeUser?}")> _
        Public Function GetMSCMenuRecipeRepetitionReport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer, ByVal baseurl As String, ByVal CodeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.MSC
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(CodeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_MSC_Menu_RecipeRepetition]"
                                .Parameters.Add("@CodeMainMenu", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@CodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = CodeUser

                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                result = Report.GetReportMenuRecipeRepetition(ds, FolderPath, ReportURL)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        ''IAA 07.27.2016
        <HttpGet> <[GET]("/api/recipe/msc/report/menuingredientrepetition/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{CodeUser?}")> _
        Public Function GetMSCMenuIngredientRepetitionReport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer, ByVal baseurl As String, ByVal CodeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.MSC
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(CodeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_MSC_Menu_IngredientRepetition]"
                                .Parameters.Add("@CodeMainMenu", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@CodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = CodeUser

                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                result = Report.GetReportMenuIngredientRepetition(ds, FolderPath, ReportURL)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        ''IAA 07.27.2016
        <HttpGet> <[GET]("/api/recipe/msc/export/menurecipekeyword/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{CodeUser?}")> _
        Public Function GetMSCMenuRecipeKeywordExport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer, ByVal baseurl As String, ByVal CodeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.MSC
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(CodeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandTimeout = 300
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_MSC_Menu_Export_RecipeKeyword]"
                                .Parameters.Add("@CodeMainMenu", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@CodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = CodeUser
                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                result = Report.GetExportMenuRecipeKeyword(ds, FolderPath, ReportURL)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        ''IAA 07.27.2016
        <HttpGet> <[GET]("/api/recipe/msc/export/menurecipecost/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{codeSetPrice}/{culture?}/{CodeUser?}")> _
        Public Function GetMSCMenuRecipeCostExport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer, _
                                                   ByVal baseurl As String, ByVal codeSetPrice As Integer, ByVal culture As String, ByVal CodeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.MSC
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(CodeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandTimeout = 300
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_MSC_Menu_Export_RecipeCost]"
                                .Parameters.Add("@CodeMainMenu", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@CodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                .Parameters.Add("@CodeSetPrice", SqlDbType.VarChar).Value = codeSetPrice
                                .Parameters.Add("@UserCulture", SqlDbType.VarChar).Value = culture
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = CodeUser
                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                result = Report.GetExportMenuRecipeCost(ds, FolderPath, ReportURL)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("/api/recipe/coop/export/recipemenulocal/{coderestaurant?}/{codeSetPrice?}/{idMain?}/{codeMenuPlan?}/{codetrans}/{dateFrom?}/{dateTo?}/{codeUser}")>
        Public Function GetRecipeMenuRecipeLocalExport(ByVal coderestaurant As Integer, ByVal codeSetPrice As Integer, ByVal idMain As Integer,
                                                   ByVal codeMenuPlan As Integer, ByVal codetrans As Integer, ByVal dateFrom As DateTime, ByVal dateTo As DateTime, ByVal codeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.Coop
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(codeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[MP_GETPRINT_COOP_RECIPEMENULOCAL]"
                                .Parameters.Add("@intRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@intMenuplan", SqlDbType.Int).Value = codeMenuPlan
                                .Parameters.Add("@intCodetrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@intCodeSetPrice", SqlDbType.Int).Value = codeSetPrice
                                .Parameters.Add("@intIdMain", SqlDbType.Int).Value = idMain
                                .Parameters.Add("@startData", SqlDbType.DateTime).Value = dateFrom
                                .Parameters.Add("@endDate", SqlDbType.DateTime).Value = dateTo
                                cn.Open()


                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                Dim picturePath = Replace(System.Configuration.ConfigurationManager.AppSettings("picnormal").ToLower, "picnormal", "Images\Menuplan")
                                If Not picturePath.EndsWith("\") Then picturePath += "\"

                                result = Report.GetReportRecipeMenuLocal(ds, FolderPath, ReportURL, picturePath)


                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("/api/recipe/rehaclinic/report/menuplan/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{culture?}")> _
        Public Function GetRehaClinicMenuPlanReport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer, ByVal baseurl As String, ByVal culture As String) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.RehaClinic
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Report_RehaClinic_MenuPlan]"
                                .Parameters.Add("@CodeMainMenu", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@CodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl
                                .Parameters.Add("@Culture", SqlDbType.VarChar).Value = culture

                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                result = Report.GetReportMenuPlan(ds, FolderPath, ReportURL)

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        '//LD20160805 MenuPlan Report Week and Days - for Kapo Zurich
        <HttpGet> <[GET]("/api/recipe/msc/report/menuplanWeekAndDayReport/{codemainmenu?}/{coderestaurant?}/{codetrans?}/{baseurl?}/{codesetprice?}")> _
        Public Function GetCMMenuPlanWeekAndDayReport(ByVal codemainmenu As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer,
                                                        ByVal baseurl As String, ByVal codesetprice As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.KapoZurich
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_REPORT_MenuPlanWeekAndDays]"

                                .Parameters.Add("@intIDMain", SqlDbType.Int).Value = codemainmenu
                                .Parameters.Add("@intCodeRestaurant", SqlDbType.Int).Value = coderestaurant
                                .Parameters.Add("@intCodeSetPrice", SqlDbType.Int).Value = codesetprice
                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = codetrans

                                '.Parameters.Add("@BaseURL", SqlDbType.VarChar).Value = baseurl

                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                result = Report.GetMenuPlanWeekAndDay(ds, FolderPath, ReportURL, "PDF")

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        'Public Function GetUserClientSerial(intCodeUser As Integer) As String
        '    Dim strClientSerial As String = ""
        '    Try
        '        If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ": CodeUser - " + intCodeUser.ToString)

        '        Using cmd As New SqlCommand
        '            With cmd
        '                Using cn As New SqlConnection(ConnectionString)
        '                    Try
        '                        .Connection = cn
        '                        .CommandText = "[fn_EgswGetClientSerial]"
        '                        .CommandType = CommandType.Text
        '                        .Parameters.Clear()
        '                        .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = intCodeUser
        '                        .Connection.Open()


        '                        strClientSerial = .ExecuteScalar()

        '                    Finally
        '                        If Not cn Is Nothing Then
        '                            cn.Close()
        '                            CType(cn, IDisposable).Dispose()
        '                        End If
        '                    End Try
        '                End Using
        '            End With
        '        End Using
        '    Catch aex As ArgumentException
        '        Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
        '    Catch hex As HttpResponseException
        '        Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
        '        Throw hex
        '    Catch ex As Exception
        '        Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
        '    End Try
        '    Return strClientSerial
        'End Function

        Private Function GetUserClientSerial(p1 As Integer) As String
            Throw New NotImplementedException
        End Function

        'Private Sub EmailNotification()
        '    Try
        '        Dim cMail As New clsMail(enumAppType.WebApp, Connection)
        '        Dim cConfig As New clsConfig(enumAppType.WebApp, Connection)
        '        Dim udtUser As structUser = UserProfile
        '        Dim strSmtpServer As String = cConfig.GetConfig(clsConfig.CodeUser.global, clsConfig.enumNumeros.SMTPServer, clsConfig.CodeGroup.global, System.Configuration.ConfigurationManager.AppSettings("SMTPServer"))
        '        Dim intSmtpPort As Integer = cConfig.GetConfig(clsConfig.CodeUser.global, clsConfig.enumNumeros.SMTPPort, clsConfig.CodeGroup.global, System.Configuration.ConfigurationManager.AppSettings("SMTPPort"))
        '        Dim strSenderEmail As String = cConfig.GetConfig(clsConfig.CodeUser.global, clsConfig.enumNumeros.SMTPEmailSender, clsConfig.CodeGroup.global, "info@eg-software.com")
        '        Dim strCodeUser As String = ""

        '        Dim cUser As New clsUser(enumAppType.WebApp, Connection, enumEgswFetchType.DataReader)
        '        Dim drApprovers As SqlDataReader = cUser.GetApprovers
        '        Dim strApproversEmail As String = ""

        '        Dim strUrl As String = Url
        '        If strUrl.IndexOf("/") > -1 Then strUrl = Left(strUrl, strUrl.LastIndexOf("/")) & "/Default.aspx?type=4"

        '        Dim cConfig2 As clsConfig = New clsConfig(enumAppType.WebApp, Connection, enumEgswFetchType.DataTable)
        '        Dim dtMsgTrans As DataTable = cConfig2.GetApprovalMessage()

        '        'Email 1
        '        If Not drApprovers Is Nothing Then
        '            While drApprovers.Read
        '                If cMail.SendMail("Calcmenu Web", strSenderEmail, drApprovers("email").ToString.Trim, drApprovers("email").ToString.Trim, subTitle(tListe.Name, 1, , drApprovers("CodeTrans"), dtMsgTrans), subMessage(udtUser.Fullname, IIf(CIntDB(drApprovers("CodeTrans")) = 3, "Approbateur", "Approver"), tListe.Name, 1, strUrl, CIntDB(drApprovers("CodeTrans")), dtMsgTrans), "", True, strSmtpServer, intSmtpPort) = enumEgswErrorCode.OK Then
        '                    'If cMail.SendMail("Calcmenu Web", strSenderEmail, drApprovers("email").ToString.Trim, drApprovers("email").ToString.Trim, IIf(CIntDB(drApprovers("CodeTrans")) = 3, "Recette d'approbation pour ", "Recipe Approval for ") & tListe.Name, subMessage(udtUser.Fullname, IIf(CIntDB(drApprovers("CodeTrans")) = 3, "Approbateur", "Approver"), tListe.Name, 1, strUrl, CIntDB(drApprovers("CodeTrans")), dtMsgTrans), "", True, strSmtpServer, intSmtpPort) = enumEgswErrorCode.OK Then
        '                    'subTitle
        '                End If
        '            End While
        '        End If
        '        drApprovers.Close()
        '        'Email 2
        '        'If cMail.SendMail("Calcmenu Web", strSenderEmail, udtUser.Email, udtUser.Email, IIf(udtUser.CodeTrans = 3, "Recette d'approbation pour ", "Recipe Approval for ") & tListe.Name, subMessage(udtUser.Fullname, IIf(CIntDB(udtUser.CodeTrans) = 3, "Approbateur", "Approver"), tListe.Name, 2, , udtUser.CodeTrans, dtMsgTrans), "", True, strSmtpServer, intSmtpPort) = enumEgswErrorCode.OK Then
        '        If cMail.SendMail("Calcmenu Web", strSenderEmail, udtUser.Email, udtUser.Email, subTitle(tListe.Name, 1, , udtUser.CodeTrans, dtMsgTrans), subMessage(udtUser.Fullname, IIf(CIntDB(udtUser.CodeTrans) = 3, "Approbateur", "Approver"), tListe.Name, 2, , udtUser.CodeTrans, dtMsgTrans), "", True, strSmtpServer, intSmtpPort) = enumEgswErrorCode.OK Then
        '        End If
        '    Catch ex As Exception

        '    End Try
        'End Sub

        <HttpGet> <[GET]("/api/recipe/allergen/trace/{codeliste}/{codetrans?}/{foodlaw?}")> _
        Public Function GetAllergenTraces(ByVal codeliste As Integer, ByVal codetrans As Integer, Optional ByVal foodlaw As Integer = 0) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim result As String

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                cn.Open()
                                .Connection = cn
                                .CommandType = CommandType.Text
                                .CommandText = "SELECT dbo.[fn_GetAllergenText] (@CodeListe, @CodeTrans, 2, 2)"
                                .Parameters.Add("@CodeListe", SqlDbType.Int).Value = codeliste
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = codetrans

                                result = cmd.ExecuteScalar

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Catch ex As Exception
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("/api/menuplan/report/banner/{type?}/{iddetails?}/{coderestaurant?}/{codetrans?}/{codesetprice?}/{culture?}/{day?}/{codeUser}")>
        Public Function GetMenuplanBannerReport(ByVal type As Integer, ByVal iddetails As String, ByVal coderestaurant As Integer,
                                                ByVal codetrans As Integer, ByVal codesetprice As Integer, ByVal culture As String, ByVal day As Integer, ByVal codeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.Coop
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                Dim picturePath As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(codeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")
                picturePath = System.Configuration.ConfigurationManager.AppSettings("images")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[MP_GETPRINT_COOP]"
                                .Parameters.Add("@nvcIDDetails", SqlDbType.NVarChar, 4000).Value = iddetails
                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@intCodeSetPrice", SqlDbType.Int).Value = codesetprice
                                .Parameters.Add("@intReportType", SqlDbType.Int).Value = type
                                .Parameters.Add("@intIDmain", SqlDbType.VarChar).Value = -1
                                .Parameters.Add("@intCodeRestaurant", SqlDbType.Bit).Value = coderestaurant
                                .Parameters.Add("@intDay", SqlDbType.Int).Value = day
                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)

                                Dim dtAllergens As New DataTable

                                If type = 1 Then
                                    result = Report.GetReportOneTranslationBanner(ds, FolderPath, ReportURL, picturePath)
                                ElseIf type = 2 Then
                                    result = Report.GetReportMultipleTranslationBanner(ds, FolderPath, ReportURL, picturePath)
                                ElseIf type = 3 Then
                                    result = Report.GetOneTranslationBannerA5(ds, FolderPath, ReportURL, picturePath)
                                Else
                                    result = Report.GetMultipleTranslationBannerA5(ds, FolderPath, ReportURL, picturePath)
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
            End Try
            Return response
        End Function

        <HttpGet> <[GET]("/api/menuplan/coop/report/weekly/{idmain?}/{coderestaurant?}/{codetrans?}/{codesetprice?}/{baseurl?}/{culture?}/{days?}/{startDate}/{codeMenuPlan}/{codeUser}")> _
        Public Function GetCoopWeklyReport(ByVal idmain As Integer, ByVal coderestaurant As Integer, ByVal codetrans As Integer,
                                           ByVal codesetprice As Integer, ByVal baseurl As String, ByVal culture As String, ByVal days As Integer,
                                           ByVal startDate As DateTime, ByVal codeMenuplan As Integer, ByVal codeUser As Integer) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name)

                Dim Report As New EGSTelerikReport.Coop
                Dim FolderPath As String
                Dim ReportURL As String
                Dim ds As New DataSet
                Dim result As String
                ' Get the per-user connection string (decrypted via your helper)
                Dim userConnectionString As String = GetUserConnectionString(codeUser)

                FolderPath = System.Configuration.ConfigurationManager.AppSettings("ReportFolder")
                ReportURL = System.Configuration.ConfigurationManager.AppSettings("ReportURL")



                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(userConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[MP_GETPRINT_COOP_WEEKLY]"
                                .CommandTimeout = 3600
                                .Parameters.Add("@intCodeTrans", SqlDbType.Int).Value = codetrans
                                .Parameters.Add("@intCodeSetPrice", SqlDbType.Int).Value = codesetprice
                                .Parameters.Add("@intIDmain", SqlDbType.VarChar).Value = idmain
                                .Parameters.Add("@intCodeMenuplan", SqlDbType.Int).Value = codeMenuplan
                                .Parameters.Add("@startDate", SqlDbType.DateTime).Value = startDate
                                .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = codeUser
                                cn.Open()

                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)


                                Dim picturePath = System.Configuration.ConfigurationManager.AppSettings("menuplan").ToLower
                                If Not picturePath.EndsWith("\") Then picturePath += "\"



                                result = Report.GetReportMenuPlanWeekly(ds, FolderPath, ReportURL, picturePath)


                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = result
                                response.Status = True

                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try

                        End Using
                    End With
                End Using

            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                response.Code = 400
                response.Message = "Missing or invalid parameters"
                response.Parameters = New List(Of Models.param) From {New Models.param With {.name = "data", .value = "RecipeData"}}


            Catch hex As HttpResponseException

                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)


                Throw hex
            Catch ex As Exception

                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500


            End Try


            Return response
        End Function

        Public Sub LogText(logMessage As String)
            Dim location = System.AppDomain.CurrentDomain.BaseDirectory() & "temp\"
            Dim appPath = IO.Path.GetDirectoryName(location)

            Using w As IO.StreamWriter = IO.File.AppendText(location & "\ApiLogs.txt")
                w.Write(vbCrLf + "Log Entry : ")
                w.WriteLine("{0} {1}", DateTime.Now.ToLongTimeString(), _
                    DateTime.Now.ToLongDateString())
                w.WriteLine(":")
                w.WriteLine(":{0}", logMessage)
                w.WriteLine("-------------------------------")
            End Using
        End Sub
    End Class
End Namespace
