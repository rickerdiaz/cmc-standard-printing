Imports System
Imports System.Web
Imports System.Collections.Generic
Imports System.Linq
Imports AttributeRouting.Web.Http
Imports System.Data.SqlClient
Imports System.Web.Script.Serialization
Imports log4net
Imports System.Net
Imports Newtonsoft.Json
Imports Microsoft.AspNetCore.Mvc

Namespace CalcmenuAPI
    Public Class TimeController
        Inherits ControllerBase

        Private Shared ReadOnly Log As ILog = LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType)

        <HttpGet> <[GET]("/api/paulo/")> _
        Public Function GetPaulo() As List(Of Models.Time)
            Dim data As New Models.Time
            With data
                .Name = "ERIKA ARANAS"
                .Code = 123
                .Global = True
            End With
            Dim data2 As New Models.Time
            With data2
                .Name = "LEIKA ARANAS"
                .Code = 124
                .Global = False
            End With
            Dim listData As New List(Of Models.Time)
            listData.Add(data)
            listData.Add(data2)
            Return listData

        End Function

        <HttpGet> <[GET]("/api/times/{codesite:int}/{codetrans:int}/{name?}")> _
        Public Function GetTimes(codesite As Integer, codetrans As Integer, Optional name As String = "") As List(Of Models.Time)
            Dim data As New Models.Time
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "sp_GetTimebySite"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Add("@CodeSite", SqlDbType.Int, 4).Value = codesite
                                .Parameters.Add("@CodeTrans", SqlDbType.Int, 4).Value = codetrans
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim times As New List(Of Models.Time)
                For Each r In ds.Tables(0).Rows
                    times.Add(New Models.Time With {
                                .Name = GetStr(r("Name")), _
                                .Global = GetBool(r("IsGlobal")), _
                                .Code = GetInt(r("Code"))
                              })
                Next

                If name.Trim <> "" Then

                    Dim timeresult As New List(Of Models.Time)

                    Dim arrNames() As String = name.Trim.Split(",")
                    For Each word In arrNames
                        If word.Trim.ToString <> "" Then    'RDTC 2015.08.10; added this otherwise the rows are getting duplicated
                            For Each s In times
                                If s.Name.ToLower.Contains(Common.ReplaceSpecialCharacters(word.Trim.ToLower)) Then
                                    timeresult.Add(s)
                                End If
                            Next
                        End If
                    Next
                    times = timeresult

                End If

                Return times
            Finally
            End Try

        End Function

        'START - Raqi Pinili 08.26.2015
        <HttpPost> <[POST]("/api/times/search")> _
        Public Function GetTimes2(data2 As Models.ConfigurationcSearch) As List(Of Models.Time)
            Dim data As New Models.Time
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "sp_GetTimebySite"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Add("@CodeSite", SqlDbType.Int, 4).Value = data2.CodeSite
                                .Parameters.Add("@CodeTrans", SqlDbType.Int, 4).Value = data2.CodeTrans
                                .Parameters.Add("@CodeProperty", SqlDbType.Int, 4).Value = data2.CodeProperty 'JSS CWA-20088 112515
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim times As New List(Of Models.Time)
                For Each r In ds.Tables(0).Rows
                    times.Add(New Models.Time With {
                                .Name = GetStr(r("Name")), _
                                .Global = GetBool(r("IsGlobal")), _
                                .Code = GetInt(r("Code")), _
                                .isTotal = GetBool(r("isTotal")), _
                                .RequiredTotal = GetBool(r("RequiredTotal"))
                              })
                Next

                If data2.Name.Trim <> "" Then

                    Dim timeresult As New List(Of Models.Time)

                    Dim arrNames() As String = data2.Name.Trim.Split(",")
                    For Each word In arrNames
                        If word.Trim.ToString <> "" Then    'RDTC 2015.08.10; added this otherwise the rows are getting duplicated
                            For Each s In times
                                If s.Name.ToLower.Contains(Common.ReplaceSpecialCharacters(word.Trim.ToLower)) Then
                                    timeresult.Add(s)
                                End If
                            Next
                        End If
                    Next
                    times = timeresult

                End If

                Return times
            Finally
            End Try

        End Function
        'END - Raqi Pinili 08.26.2015

        <HttpGet> <[GET]("/api/time/{codetime:int}")> _
        Public Function GetTime(codetime As Integer) As Models.TimeData
            Dim data As New Models.Time
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_GetTime"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Add("@codeTime", SqlDbType.Int, 4).Value = codetime
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim times As New Models.TimeData

                times.Sites = New List(Of Models.GenericTree)
                For Each r In ds.Tables(0).Rows
                    If (GetBool(r("IsSiteUsed"))) Then
                        times.Sites.Add(New Models.GenericTree With {
                                            .Name = GetStr(r("SiteName")), _
                                            .ParentCode = GetInt(r("CodeProperty")), _
                                            .Code = GetInt(r("CodeSite"))
                                        })
                    End If
                Next
                times.Translation = New List(Of Models.GenericTranslation)
                For Each r In ds.Tables(1).Rows
                    times.Translation.Add(New Models.GenericTranslation With {
                                            .Code = GetInt(r("CodeTrans")), _
                                            .Name = GetStr(r("Name"))
                                           })
                Next
                times.Info = New Models.Time
                For Each r In ds.Tables(2).Rows
                    times.Info.Name = GetStr(r("Name"))
                    times.Info.Global = GetBool(r("IsGlobal"))
                Next



                Return times
            Finally
            End Try
        End Function

        <HttpGet> <[GET]("/api/times/sharing/{codesite:int}/{type:int}/{tree:int}/{codetime:int}")> _
        Public Function GetTimeSharing(codesite As Integer, _
                                  type As Integer, _
                                  tree As Integer, _
                                  codetime As Integer) As List(Of Models.TreeNode)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_SharingAll]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@Code", SqlDbType.Int).Value = codetime
                                .Parameters.Add("@CodeEgswTable", SqlDbType.Int).Value = 153
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim sharings As New List(Of Models.GenericTree)
                For Each r In ds.Tables(0).Rows
                    sharings.Add(New Models.GenericTree With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name")), _
                                    .ParentCode = GetInt(r("ParentCode")), _
                                    .ParentName = GetStr(r("ParentName")), _
                                    .Flagged = GetBool(r("Flagged")), _
                                    .Type = GetInt(r("Type")), _
                                    .Global = GetBool(r("Global"))})
                Next

                Dim sharingdata As New List(Of Models.TreeNode)

                Dim parents = sharings.Where(Function(obj) obj.ParentCode = 0 And obj.Type = 1).OrderBy(Function(obj) obj.Name).ToList()

                For Each p In parents
                    If sharingdata.Where(Function(obj) obj.key = p.Code).Count = 0 Then
                        Dim parent As New Models.TreeNode
                        parent.title = p.Name
                        parent.key = p.Code
                        parent.icon = False
                        parent.children = CreateChildren(sharings, p.Code)
                        parent.select = p.Flagged
                        parent.parenttitle = p.ParentName
                        sharingdata.Add(parent)
                    End If
                Next

                Return sharingdata
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        Private Function CreateChildren(_sharingdata As List(Of Models.GenericTree),
                                   _code As Integer) As List(Of Models.TreeNode)

            Dim children As New List(Of Models.TreeNode)
            If _sharingdata IsNot Nothing Then
                Dim kids = _sharingdata.Where(Function(obj) obj.ParentCode = _code And obj.Type = 2).OrderBy(Function(obj) obj.Name).ToList()

                For Each k In kids
                    Dim child As New Models.TreeNode
                    child.title = k.Name
                    child.key = k.Code
                    child.icon = False
                    child.children = Nothing
                    children.Add(child)
                    child.select = k.Flagged
                    child.parenttitle = k.ParentName
                    child.note = k.Global
                Next
            End If
            Return children

        End Function

        <HttpGet> <[GET]("/api/time/translation/{codetime:int}/{codesite:int}")> _
        Public Function GetTimeTranslation(codetime As Integer, _
                                           codesite As Integer) As List(Of Models.RecipeTranslation)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_TimeTranslation]"
                                .Parameters.Add("@CodeTime", SqlDbType.Int).Value = codetime
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite

                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim translations As New List(Of Models.RecipeTranslation)
                For Each r In ds.Tables(0).Rows
                    translations.Add(New Models.RecipeTranslation With {
                                    .CodeTrans = GetInt(r("CodeTrans")), _
                                    .TranslationName = GetStr(r("TranslationName")), _
                                    .Name = GetStr(r("Name"))})
                Next

                Return translations.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpPost> <POST("api/time")> _
        Public Function SaveTime(data As Models.TimeData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer
            Dim _trans As SqlTransaction = Nothing
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Using cmd As New SqlCommand
                    Dim arrSharing As New ArrayList
                    For Each sh In data.Sharing
                        If arrSharing.IndexOf(sh.Code) = -1 Then arrSharing.Add(sh.Code)
                    Next
                    Dim _codeSiteList As String = Common.Join(arrSharing, "", "", ",")
                    Dim tran As Integer
                    If data.Info.Code = -1 Then
                        tran = 1
                    ElseIf data.Info.Code = -2 Then
                        tran = 1
                    Else
                        tran = 2
                    End If
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[sp_UpdateTime]"
                                .Parameters.Clear()
                                .Parameters.Add("@retval", SqlDbType.Int)
                                .Parameters.Add("@Code", SqlDbType.Int).Value = data.Info.Code
                                .Parameters.Add("@Name", SqlDbType.NVarChar, 100).Value = data.Info.Name
                                .Parameters.Add("@IsGlobal", SqlDbType.Bit).Value = data.Info.Global
                                .Parameters.Add("@Site", SqlDbType.NVarChar, 100).Value = _codeSiteList


                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = data.Info.CodeTrans
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.Profile.Code
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.Profile.CodeSite
                                .Parameters.Add("@IsTotal", SqlDbType.Bit).Value = data.Info.isTotal
                                .Parameters.Add("@ReqIsTotal", SqlDbType.Bit).Value = data.Info.RequiredTotal

                                .Parameters("@Code").Direction = ParameterDirection.InputOutput
                                .Parameters("@retval").Direction = ParameterDirection.ReturnValue
                                cn.Open()
                                _trans = cn.BeginTransaction ' RBAJ-2014.01.13
                                .Transaction = _trans
                                .ExecuteNonQuery()
                                Dim codetime As Integer = GetInt(.Parameters("@Code").Value, -1)
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Save time failed", resultCode))
                                End If

                                If codetime > 0 Then
                                    .CommandText = "sp_UpdateTimeTranslation"
                                    .CommandType = CommandType.StoredProcedure
                                    For Each t In data.Translation
                                        .Parameters.Clear()
                                        .Parameters.Add("@intTimeCode", SqlDbType.Int, 4).Value = codetime
                                        .Parameters.Add("@vchTimeTypeName", SqlDbType.NVarChar, 150).Value = t.Name
                                        .Parameters.Add("@intCodeTrans", SqlDbType.Int, 4).Value = t.CodeTrans
                                        .Parameters.Add("@intRetCode", SqlDbType.Int, 4).Value = 0
                                        .Parameters.Add("@intRetCode", SqlDbType.Int, 4).Direction = ParameterDirection.ReturnValue
                                        .ExecuteNonQuery()
                                        resultCode = CInt(.Parameters("@intRetCode").Value)
                                   
                                        If resultCode <> 0 Then
                                            Throw New DatabaseException(String.Format("[{0}] Save time failed", resultCode))
                                        End If
                                    Next
                                End If


                                If codetime <> -1 Then

                                    With cmd
                                        .Connection = cn
                                        .CommandText = "DELETE FROM EgswSharing WHERE Code=" & codetime & " AND CodeUserOwner=" & data.Profile.CodeSite & _
                                                       " AND CodeEgswTable=" & 153 & " AND Type=1"
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .ExecuteNonQuery()
                                    End With


                                    With cmd
                                        .Connection = cn
                                        .CommandText = "sp_EgswUpdateSharing"
                                        .CommandType = CommandType.StoredProcedure
                                        .Parameters.Clear()
                                        .Parameters.Add("@intCode", SqlDbType.Int)
                                        .Parameters.Add("@intCodeSite", SqlDbType.Int)
                                        .Parameters.Add("@intCodeSitesShared", SqlDbType.Int)
                                        .Parameters.Add("@intCodeEgswTable", SqlDbType.Int)
                                        .Parameters.Add("@isGlobal", SqlDbType.Bit)


                                        Dim arrCodeSites() As String
                                        If Not _codeSiteList = "-1" Then
                                            _codeSiteList = _codeSiteList.Replace("(", "")
                                            _codeSiteList = _codeSiteList.Replace(")", "")
                                            arrCodeSites = _codeSiteList.Split(CChar(","))

                                            For i As Integer = 0 To UBound(arrCodeSites)
                                                If IsNumeric(arrCodeSites(i)) Then
                                                    .Parameters("@intCode").Value = GetInt(codetime)
                                                    .Parameters("@intCodeSite").Value = data.Profile.CodeSite
                                                    .Parameters("@intCodeSitesShared").Value = arrCodeSites(i)
                                                    .Parameters("@intCodeEgswTable").Value = 153
                                                    .Parameters("@isGlobal").Value = data.Info.Global
                                                    .ExecuteNonQuery()
                                                End If
                                            Next
                                        Else
                                            .Parameters("@intCode").Value = GetInt(codetime)
                                            .Parameters("@intCodeSite").Value = data.Profile.CodeSite
                                            .Parameters("@intCodeSitesShared").Value = CInt(_codeSiteList)
                                            .Parameters("@intCodeEgswTable").Value = 153
                                            .Parameters("@isGlobal").Value = data.Info.Global
                                            .ExecuteNonQuery()
                                        End If
                                    End With


                                End If


                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = codetime
                                response.Status = True
                                _trans.Commit()
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                Try
                                    _trans.Rollback()
                                    If Not _trans Is Nothing Then
                                        CType(_trans, IDisposable).Dispose()
                                    End If
                                Catch
                                End Try
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Save time failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Time")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Time")
            End Try
            Return response
        End Function

        <HttpPost> <POST("api/time/delete")>
        Public Function DeleteTime(data As Models.GenericDeleteData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Using cmd As New SqlCommand
                    Dim arrCategoryCodes As New ArrayList
                    For Each c In data.CodeList
                        If arrCategoryCodes.IndexOf(c.Code) = -1 Then arrCategoryCodes.Add(c.Code)
                    Next
                    Dim _codetimeList As String = Common.Join(arrCategoryCodes, "", "", ",")
                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_DELETE_Generic"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = _codetimeList
                                .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "TIMETYPE"
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.CodeUser
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite
                                .Parameters.Add("@ForceDelete", SqlDbType.Bit).Value = data.ForceDelete
                                .Parameters.Add("@SkipList", SqlDbType.VarChar, 4000).Direction = ParameterDirection.Output
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Delete time failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value) ''JDO 1.21.2014
                                response.Status = False
                                response.Message = "Delete time failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Time")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Time")
            End Try
            Return response
        End Function

        'JOP
        <HttpGet> <[GET]("/api/time/getRequiredTotal")> _
        Public Function GetTimes() As List(Of Models.Time)
            Dim data As New Models.Time
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "SELECT RequiredTotal from TimeType"
                                .CommandType = CommandType.Text
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim times As New List(Of Models.Time)
                For Each r In ds.Tables(0).Rows
                    times.Add(New Models.Time With {
                                .RequiredTotal = GetBool(r("RequiredTotal"))
                              })
                Next

                Return times
            Finally
            End Try
        End Function
    End Class
End Namespace