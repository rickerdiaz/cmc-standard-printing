Imports System
Imports System.Web
Imports System.Collections.Generic
Imports System.Linq
Imports AttributeRouting.Web.Http
Imports System.Data.SqlClient
Imports System.Web.Script.Serialization
Imports log4net
Imports System.Net
Imports Newtonsoft.Json
Imports System.Text
Imports Microsoft.AspNetCore.Mvc

Namespace CalcmenuAPI
    Public Class SourceController
        Inherits ControllerBase

        Private Shared ReadOnly Log As ILog = LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType)

        <HttpGet> <[GET]("/api/source/{codesite:int}")> _
        Public Function GetSource(codesite As Integer) As List(Of Models.GenericCodeValueList)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_Generic]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@Type", SqlDbType.Int).Value = 1
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = 0
                                .Parameters.Add("@TableName", SqlDbType.NVarChar, 200).Value = "EGSWSOURCE"
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim sources As New List(Of Models.GenericCodeValueList)
                For Each r In ds.Tables(0).Rows
                    sources.Add(New Models.GenericCodeValueList With {
                                    .Code = GetInt(r("Code")), _
                                    .Value = GetStr(r("Name"))})
                Next
                Return sources.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function


        <HttpPost> <[POST]("/api/source/search")> _
        Public Function GetSourceByName2(data As Models.ConfigurationcSearch) As List(Of Models.Source)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_MANAGE_Generic]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite
                                .Parameters.Add("@Type", SqlDbType.Int).Value = 1
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = data.CodeTrans
                                .Parameters.Add("@Status", SqlDbType.Int).Value = 1
                                .Parameters.Add("@TableName", SqlDbType.NVarChar, 200).Value = "EGSWSOURCE"
                                .Parameters.Add("@CodeProperty", SqlDbType.Int).Value = data.CodeProperty
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim sources As New List(Of Models.Source)
                For Each r In ds.Tables(0).Rows
                    sources.Add(New Models.Source With {
                                    .Code = GetInt(r("Code")), _
                                   .Name = GetStr(r("Name")), _
                                    .Global = GetBool(r("Global"))})
                Next

                If data.Name.Trim <> "" Then

                    Dim sourceresult As New List(Of Models.Source)

                    Dim arrNames() As String = data.Name.Trim.Split(",")
                    For Each word In arrNames
                        If word.Trim.ToString <> "" Then    'RDTC 2015.08.10; added this otherwise the rows are getting duplicated

                            For Each s In sources
                                If s.Name.ToLower.Contains(Common.ReplaceSpecialCharacters(word.Trim.ToLower)) Then
                                    sourceresult.Add(s)
                                End If
                            Next
                        End If
                    Next
                    sources = sourceresult

                End If

                Return sources.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/source/{codesite:int}/{type:int}/{codeproperty?}/{name?}")> _
        Public Function GetSourceByName(codesite As Integer, _
                            type As Integer, _
                            Optional codeproperty As Integer = -1,
                            Optional name As String = "") As List(Of Models.Source)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_MANAGE_Generic]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@Type", SqlDbType.Int).Value = 1
                                .Parameters.Add("@CodeTrans", SqlDbType.Int).Value = 0
                                .Parameters.Add("@Status", SqlDbType.Int).Value = 1
                                .Parameters.Add("@TableName", SqlDbType.NVarChar, 200).Value = "EGSWSOURCE"
                                .Parameters.Add("@CodeProperty", SqlDbType.Int).Value = codeproperty
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim sources As New List(Of Models.Source)
                For Each r In ds.Tables(0).Rows
                    sources.Add(New Models.Source With {
                                    .Code = GetInt(r("Code")), _
                                   .Name = GetStr(r("Name")), _
                                    .Global = GetBool(r("Global"))})
                Next

                If name.Trim <> "" Then

                    Dim sourceresult As New List(Of Models.Source)

                    Dim arrNames() As String = name.Trim.Split(",")
                    For Each word In arrNames
                        If word.Trim.ToString <> "" Then    'RDTC 2015.08.10; added this otherwise the rows are getting duplicated

                            For Each s In sources
                                If s.Name.ToLower.Contains(Common.ReplaceSpecialCharacters(word.Trim.ToLower)) Then
                                    sourceresult.Add(s)
                                End If
                            Next
                        End If
                    Next
                    sources = sourceresult

                End If

                Return sources.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/getsource/{codesite:int}/{codesource?}")> _
        Public Function GetSourceList(codesite As Integer, _
                                           Optional codesource As Integer = -1
                                           ) As List(Of Models.Source)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_SOURCECODENAME]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@ActiveOnly", SqlDbType.Bit).Value = True
                                .Parameters.Add("@CodeSource", SqlDbType.Int).Value = codesource
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using
                Dim sources As New List(Of Models.Source)
                For Each r In ds.Tables(0).Rows
                    sources.Add(New Models.Source With {
                                    .Code = GetInt(r("Code")), _
                                   .Name = GetStr(r("Name")), _
                                    .Global = GetBool(r("Global"))})
                Next

                Return sources.ToList
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        <HttpGet> <[GET]("/api/source/sharing/{codesite:int}/{type:int}/{tree:int}/{codesource:int}")> _
        Public Function GetSourceSharing(codesite As Integer, _
                                  type As Integer, _
                                  tree As Integer, _
                                  codesource As Integer) As List(Of Models.TreeNode)
            Try
                Dim ds As New DataSet
                Using cmd As New SqlCommand
                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[dbo].[API_GET_SharingAll]"
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codesite
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@Code", SqlDbType.Int).Value = codesource
                                .Parameters.Add("@CodeEgswTable", SqlDbType.Int).Value = 117
                                cn.Open()
                                Dim _da As New SqlDataAdapter(cmd)
                                _da.Fill(ds)
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With
                End Using

                Dim sharings As New List(Of Models.GenericTree)
                For Each r In ds.Tables(0).Rows
                    sharings.Add(New Models.GenericTree With {
                                    .Code = GetInt(r("Code")), _
                                    .Name = GetStr(r("Name")), _
                                    .ParentCode = GetInt(r("ParentCode")), _
                                    .ParentName = GetStr(r("ParentName")), _
                                    .Flagged = GetBool(r("Flagged")), _
                                    .Type = GetInt(r("Type")), _
                                    .Global = GetBool(r("Global"))})
                Next

                Dim sharingdata As New List(Of Models.TreeNode)

                Dim parents = sharings.Where(Function(obj) obj.ParentCode = 0 And obj.Type = 1).OrderBy(Function(obj) obj.Name).ToList()

                For Each p In parents
                    If sharingdata.Where(Function(obj) obj.key = p.Code).Count = 0 Then
                        Dim parent As New Models.TreeNode
                        parent.title = p.Name
                        parent.key = p.Code
                        parent.icon = False
                        parent.children = CreateChildrenSharing(sharings, p.Code)
                        parent.select = p.Flagged
                        parent.selected = p.Flagged
                        parent.parenttitle = p.ParentName
                        parent.groupLevel = GroupLevel.Property     'MKAM 2014.11.11
                        If parent.children.Count > 0 Then sharingdata.Add(parent)
                    End If
                Next

                Return sharingdata
            Catch aex As ArgumentException
                Log.Warn(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Missing or invalid parameters", aex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.BadRequest, 440))
            Catch hex As HttpResponseException
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", hex)
                Throw hex
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                Throw New HttpResponseException(GenericErrorResponse("Request failed", HttpStatusCode.InternalServerError, 500))
            End Try
        End Function

        'Private Function CreateChildren(_sharingdata As List(Of Models.GenericTree),
        '								_code As Integer) As List(Of Models.TreeNode)

        '	Dim children As New List(Of Models.TreeNode)
        '	If _sharingdata IsNot Nothing Then
        '              Dim kids = _sharingdata.Where(Function(obj) obj.ParentCode = _code And obj.Type = 2).OrderBy(Function(obj) obj.Name).ToList() ' RBAJ-2014.04.23 Fixed infinite loop "obj.Code <> _code"

        '		For Each k In kids
        '			Dim child As New Models.TreeNode
        '			child.title = k.Name
        '			child.key = k.Code
        '			child.icon = False
        '                  child.children = Nothing
        '			children.Add(child)
        '			child.select = k.Flagged
        '			child.parenttitle = k.ParentName
        '			child.note = k.Global
        '		Next
        '	End If
        '	Return children

        'End Function

        <HttpPost> <POST("api/source")> _
        Public Function SaveSource(data As Models.SourceData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer
            Dim _trans As SqlTransaction = Nothing
            Dim strCodesToMerge As String = ""

            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))


                If data.MergeList.Count > 0 Then
                    'RDTC 2015.08.07
                    'the codes of the keywords being merged must be passed as parameter; 
                    'otherwise the system will complain if the new merged name is the same as one of the items being merged
                    For Each s As Integer In data.MergeList
                        If strCodesToMerge = "" Then
                            strCodesToMerge = s.ToString
                        Else
                            strCodesToMerge = strCodesToMerge & "," & s.ToString
                        End If
                    Next
                End If

                Using cmd As New SqlCommand
                    Dim arrSharing As New ArrayList
                    For Each sh In data.Sharing
                        If arrSharing.IndexOf(sh.Code) = -1 Then arrSharing.Add(sh.Code)
                    Next
                    Dim _codeSiteList As String = Common.Join(arrSharing, "(", ")", ",")
                    Dim tran As Integer
                    If data.Info.Code = -1 Then
                        tran = 1
                    ElseIf data.Info.Code = -2 Then
                        tran = 1
                    Else
                        tran = 2
                    End If


                    With cmd
                        Using cn As New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandType = CommandType.StoredProcedure
                                .CommandText = "[sp_EgswSourceUpdate]"
                                .Parameters.Clear()
                                .Parameters.Add("@retval", SqlDbType.Int)
                                .Parameters.Add("@intCodeUser", SqlDbType.Int).Value = data.Profile.Code
                                .Parameters.Add("@intCodeSite", SqlDbType.Int).Value = data.Profile.CodeSite
                                .Parameters.Add("@intCode", SqlDbType.Int).Value = data.Info.Code
                                .Parameters.Add("@nvcName", SqlDbType.NVarChar, 50).Value = data.Info.Name
                                .Parameters.Add("@EGSID", SqlDbType.Int).Value = 0
                                .Parameters.Add("@IsGlobal", SqlDbType.Bit).Value = data.Info.Global
                                .Parameters.Add("@tntTranMode", SqlDbType.TinyInt).Value = tran
                                .Parameters.Add("@vchCodeSiteList", SqlDbType.NVarChar, 8000).Value = _codeSiteList
                                .Parameters.Add("@CodesToMerge", SqlDbType.NVarChar, 2000).Value = strCodesToMerge

                                .Parameters("@intCode").Direction = ParameterDirection.InputOutput
                                .Parameters("@retval").Direction = ParameterDirection.ReturnValue
                                cn.Open()
                                _trans = cn.BeginTransaction ' RBAJ-2014.01.13
                                .Transaction = _trans
                                .ExecuteNonQuery()
                                Dim codeSource As Integer = GetInt(.Parameters("@intCode").Value, -1)
                                resultCode = GetInt(.Parameters("@retval").Value, -1)
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Save source failed", resultCode))
                                End If

                                '' Merge, get all the sites where the items to be merged are shared.
                                If data.ActionType = 5 Then
                                    If data.MergeList.Count > 0 Then
                                        Dim arrSites As New ArrayList
                                        For Each s As Integer In data.MergeList
                                            If arrSites.IndexOf(s) = -1 Then arrSites.Add(s)
                                        Next
                                        Dim _SiteList As String = Common.Join(arrSites, "(", ")", ",")
                                        Dim sql As New StringBuilder
                                        sql.Append("INSERT INTO EgswSharing ")
                                        sql.Append("SELECT @Code,0,CodeUserSharedTo,1,117,0,1,0 ")
                                        sql.Append("FROM EgswSharing ")
                                        sql.Append("WHERE Code=@Code AND CodeEgswTable=117 AND [Status]=1 AND [Type] IN (1,5) ")
                                        sql.Append("    AND CodeUserSharedTo NOT IN (")
                                        sql.Append("    SELECT DISTINCT CodeUserSharedTo ")
                                        sql.Append("    FROM EgswSharing  ")
                                        sql.Append("    WHERE Code IN " & _SiteList & " AND CodeEgswTable=117 AND [Status]=1 AND [Type] IN (1,5)")
                                        sql.Append("    ) ")
                                        .CommandText = sql.ToString
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@Code", SqlDbType.Int).Value = codeSource
                                        .ExecuteNonQuery()



                                        ' CWM-13896 - JPJA 2014.04.24
                                        ' Added this so that recipes in categories to be merged are transferred to the newly created category
                                        Dim arrMergeList As New ArrayList
                                        For Each sh In data.MergeList
                                            If arrMergeList.IndexOf(sh) = -1 Then arrMergeList.Add(sh)
                                        Next
                                        Dim _mergeList As String = Common.Join(arrMergeList, "(", ")", ",")
                                        sql.Clear()
                                        sql.Append("UPDATE EgswListe ")
                                        sql.Append("SET Source=@newSoureeCode ")
                                        sql.Append(" WHERE Source IN " & _mergeList)
                                        .CommandText = sql.ToString
                                        .CommandType = CommandType.Text
                                        .Parameters.Clear()
                                        .Parameters.Add("@newSoureeCode", SqlDbType.Int).Value = codeSource
                                        Dim rowsAffected As Integer
                                        rowsAffected = cmd.ExecuteNonQuery()



                                        ' Delete merged items // RBAJ-2014.04.03
                                        ' Copy pasted here by @pauloadaoag 2014-04-08
                                        .CommandText = "API_DELETE_Generic"
                                        .CommandType = CommandType.StoredProcedure
                                        For Each code In arrSites
                                            .Parameters.Clear()
                                            .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = GetInt(code)
                                            .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWSOURCE"
                                            .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.Profile.Code
                                            .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.Profile.CodeSite
                                            .Parameters.Add("@ForceDelete", SqlDbType.Bit).Value = False
                                            .Parameters.Add("@SkipList", SqlDbType.NVarChar, 4000).Direction = ParameterDirection.Output
                                            .Parameters.Add("@Return", SqlDbType.Int)
                                            .Parameters("@Return").Direction = ParameterDirection.ReturnValue
                                            .ExecuteNonQuery()
                                            resultCode = GetInt(.Parameters("@Return").Value, -1) ' RBAJ-2014.01.14                               
                                            If resultCode <> 0 Then
                                                Throw New DatabaseException(String.Format("[{0}] Delete merged category failed", resultCode))
                                            End If
                                        Next
                                    End If
                                End If
                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = codeSource
                                response.Status = True
                                _trans.Commit()
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                Try
                                    _trans.Rollback()
                                    If Not _trans Is Nothing Then
                                        CType(_trans, IDisposable).Dispose()
                                    End If
                                Catch
                                End Try
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Save source failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Source")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Source")
            End Try
            Return response
        End Function

        <HttpPost> <POST("api/source/delete")>
        Public Function DeleteSource(data As Models.GenericDeleteData) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + JsonConvert.SerializeObject(data, Formatting.None, New JsonSerializerSettings() With {.NullValueHandling = NullValueHandling.Ignore}))

                Using cmd As New SqlCommand
                    Dim arrCategoryCodes As New ArrayList
                    For Each c In data.CodeList
                        If arrCategoryCodes.IndexOf(c.Code) = -1 Then arrCategoryCodes.Add(c.Code)
                    Next
                    Dim _codeCategoryList As String = Common.Join(arrCategoryCodes, "", "", ",")
                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_DELETE_Generic"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@CodeList", SqlDbType.VarChar, 4000).Value = _codeCategoryList
                                .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWSOURCE"
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = data.CodeUser                    ''codeuser
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = data.CodeSite                    ''codesite                                                        
                                .Parameters.Add("@ForceDelete", SqlDbType.Bit).Value = data.ForceDelete              ''force delete
                                .Parameters.Add("@SkipList", SqlDbType.VarChar, 4000).Direction = ParameterDirection.Output
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1) ' RBAJ-2014.01.14                               
                                If resultCode <> 0 Then
                                    Throw New DatabaseException(String.Format("[{0}] Delete source failed", resultCode))
                                End If

                                ' Done without errors
                                response.Code = 0
                                response.Message = "OK"
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value)
                                response.Status = True
                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                If resultCode = 0 Then
                                    resultCode = 500
                                End If
                                response.Code = resultCode
                                response.ReturnValue = GetStr(.Parameters("@SkipList").Value) ''JDO 1.21.2014
                                response.Status = False
                                response.Message = "Delete source failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Source")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Source")
            End Try
            Return response
        End Function

        <HttpPost> <POST("api/source/purge/{type:int}/{codeUser:int}/{codeSite:int}")> _
        Public Function PurgeSource(type As Integer, codeUser As Long, codeSite As Long) As Models.ResponseCallBack
            Dim response As New Models.ResponseCallBack
            Dim resultCode As Integer
            Try
                If DebugEnabled Then Log.Info("Calling " + System.Reflection.MethodBase.GetCurrentMethod().Name + ":" + "[" + type.ToString + "]")

                Using cmd As New SqlCommand
                    With cmd
                        Using cn = New SqlConnection(ConnectionString)
                            Try
                                .Connection = cn
                                .CommandText = "API_PURGE_Generic"
                                .CommandType = CommandType.StoredProcedure
                                .Parameters.Clear()
                                .Parameters.Add("@TableName", SqlDbType.VarChar, 200).Value = "EGSWSOURCE"
                                .Parameters.Add("@Type", SqlDbType.Int).Value = type
                                .Parameters.Add("@CodeUser", SqlDbType.Int).Value = codeUser '' Doesn't need this here, but it should be controlled in the UI/
                                .Parameters.Add("@CodeSite", SqlDbType.Int).Value = codeSite '' The roles and rights of the user should determine if the link button must be shown or not.
                                .Parameters.Add("@Return", SqlDbType.Int)
                                .Parameters("@Return").Direction = ParameterDirection.ReturnValue

                                cn.Open()
                                .ExecuteNonQuery()
                                resultCode = GetInt(.Parameters("@Return").Value, -1) ' RBAJ-2014.01.14   
                                If resultCode <> 0 Then
                                    If resultCode = -480 Then
                                        response.Code = -480
                                        response.Message = "Nothing was deleted"
                                        response.Status = False

                                    Else
                                        Throw New DatabaseException(String.Format("[{0}] Purge source failed", resultCode))
                                    End If
                                Else
                                    ' Done without errors
                                    response.Code = 0
                                    response.Message = "OK"
                                    response.Status = True
                                End If


                            Catch ex As DatabaseException
                                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Database error occured", ex)
                                response.Code = resultCode
                                response.Status = False
                                response.Message = "Purge source failed"
                                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Source")
                            Finally
                                If Not cn Is Nothing Then
                                    cn.Close()
                                    CType(cn, IDisposable).Dispose()
                                End If
                            End Try
                        End Using
                    End With

                End Using
            Catch ex As Exception
                Log.Error(System.Reflection.MethodBase.GetCurrentMethod().Name + ": Unexpected error occured", ex)
                response.Status = False
                response.Message = "Unexpected error occured"
                response.Code = 500
                Common.SendEmail(Request.RequestUri.AbsoluteUri.ToString(), ex.Message.ToString(), ex.StackTrace.ToString(), "Source")
            End Try
            Return response
        End Function
    End Class

End Namespace
